# =============================================================================
# Self-Hosted Devcontainer with VS Code Browser Access + Desktop
# =============================================================================
#
# NOTE: This is for SELF-HOSTED deployments only.
# Do NOT use inside GitHub Codespaces - it already provides VS Code access.
#
# Usage:
#   cd .devcontainer
#   docker compose -f docker-compose.server.yml up -d
#   Open http://localhost:8080 in browser (VS Code)
#   Open http://localhost:6080/vnc.html in browser (Desktop)
#
# With authentication:
#   CONNECTION_TOKEN=your-secret docker compose -f docker-compose.server.yml up -d
#
# Stop:
#   docker compose -f docker-compose.server.yml down

services:
  devcontainer:
    image: ghcr.io/rediacc/devcontainer:latest
    container_name: rediacc-devcontainer
    hostname: rediacc-devcontainer
    init: true
    shm_size: '1g'
    volumes:
      - ..:/workspace:cached
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "8080:8080" # VS Code browser access
      - "6080:6080" # Desktop (noVNC)
      - "3000:3000" # Console dev server
    environment:
      - HOME=/home/vscode
      - PORT=3000
      - DISPLAY=:99
    user: vscode
    working_dir: /workspace
    command: >
      bash -c "
        # Start desktop environment
        start-desktop.sh

        # Check for Codespaces environment
        if [ \"$${CODESPACES:-}\" = 'true' ]; then
          echo '========================================'
          echo 'ERROR: Running inside GitHub Codespaces'
          echo '========================================'
          echo ''
          echo 'This docker-compose file is for self-hosted deployments only.'
          echo 'In Codespaces, use the native VS Code access instead.'
          exit 1
        fi

        if [ -n \"$${CONNECTION_TOKEN:-}\" ]; then
          echo 'Starting OpenVSCode Server with token authentication...'
          exec openvscode-server --host 0.0.0.0 --port 8080 --connection-token \"$$CONNECTION_TOKEN\" /workspace
        else
          echo 'Starting OpenVSCode Server without authentication...'
          echo 'WARNING: Use CONNECTION_TOKEN env var for production!'
          exec openvscode-server --host 0.0.0.0 --port 8080 --without-connection-token /workspace
        fi
      "
    restart: unless-stopped

networks:
  default:
    name: rediacc-devcontainer
