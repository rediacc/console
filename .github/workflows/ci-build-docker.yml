name: Console CI - Build (Docker)

on:
  workflow_call:
    inputs:
      next_version:
        required: true
        type: string
      api_tag:
        required: true
        type: string
      api_exists:
        required: true
        type: string
      bridge_tag:
        required: true
        type: string
      bridge_exists:
        required: true
        type: string
      plugins_tag:
        required: true
        type: string
      plugins_exists:
        required: true
        type: string
      web_tag:
        required: true
        type: string
      web_exists:
        required: true
        type: string
      cli_tag:
        required: true
        type: string
      cli_exists:
        required: true
        type: string
    secrets:
      APP_PRIVATE_KEY:
        required: false

jobs:
  build-cli:
    name: CLI
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - name: Apply version bump
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: .ci/scripts/version/bump.sh --version ${{ inputs.next_version }}
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f  # v6
        with:
          node-version: '22'
          cache: 'npm'
      - run: .ci/scripts/setup/install-deps.sh
      - run: .ci/scripts/setup/build-packages.sh
      - run: .ci/scripts/build/build-cli.sh

      - name: Prepare CLI bundle artifact
        run: |
          mkdir -p bundle
          cp packages/cli/dist/cli-bundle.cjs bundle/
          cp packages/cli/package.json bundle/

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6
        with:
          name: cli-bundle-${{ github.sha }}
          path: bundle/
          retention-days: 3

      - name: Create CLI npm package
        working-directory: packages/cli
        run: |
          mkdir -p /tmp/cli-npm
          npm pack --pack-destination /tmp/cli-npm
          cd /tmp/cli-npm
          CLI_PKG=$(ls rediacc-cli-*.tgz 2>/dev/null | head -1)
          [ -n "$CLI_PKG" ] && cp "$CLI_PKG" rediacc-cli-latest.tgz

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6
        with:
          name: cli-npm-${{ github.sha }}
          path: /tmp/cli-npm/
          retention-days: 3

  build-web:
    name: Web
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - name: Apply version bump
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: .ci/scripts/version/bump.sh --version ${{ inputs.next_version }}
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f  # v6
        with:
          node-version: '22'
          cache: 'npm'
      - run: .ci/scripts/setup/install-deps.sh
      - run: .ci/scripts/setup/build-packages.sh
      - run: .ci/scripts/build/build-web.sh --type RELEASE
        env:
          VITE_APP_VERSION: ${{ inputs.web_tag }}
          VITE_BASE_PATH: /console/
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6
        with:
          name: build-web-${{ github.sha }}
          path: packages/web/dist/
          retention-days: 3

  build-www:
    name: WWW
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - name: Apply version bump
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: .ci/scripts/version/bump.sh --version ${{ inputs.next_version }}
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f  # v6
        with:
          node-version: '22'
          cache: 'npm'
      - run: .ci/scripts/setup/install-deps.sh
      - run: .ci/scripts/build/build-www.sh
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6
        with:
          name: build-www-${{ github.sha }}
          path: packages/www/dist/
          retention-days: 3

  build-json:
    name: JSON
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - name: Apply version bump
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: .ci/scripts/version/bump.sh --version ${{ inputs.next_version }}
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f  # v6
        with:
          node-version: '22'
          cache: 'npm'
      - run: .ci/scripts/setup/install-deps.sh
      - run: .ci/scripts/build/build-json.sh
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6
        with:
          name: build-json-${{ github.sha }}
          path: packages/json/dist/
          retention-days: 3

  build-plugins:
    name: Plugins & Docker
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - name: Apply version bump
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: .ci/scripts/version/bump.sh --version ${{ inputs.next_version }}

      - uses: docker/setup-buildx-action@v3

      # Build validation (dry-run)
      - name: Validate plugin images
        run: .ci/scripts/build/build-plugins.sh --dry-run

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Determine version
        id: version
        run: |
          echo "version=${{ inputs.next_version }}" >> $GITHUB_OUTPUT

      - name: Build & Push Plugin Docker images
        if: inputs.plugins_exists != 'true'
        run: |
          .ci/scripts/docker/build-image.sh --image plugin-terminal --ci-tag ${{ inputs.plugins_tag }} --version ${{ steps.version.outputs.version }} --push
          .ci/scripts/docker/build-image.sh --image plugin-browser --ci-tag ${{ inputs.plugins_tag }} --version ${{ steps.version.outputs.version }} --push

      - name: Skip Docker build (cached)
        if: inputs.plugins_exists == 'true'
        run: echo "::notice::Skipping Docker build - plugins:${{ inputs.plugins_tag }} already exists in registry"

  build-web-docker:
    name: Web Docker
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [build-web, build-www, build-cli]
    if: inputs.web_exists != 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - uses: ./.github/actions/app-token
        id: app-token
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          repositories: console,middleware,renet,license-server
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          submodules: true
          token: ${{ steps.app-token.outputs.token }}

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131  # v7
        with:
          name: build-web-${{ github.sha }}
          path: web-assets/

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131  # v7
        with:
          name: build-www-${{ github.sha }}
          path: www-assets/

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131  # v7
        with:
          name: cli-npm-${{ github.sha }}
          path: cli-npm/

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Build & push Web image (amd64)
        run: |
          docker buildx build \
            --file Dockerfile.native \
            --platform linux/amd64 \
            --build-arg VITE_APP_VERSION=${{ inputs.web_tag }} \
            --build-arg REDIACC_BUILD_TYPE=RELEASE \
            --tag ghcr.io/rediacc/elite/web:${{ inputs.web_tag }}-amd64 \
            --push \
            .

      - name: Build & push Web image (arm64)
        run: |
          docker buildx build \
            --file Dockerfile.native \
            --platform linux/arm64 \
            --build-arg VITE_APP_VERSION=${{ inputs.web_tag }} \
            --build-arg REDIACC_BUILD_TYPE=RELEASE \
            --tag ghcr.io/rediacc/elite/web:${{ inputs.web_tag }}-arm64 \
            --push \
            .

      - name: Create multi-arch manifest
        run: |
          .ci/scripts/docker/create-manifest.sh \
            --image web \
            --tag "${{ inputs.web_tag }}"

  build-web-docker-skip:
    name: Web Docker (cached)
    runs-on: ubuntu-latest
    if: inputs.web_exists == 'true'
    steps:
      - run: echo "::notice::Skipping Docker build - web:${{ inputs.web_tag }} already exists in registry"

  # CLI Docker: Build images from pre-built bundle on a single runner
  # CLI bundle is JavaScript (platform-independent), so no per-arch compilation needed
  build-cli-docker:
    name: CLI Docker
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build-cli]
    if: inputs.cli_exists != 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131  # v7
        with:
          name: cli-bundle-${{ github.sha }}
          path: bundle/

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Build & push CLI image (amd64)
        run: |
          docker buildx build \
            --file packages/cli/Dockerfile.native \
            --platform linux/amd64 \
            --tag ghcr.io/rediacc/elite/cli:${{ inputs.cli_tag }}-amd64 \
            --push \
            .

      - name: Build & push CLI image (arm64)
        run: |
          docker buildx build \
            --file packages/cli/Dockerfile.native \
            --platform linux/arm64 \
            --tag ghcr.io/rediacc/elite/cli:${{ inputs.cli_tag }}-arm64 \
            --push \
            .

      - name: Create multi-arch manifest
        run: |
          .ci/scripts/docker/create-manifest.sh \
            --image cli \
            --tag "${{ inputs.cli_tag }}"

  build-cli-docker-skip:
    name: CLI Docker (cached)
    runs-on: ubuntu-latest
    if: inputs.cli_exists == 'true'
    steps:
      - run: echo "::notice::Skipping Docker build - cli:${{ inputs.cli_tag }} already exists in registry"

  # ============================================================
  # MIDDLEWARE/API: Native Architecture Builds
  # ============================================================

  # Middleware (amd64): Build, test, and Docker image
  # Tests run on amd64 only (SQL Server 2022 available)
  build-middleware-amd64:
    name: Middleware (amd64)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    services:
      mssql:
        image: mcr.microsoft.com/mssql/server:2022-CU21-ubuntu-22.04
        env:
          ACCEPT_EULA: Y
          SA_PASSWORD: TestPassword123!
          MSSQL_PID: Express
        ports:
          - 1433:1433
        options: >-
          --health-cmd "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P TestPassword123! -C -Q 'SELECT 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
          --health-start-period 60s
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - uses: ./.github/actions/app-token
        id: app-token
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          repositories: console,middleware,renet,license-server
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          submodules: true
          token: ${{ steps.app-token.outputs.token }}

      - name: Apply version bump
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: .ci/scripts/version/bump.sh --version ${{ inputs.next_version }}

      - uses: actions/setup-dotnet@baa11fbfe1d6520db94683bd5c7a3818018e4309  # v5
        with:
          dotnet-version: 9.0.x

      # Build
      - name: Run middleware build
        run: .ci/scripts/private/run-middleware.sh build

      # Test
      - name: Install sqlcmd
        run: sudo private/middleware/scripts/install-sqlcmd.sh

      - name: Run middleware tests
        run: .ci/scripts/private/run-middleware.sh test

      - name: Check API types freshness
        run: .ci/scripts/quality/check-api-types.sh
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_HEAD_REF: ${{ github.head_ref }}

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6
        if: always()
        with:
          name: build-middleware-coverage-amd64-${{ github.sha }}
          path: private/middleware/coverage/
          retention-days: 3
          if-no-files-found: ignore

      # Publish and obfuscate for Docker (only when image not cached)
      - name: Publish self-contained (linux-x64)
        if: inputs.api_exists != 'true'
        working-directory: private/middleware
        run: |
          dotnet publish middleware.csproj -c Release -o ./publish \
            --self-contained=true \
            --runtime linux-x64 \
            -p:PublishSingleFile=false \
            -p:PublishTrimmed=false \
            -p:UseAppHost=true \
            -p:IncludeNativeLibrariesForSelfExtract=true \
            -p:Version=${{ inputs.next_version }} \
            -p:REDIACC_BUILD_TYPE=RELEASE

      - name: Obfuscate assemblies (amd64)
        if: inputs.api_exists != 'true'
        working-directory: private/middleware
        run: |
          dotnet tool install --global Obfuscar.GlobalTool
          export PATH="$PATH:$HOME/.dotnet/tools"
          mkdir -p publish-final
          cd publish
          if obfuscar.console ../obfuscar.xml && [ -d "Obfuscated" ] && [ "$(ls -A Obfuscated)" ]; then
            cp -r Obfuscated/* ../publish-final/
            rm -f ../publish-final/Mapping.txt
            # Copy non-assembly files that obfuscar doesn't process
            for f in *.json *.so *.pdb middleware *.deps.json *.runtimeconfig.json; do
              [ -f "$f" ] && [ ! -f "../publish-final/$f" ] && cp "$f" ../publish-final/
            done
            # Copy remaining .dll files that Obfuscar didn't include (runtime assemblies
            # like System.Private.CoreLib.dll). Use -n to preserve obfuscated versions.
            find . -maxdepth 1 -name "*.dll" -exec cp -n {} ../publish-final/ \; 2>/dev/null || true
            find . -maxdepth 1 -type d -name "runtimes" -exec cp -r {} ../publish-final/ \; 2>/dev/null || true
            find . -maxdepth 1 -type d -regex '\./[a-z][a-z]-[A-Z][A-Z]' -exec cp -r {} ../publish-final/ \; 2>/dev/null || true
            [ -d "translations" ] && cp -r translations ../publish-final/
            [ -d "AppData" ] && cp -r AppData ../publish-final/
            find . -maxdepth 1 -name "*.so" -exec cp -n {} ../publish-final/ \; 2>/dev/null || true
          else
            echo "::warning::Obfuscation skipped or failed, using unobfuscated build"
            cp -r ./* ../publish-final/
          fi

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6
        if: inputs.api_exists != 'true'
        with:
          name: middleware-publish-amd64-${{ github.sha }}
          path: private/middleware/publish-final/
          retention-days: 3

  # Middleware (arm64): Build, publish, and obfuscate (no tests)
  # Azure SQL Edge on arm64 has TLS certificate issues - tests run on amd64 cover code behavior
  build-middleware-arm64:
    name: Middleware (arm64)
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - uses: ./.github/actions/app-token
        id: app-token
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          repositories: console,middleware,renet,license-server
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          submodules: true
          token: ${{ steps.app-token.outputs.token }}

      - name: Apply version bump
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: .ci/scripts/version/bump.sh --version ${{ inputs.next_version }}

      - uses: actions/setup-dotnet@baa11fbfe1d6520db94683bd5c7a3818018e4309  # v5
        with:
          dotnet-version: 9.0.x

      # Build only (no tests - SQL Server unavailable on arm64 runners)
      - name: Run middleware build
        run: .ci/scripts/private/run-middleware.sh build

      # Publish and obfuscate for Docker (only when image not cached)
      - name: Publish self-contained (linux-arm64)
        if: inputs.api_exists != 'true'
        working-directory: private/middleware
        run: |
          dotnet publish middleware.csproj -c Release -o ./publish \
            --self-contained=true \
            --runtime linux-arm64 \
            -p:PublishSingleFile=false \
            -p:PublishTrimmed=false \
            -p:UseAppHost=true \
            -p:IncludeNativeLibrariesForSelfExtract=true \
            -p:Version=${{ inputs.next_version }} \
            -p:REDIACC_BUILD_TYPE=RELEASE

      - name: Obfuscate assemblies (arm64)
        if: inputs.api_exists != 'true'
        working-directory: private/middleware
        run: |
          dotnet tool install --global Obfuscar.GlobalTool
          export PATH="$PATH:$HOME/.dotnet/tools"
          mkdir -p publish-final
          cd publish
          if obfuscar.console ../obfuscar.xml && [ -d "Obfuscated" ] && [ "$(ls -A Obfuscated)" ]; then
            cp -r Obfuscated/* ../publish-final/
            rm -f ../publish-final/Mapping.txt
            # Copy non-assembly files that obfuscar doesn't process
            for f in *.json *.so *.pdb middleware *.deps.json *.runtimeconfig.json; do
              [ -f "$f" ] && [ ! -f "../publish-final/$f" ] && cp "$f" ../publish-final/
            done
            # Copy remaining .dll files that Obfuscar didn't include (runtime assemblies
            # like System.Private.CoreLib.dll). Use -n to preserve obfuscated versions.
            find . -maxdepth 1 -name "*.dll" -exec cp -n {} ../publish-final/ \; 2>/dev/null || true
            find . -maxdepth 1 -type d -name "runtimes" -exec cp -r {} ../publish-final/ \; 2>/dev/null || true
            find . -maxdepth 1 -type d -regex '\./[a-z][a-z]-[A-Z][A-Z]' -exec cp -r {} ../publish-final/ \; 2>/dev/null || true
            [ -d "translations" ] && cp -r translations ../publish-final/
            [ -d "AppData" ] && cp -r AppData ../publish-final/
            find . -maxdepth 1 -name "*.so" -exec cp -n {} ../publish-final/ \; 2>/dev/null || true
          else
            echo "::warning::Obfuscation skipped or failed, using unobfuscated build"
            cp -r ./* ../publish-final/
          fi

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6
        if: inputs.api_exists != 'true'
        with:
          name: middleware-publish-arm64-${{ github.sha }}
          path: private/middleware/publish-final/
          retention-days: 3

  # API Docker: Build images from pre-built binaries on a single runner
  # Follows the same pattern as build-renet-docker (bridge)
  build-middleware-docker:
    name: API Docker
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build-middleware-amd64, build-middleware-arm64]
    if: inputs.api_exists != 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - uses: ./.github/actions/app-token
        id: app-token
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          repositories: console,middleware,renet,license-server
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          submodules: true
          token: ${{ steps.app-token.outputs.token }}

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131  # v7
        with:
          name: middleware-publish-amd64-${{ github.sha }}
          path: publish/amd64/

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131  # v7
        with:
          name: middleware-publish-arm64-${{ github.sha }}
          path: publish/arm64/

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Build & push API image (amd64)
        run: |
          docker buildx build \
            --file private/middleware/Dockerfile.native \
            --platform linux/amd64 \
            --build-arg TARGETARCH=amd64 \
            --build-arg VERSION=${{ inputs.next_version }} \
            --tag ghcr.io/rediacc/elite/api:${{ inputs.api_tag }}-amd64 \
            --push \
            .

      - name: Build & push API image (arm64)
        run: |
          docker buildx build \
            --file private/middleware/Dockerfile.native \
            --platform linux/arm64 \
            --build-arg TARGETARCH=arm64 \
            --build-arg VERSION=${{ inputs.next_version }} \
            --tag ghcr.io/rediacc/elite/api:${{ inputs.api_tag }}-arm64 \
            --push \
            .

      - name: Create multi-arch manifest
        run: |
          .ci/scripts/docker/create-manifest.sh \
            --image api \
            --tag "${{ inputs.api_tag }}"

  build-middleware-docker-skip:
    name: API Docker (cached)
    runs-on: ubuntu-latest
    if: inputs.api_exists == 'true'
    steps:
      - run: echo "::notice::Skipping Docker build - api:${{ inputs.api_tag }} already exists in registry"

  # ============================================================
  # RENET/BRIDGE: Docker Images
  # Note: Renet binaries (with embedded CRIU/rsync) are built by ci-build-renet.yml
  # This workflow downloads the unified artifact and builds Docker images only
  # ============================================================

  # Build Docker images from unified renet binaries
  build-renet-docker:
    name: Renet Docker
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: inputs.bridge_exists != 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - uses: ./.github/actions/app-token
        id: app-token
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          repositories: console,middleware,renet,license-server
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          submodules: true
          token: ${{ steps.app-token.outputs.token }}

      # Download full renet binaries (with embedded CRIU/rsync) from unified build
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131  # v7
        with:
          name: renet-binaries-${{ github.sha }}
          path: binaries/

      # Download native CRIU/rsync binaries (also from unified build)
      # These are copied to /opt/ in Docker image for remote machine distribution
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131  # v7
        with:
          name: native-amd64-${{ github.sha }}
          path: binaries/

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131  # v7
        with:
          name: native-arm64-${{ github.sha }}
          path: binaries/
          merge-multiple: true

      - name: List binaries
        run: ls -la binaries/

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Build & push amd64 bridge image
        run: |
          docker buildx build \
            --file private/renet/Dockerfile.native \
            --platform linux/amd64 \
            --build-arg TARGETARCH=amd64 \
            --tag ghcr.io/rediacc/elite/bridge:${{ inputs.bridge_tag }}-amd64 \
            --push \
            .

      - name: Build & push arm64 bridge image
        run: |
          docker buildx build \
            --file private/renet/Dockerfile.native \
            --platform linux/arm64 \
            --build-arg TARGETARCH=arm64 \
            --tag ghcr.io/rediacc/elite/bridge:${{ inputs.bridge_tag }}-arm64 \
            --push \
            .

      - name: Create multi-arch manifest
        run: |
          .ci/scripts/docker/create-manifest.sh \
            --image bridge \
            --tag "${{ inputs.bridge_tag }}"

  build-renet-skip:
    name: Renet (cached)
    runs-on: ubuntu-latest
    if: inputs.bridge_exists == 'true'
    steps:
      - run: echo "::notice::Skipping Docker build - bridge:${{ inputs.bridge_tag }} already exists in registry"
