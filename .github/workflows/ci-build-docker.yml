name: Console CI - Build (Docker)

on:
  workflow_call:
    inputs:
      next_version:
        required: true
        type: string
      api_tag:
        required: true
        type: string
      api_exists:
        required: true
        type: string
      bridge_tag:
        required: true
        type: string
      bridge_exists:
        required: true
        type: string
      plugins_tag:
        required: true
        type: string
      plugins_exists:
        required: true
        type: string
      web_tag:
        required: true
        type: string
      web_exists:
        required: true
        type: string
      cli_tag:
        required: true
        type: string
      cli_exists:
        required: true
        type: string
    secrets:
      GH_PAT:
        required: false

jobs:
  build-cli:
    name: CLI
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - name: Apply version bump
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: .ci/scripts/version/bump.sh --version ${{ inputs.next_version }}
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f  # v6
        with:
          node-version: '22'
          cache: 'npm'
      - run: .ci/scripts/setup/install-deps.sh
      - run: .ci/scripts/setup/build-packages.sh
      - run: .ci/scripts/build/build-cli.sh

  build-web:
    name: Web
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - name: Apply version bump
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: .ci/scripts/version/bump.sh --version ${{ inputs.next_version }}
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f  # v6
        with:
          node-version: '22'
          cache: 'npm'
      - run: .ci/scripts/setup/install-deps.sh
      - run: .ci/scripts/setup/build-packages.sh
      - run: .ci/scripts/build/build-web.sh --type RELEASE
        env:
          VITE_APP_VERSION: ${{ github.sha }}
          VITE_BASE_PATH: /
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6
        with:
          name: build-web-${{ github.sha }}
          path: packages/web/dist/
          retention-days: 3

  build-www:
    name: WWW
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - name: Apply version bump
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: .ci/scripts/version/bump.sh --version ${{ inputs.next_version }}
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f  # v6
        with:
          node-version: '22'
          cache: 'npm'
      - run: .ci/scripts/setup/install-deps.sh
      - run: .ci/scripts/build/build-www.sh
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6
        with:
          name: build-www-${{ github.sha }}
          path: packages/www/dist/
          retention-days: 3

  build-json:
    name: JSON
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - name: Apply version bump
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: .ci/scripts/version/bump.sh --version ${{ inputs.next_version }}
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f  # v6
        with:
          node-version: '22'
          cache: 'npm'
      - run: .ci/scripts/setup/install-deps.sh
      - run: .ci/scripts/build/build-json.sh
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6
        with:
          name: build-json-${{ github.sha }}
          path: packages/json/dist/
          retention-days: 3

  build-plugins:
    name: Plugins & Docker
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - name: Apply version bump
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: .ci/scripts/version/bump.sh --version ${{ inputs.next_version }}

      - uses: docker/setup-buildx-action@v3

      # Build validation (dry-run)
      - name: Validate plugin images
        run: .ci/scripts/build/build-plugins.sh --dry-run

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GH_PAT }}

      - name: Determine version
        id: version
        run: |
          echo "version=${{ inputs.next_version }}" >> $GITHUB_OUTPUT

      - name: Build & Push Plugin Docker images
        if: inputs.plugins_exists != 'true'
        run: |
          .ci/scripts/docker/build-image.sh --image plugin-terminal --ci-tag ${{ inputs.plugins_tag }} --version ${{ steps.version.outputs.version }} --push
          .ci/scripts/docker/build-image.sh --image plugin-browser --ci-tag ${{ inputs.plugins_tag }} --version ${{ steps.version.outputs.version }} --push

      - name: Skip Docker build (cached)
        if: inputs.plugins_exists == 'true'
        run: echo "::notice::Skipping Docker build - plugins:${{ inputs.plugins_tag }} already exists in registry"

  build-web-docker:
    name: Web & Docker
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          submodules: true
          token: ${{ secrets.GH_PAT }}

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GH_PAT }}

      - name: Build & Push Web Docker image
        if: inputs.web_exists != 'true'
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83  # v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ghcr.io/rediacc/elite/web:${{ inputs.web_tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            REDIACC_BUILD_TYPE=RELEASE
            VITE_APP_VERSION=${{ inputs.web_tag }}

      - name: Skip Docker build (cached)
        if: inputs.web_exists == 'true'
        run: echo "::notice::Skipping Docker build - web:${{ inputs.web_tag }} already exists in registry"

  # CLI Docker: amd64
  build-cli-docker-amd64:
    name: CLI Docker (amd64)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GH_PAT }}

      - name: Build & Push CLI image (amd64)
        if: inputs.cli_exists != 'true'
        run: |
          .ci/scripts/docker/build-image.sh \
            --image cli \
            --ci-tag "${{ inputs.cli_tag }}-amd64" \
            --version "${{ inputs.next_version }}" \
            --platform "linux/amd64" \
            --push

      - name: Skip Docker build (cached)
        if: inputs.cli_exists == 'true'
        run: echo "::notice::Skipping Docker build - cli:${{ inputs.cli_tag }} already exists in registry"

  # CLI Docker: arm64
  build-cli-docker-arm64:
    name: CLI Docker (arm64)
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GH_PAT }}

      - name: Build & Push CLI image (arm64)
        if: inputs.cli_exists != 'true'
        run: |
          .ci/scripts/docker/build-image.sh \
            --image cli \
            --ci-tag "${{ inputs.cli_tag }}-arm64" \
            --version "${{ inputs.next_version }}" \
            --platform "linux/arm64" \
            --push

      - name: Skip Docker build (cached)
        if: inputs.cli_exists == 'true'
        run: echo "::notice::Skipping Docker build - cli:${{ inputs.cli_tag }} already exists in registry"

  # CLI Docker: Manifest
  build-cli-manifest:
    name: CLI Manifest
    runs-on: ubuntu-latest
    needs: [build-cli-docker-amd64, build-cli-docker-arm64]
    if: inputs.cli_exists != 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GH_PAT }}

      - name: Create multi-arch manifest
        run: |
          .ci/scripts/docker/create-manifest.sh \
            --image cli \
            --tag "${{ inputs.cli_tag }}"

  # ============================================================
  # MIDDLEWARE/API: Native Architecture Builds
  # ============================================================

  # Middleware (amd64): Build, test, and Docker image
  # Tests run on amd64 only (SQL Server 2022 available)
  build-middleware-amd64:
    name: Middleware (amd64)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    services:
      mssql:
        image: mcr.microsoft.com/mssql/server:2022-CU21-ubuntu-22.04
        env:
          ACCEPT_EULA: Y
          SA_PASSWORD: TestPassword123!
          MSSQL_PID: Express
        ports:
          - 1433:1433
        options: >-
          --health-cmd "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P TestPassword123! -C -Q 'SELECT 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
          --health-start-period 60s
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          submodules: true
          token: ${{ secrets.GH_PAT }}

      - name: Apply version bump
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: .ci/scripts/version/bump.sh --version ${{ inputs.next_version }}

      - uses: actions/setup-dotnet@baa11fbfe1d6520db94683bd5c7a3818018e4309  # v5
        with:
          dotnet-version: 9.0.x

      # Build
      - name: Run middleware build
        run: .ci/scripts/private/run-middleware.sh build

      # Test
      - name: Install sqlcmd
        run: sudo private/middleware/scripts/install-sqlcmd.sh

      - name: Run middleware tests
        run: .ci/scripts/private/run-middleware.sh test

      - name: Check API types freshness
        run: .ci/scripts/quality/check-api-types.sh
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_HEAD_REF: ${{ github.head_ref }}

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6
        if: always()
        with:
          name: build-middleware-coverage-amd64-${{ github.sha }}
          path: private/middleware/coverage/
          retention-days: 3
          if-no-files-found: ignore

      # Docker
      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GH_PAT }}

      - name: Build & Push API Docker image (amd64)
        if: inputs.api_exists != 'true'
        run: |
          .ci/scripts/docker/build-image.sh \
            --image api \
            --ci-tag "${{ inputs.api_tag }}-amd64" \
            --version "${{ inputs.next_version }}" \
            --platform "linux/amd64" \
            --push

      - name: Skip Docker build (cached)
        if: inputs.api_exists == 'true'
        run: echo "::notice::Skipping Docker build - api:${{ inputs.api_tag }} already exists in registry"

  # Middleware (arm64): Build and Docker image only (no tests)
  # Azure SQL Edge on arm64 has TLS certificate issues - tests run on amd64 cover code behavior
  build-middleware-arm64:
    name: Middleware (arm64)
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          submodules: true
          token: ${{ secrets.GH_PAT }}

      - name: Apply version bump
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: .ci/scripts/version/bump.sh --version ${{ inputs.next_version }}

      - uses: actions/setup-dotnet@baa11fbfe1d6520db94683bd5c7a3818018e4309  # v5
        with:
          dotnet-version: 9.0.x

      # Build only (no tests - SQL Server unavailable on arm64 runners)
      - name: Run middleware build
        run: .ci/scripts/private/run-middleware.sh build

      # Docker
      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GH_PAT }}

      - name: Build & Push API Docker image (arm64)
        if: inputs.api_exists != 'true'
        run: |
          .ci/scripts/docker/build-image.sh \
            --image api \
            --ci-tag "${{ inputs.api_tag }}-arm64" \
            --version "${{ inputs.next_version }}" \
            --platform "linux/arm64" \
            --push

      - name: Skip Docker build (cached)
        if: inputs.api_exists == 'true'
        run: echo "::notice::Skipping Docker build - api:${{ inputs.api_tag }} already exists in registry"

  build-middleware-manifest:
    name: Middleware Manifest
    runs-on: ubuntu-latest
    needs: [build-middleware-amd64, build-middleware-arm64]
    if: inputs.api_exists != 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GH_PAT }}

      - name: Create multi-arch manifest
        run: |
          .ci/scripts/docker/create-manifest.sh \
            --image api \
            --tag "${{ inputs.api_tag }}"

  # ============================================================
  # RENET/BRIDGE: Native Binary Builds (no QEMU emulation)
  # ============================================================

  # Build native binaries (CRIU, rsync) on separate runners to avoid QEMU
  # Note: renet Go binaries are built in build-renet-docker after all assets available
  build-renet-native-amd64:
    name: Renet Binaries (amd64)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: inputs.bridge_exists != 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          submodules: true
          token: ${{ secrets.GH_PAT }}

      - name: Restore native binary cache
        id: cache-binaries
        uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7  # v5
        with:
          path: binaries/
          key: native-binaries-amd64-${{ hashFiles('.ci/scripts/docker/build-native-binaries.sh') }}

      - name: Build native binaries (amd64 host)
        if: steps.cache-binaries.outputs.cache-hit != 'true'
        run: .ci/scripts/docker/build-native-binaries.sh --output ./binaries --cross-rsync

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6
        with:
          name: renet-binaries-amd64
          path: binaries/
          retention-days: 1

  build-renet-native-arm64:
    name: Renet Binaries (arm64)
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 45
    if: inputs.bridge_exists != 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          submodules: true
          token: ${{ secrets.GH_PAT }}

      - name: Restore native binary cache
        id: cache-binaries
        uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7  # v5
        with:
          path: binaries/
          key: native-binaries-arm64-${{ hashFiles('.ci/scripts/docker/build-native-binaries.sh') }}

      - name: Build CRIU arm64 natively
        if: steps.cache-binaries.outputs.cache-hit != 'true'
        run: .ci/scripts/docker/build-native-binaries.sh --output ./binaries --criu-only

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6
        with:
          name: renet-binaries-arm64
          path: binaries/
          retention-days: 1

  # Build renet Go binaries with embedded assets and Docker images
  build-renet-docker:
    name: Renet Docker
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: [build-renet-native-amd64, build-renet-native-arm64]
    if: inputs.bridge_exists != 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          submodules: true
          token: ${{ secrets.GH_PAT }}

      - name: Apply version bump
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: .ci/scripts/version/bump.sh --version ${{ inputs.next_version }}

      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5  # v6
        with:
          go-version: '1.24'
          cache: true
          cache-dependency-path: private/renet/go.sum

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131  # v7
        with:
          name: renet-binaries-amd64
          path: binaries/

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131  # v7
        with:
          name: renet-binaries-arm64
          path: binaries/
          merge-multiple: true

      - name: List binaries
        run: ls -la binaries/

      # Embed assets into Go binary by placing compressed binaries in pkg/embed/assets/
      - name: Prepare embedded assets for Go build
        run: |
          mkdir -p private/renet/pkg/embed/assets
          gzip -c binaries/criu-linux-amd64 > private/renet/pkg/embed/assets/criu-linux-amd64.gz
          gzip -c binaries/criu-linux-arm64 > private/renet/pkg/embed/assets/criu-linux-arm64.gz
          gzip -c binaries/rsync-linux-amd64 > private/renet/pkg/embed/assets/rsync-linux-amd64.gz
          gzip -c binaries/rsync-linux-arm64 > private/renet/pkg/embed/assets/rsync-linux-arm64.gz
          ls -la private/renet/pkg/embed/assets/

      - name: Build renet Go binaries with embedded assets
        run: |
          cd private/renet
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w -X main.Version=${{ inputs.next_version }}" -o ../../binaries/renet-linux-amd64 ./cmd/renet
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -ldflags="-s -w -X main.Version=${{ inputs.next_version }}" -o ../../binaries/renet-linux-arm64 ./cmd/renet

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GH_PAT }}

      - name: Build & push amd64 bridge image
        run: |
          docker buildx build \
            --file private/renet/Dockerfile.native \
            --platform linux/amd64 \
            --build-arg TARGETARCH=amd64 \
            --tag ghcr.io/rediacc/elite/bridge:${{ inputs.bridge_tag }}-amd64 \
            --push \
            .

      - name: Build & push arm64 bridge image
        run: |
          docker buildx build \
            --file private/renet/Dockerfile.native \
            --platform linux/arm64 \
            --build-arg TARGETARCH=arm64 \
            --tag ghcr.io/rediacc/elite/bridge:${{ inputs.bridge_tag }}-arm64 \
            --push \
            .

      - name: Create multi-arch manifest
        run: |
          .ci/scripts/docker/create-manifest.sh \
            --image bridge \
            --tag "${{ inputs.bridge_tag }}"

  build-renet-skip:
    name: Renet (cached)
    runs-on: ubuntu-latest
    if: inputs.bridge_exists == 'true'
    steps:
      - run: echo "::notice::Skipping Docker build - bridge:${{ inputs.bridge_tag }} already exists in registry"
