name: Console CI - Quality

on:
  workflow_call:
    inputs:
      is_bot:
        required: true
        type: string
      next_version:
        required: true
        type: string
    secrets:
      GH_PAT:
        required: false

jobs:
  quality-branch:
    name: Branch
    runs-on: ubuntu-slim
    if: inputs.is_bot != 'true' && github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GH_PAT }}
      - name: Check branch status and auto-rebase if needed
        run: .ci/scripts/quality/check-branch.sh
        env:
          GITHUB_BASE_REF: ${{ github.base_ref }}
          GITHUB_HEAD_REF: ${{ github.head_ref }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}

  quality-gemini-review:
    name: Gemini Review
    runs-on: ubuntu-slim
    if: inputs.is_bot != 'true' && github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          sparse-checkout: .ci/scripts
      - name: Trigger Gemini Code Assist review
        run: .ci/scripts/quality/trigger-gemini-review.sh
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_REPOSITORY: ${{ github.repository }}

  quality-versions:
    name: Versions
    runs-on: ubuntu-slim
    if: inputs.is_bot != 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - name: Block legacy-peer-deps workarounds
        run: .ci/scripts/quality/check-npmrc.sh
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f  # v6
        with:
          node-version: '22'
          cache: 'npm'
      - run: .ci/scripts/setup/install-deps.sh
      - name: Verify no peer dependency conflicts
        run: .ci/scripts/quality/check-peer-deps.sh
      - run: npm run version:check

  quality-deps:
    name: Deps
    runs-on: ubuntu-slim
    if: inputs.is_bot != 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref || github.ref }}
          token: ${{ secrets.GH_PAT }}
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f  # v6
        with:
          node-version: '22'
          cache: 'npm'
      - run: .ci/scripts/setup/install-deps.sh
      - run: .ci/scripts/quality/check-deps.sh
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_HEAD_REF: ${{ github.head_ref }}

  quality-lint:
    name: Lint
    runs-on: ubuntu-latest
    if: inputs.is_bot != 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - name: Apply version bump
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        shell: bash
        run: .ci/scripts/version/bump.sh --version ${{ inputs.next_version }}
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f  # v6
        with:
          node-version: '22'
          cache: 'npm'
      - run: .ci/scripts/setup/install-deps.sh
      - run: npm run lint -- --max-warnings 0
      - run: npm run lint:unused

  quality-format:
    name: Format
    runs-on: ubuntu-slim
    if: inputs.is_bot != 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - name: Apply version bump
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        shell: bash
        run: .ci/scripts/version/bump.sh --version ${{ inputs.next_version }}
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f  # v6
        with:
          node-version: '22'
          cache: 'npm'
      - run: .ci/scripts/setup/install-deps.sh
      - run: npm run check:format

  quality-i18n:
    name: i18n
    runs-on: ubuntu-slim
    if: inputs.is_bot != 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f  # v6
        with:
          node-version: '22'
          cache: 'npm'
      - run: .ci/scripts/setup/install-deps.sh
      - run: npm run check:i18n

  quality-types:
    name: TypeScript
    runs-on: ubuntu-slim
    if: inputs.is_bot != 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f  # v6
        with:
          node-version: '22'
          cache: 'npm'
      - run: .ci/scripts/setup/install-deps.sh
      - run: npm run typecheck

  quality-security:
    name: Security
    runs-on: ubuntu-slim
    if: inputs.is_bot != 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f  # v6
        with:
          node-version: '22'
          cache: 'npm'
      - run: .ci/scripts/setup/install-deps.sh
      - run: .ci/scripts/security/audit.sh
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6
        if: always()
        with:
          name: quality-security-${{ github.sha }}
          path: audit-report.json
          retention-days: 3

  quality-shell:
    name: Shell
    runs-on: ubuntu-slim
    if: inputs.is_bot != 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - run: .ci/scripts/security/shellcheck.sh
      - run: .ci/scripts/security/check-commands.sh
      - run: .ci/scripts/quality/check-workflows.sh

  quality-middleware:
    name: Middleware
    runs-on: ubuntu-latest
    if: inputs.is_bot != 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          submodules: true
          token: ${{ secrets.GH_PAT }}
      - name: Apply version bump
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: .ci/scripts/version/bump.sh --version ${{ inputs.next_version }}

      - uses: actions/setup-dotnet@baa11fbfe1d6520db94683bd5c7a3818018e4309  # v5
        with:
          dotnet-version: 9.0.x

      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f  # v6
        with:
          node-version: '22'

      - name: Run middleware quality
        run: .ci/scripts/private/run-middleware.sh quality

  quality-renet:
    name: Renet
    runs-on: ubuntu-latest
    if: inputs.is_bot != 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          submodules: true
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0
          ref: ${{ github.head_ref || github.ref }}

      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5  # v6
        with:
          go-version: '1.24'
          cache: true
          cache-dependency-path: private/renet/go.sum

      - name: Run renet quality
        run: .ci/scripts/private/run-renet.sh quality

      - name: Check renet types freshness
        run: .ci/scripts/quality/check-renet-types.sh
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_HEAD_REF: ${{ github.head_ref }}

  quality-review-comments:
    name: Review Comments
    runs-on: ubuntu-slim
    if: inputs.is_bot != 'true' && github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - name: Check for unreplied review comments
        run: .ci/scripts/quality/check-review-comments.sh
        env:
          GITHUB_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}

  quality-resolved-threads:
    name: Resolved Threads
    runs-on: ubuntu-slim
    if: inputs.is_bot != 'true' && github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          sparse-checkout: .ci/scripts
      - name: Check all review threads are resolved
        run: .ci/scripts/quality/check-resolved-threads.sh
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_REPOSITORY: ${{ github.repository }}

  quality-attribution:
    name: Attribution
    runs-on: ubuntu-slim
    if: inputs.is_bot != 'true' && github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - name: Check for Claude attribution
        run: .ci/scripts/quality/check-claude-attribution.sh
        env:
          GITHUB_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
