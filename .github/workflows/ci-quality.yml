name: Console CI - Quality

on:
  workflow_call:
    inputs:
      is_bot:
        required: true
        type: string
      next_version:
        required: true
        type: string
    secrets:
      APP_PRIVATE_KEY:
        required: false

jobs:
  quality-branch:
    name: Branch
    runs-on: ubuntu-slim
    if: inputs.is_bot != 'true' && github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - uses: ./.github/actions/app-token
        id: app-token
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          preset: ci
          repositories: console
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}
          token: ${{ steps.app-token.outputs.token }}
      - name: Check branch status and auto-rebase if needed
        run: .ci/scripts/quality/check-branch.sh
        env:
          GITHUB_BASE_REF: ${{ github.base_ref }}
          GITHUB_HEAD_REF: ${{ github.head_ref }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}

  # NOTE: Gemini Review is now triggered by review-gate job in ci.yml
  # after all quality jobs pass, to avoid triggering reviews on code
  # that has lint/type errors

  quality-versions:
    name: Versions
    runs-on: ubuntu-slim
    if: inputs.is_bot != 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - name: Block legacy-peer-deps workarounds
        run: .ci/scripts/quality/check-npmrc.sh
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f  # v6
        with:
          node-version: '22'
          cache: 'npm'
      - run: .ci/scripts/setup/install-deps.sh
      - name: Verify no peer dependency conflicts
        run: .ci/scripts/quality/check-peer-deps.sh
      - run: npm run version:check

  quality-deps:
    name: Deps
    runs-on: ubuntu-slim
    if: inputs.is_bot != 'true' && github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - uses: ./.github/actions/app-token
        id: app-token
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          preset: ci
          repositories: console
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref || github.ref }}
          token: ${{ steps.app-token.outputs.token }}
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f  # v6
        with:
          node-version: '22'
          cache: 'npm'
      - run: .ci/scripts/setup/install-deps.sh
      - run: .ci/scripts/quality/check-deps.sh
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_HEAD_REF: ${{ github.head_ref }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}

  quality-lint:
    name: Lint
    runs-on: ubuntu-latest
    if: inputs.is_bot != 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - uses: ./.github/actions/app-token
        id: app-token
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          repositories: console,middleware,renet,license-server
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          submodules: true
          token: ${{ steps.app-token.outputs.token }}
      - name: Apply version bump
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        shell: bash
        run: .ci/scripts/version/bump.sh --version ${{ inputs.next_version }}
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f  # v6
        with:
          node-version: '22'
          cache: 'npm'
      - run: .ci/scripts/setup/install-deps.sh
      - run: npm run check:lint
      - run: npm run lint:unused

  quality-format:
    name: Format
    runs-on: ubuntu-slim
    if: inputs.is_bot != 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - name: Apply version bump
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        shell: bash
        run: .ci/scripts/version/bump.sh --version ${{ inputs.next_version }}
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f  # v6
        with:
          node-version: '22'
          cache: 'npm'
      - run: .ci/scripts/setup/install-deps.sh
      - run: npm run check:format

  quality-i18n:
    name: i18n
    runs-on: ubuntu-slim
    if: inputs.is_bot != 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f  # v6
        with:
          node-version: '22'
          cache: 'npm'
      - run: .ci/scripts/setup/install-deps.sh
      - run: npm run check:i18n

  quality-types:
    name: TypeScript
    runs-on: ubuntu-slim
    if: inputs.is_bot != 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - uses: ./.github/actions/app-token
        id: app-token
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          repositories: console,middleware,renet,license-server
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          submodules: true
          token: ${{ steps.app-token.outputs.token }}
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f  # v6
        with:
          node-version: '22'
          cache: 'npm'
      - run: .ci/scripts/setup/install-deps.sh
      - run: npm run typecheck

  quality-security:
    name: Security
    runs-on: ubuntu-slim
    if: inputs.is_bot != 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f  # v6
        with:
          node-version: '22'
          cache: 'npm'
      - run: .ci/scripts/setup/install-deps.sh
      - run: .ci/scripts/security/audit.sh
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6
        if: always()
        with:
          name: quality-security-${{ github.sha }}
          path: audit-report.json
          retention-days: 3

  quality-shell:
    name: Shell
    runs-on: ubuntu-slim
    if: inputs.is_bot != 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - name: Install shfmt
        run: |
          curl -sS https://webi.sh/shfmt | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      - run: .ci/scripts/security/shellcheck.sh
      - run: .ci/scripts/security/shfmt.sh
      - run: .ci/scripts/security/check-commands.sh

  quality-workflows:
    name: Workflows
    runs-on: ubuntu-slim
    if: inputs.is_bot != 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - run: .ci/scripts/quality/check-workflows.sh

  quality-compose-env:
    name: Compose Env
    runs-on: ubuntu-slim
    if: inputs.is_bot != 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - run: .ci/scripts/quality/check-compose-env.sh

  quality-e2e-coverage:
    name: E2E Coverage
    runs-on: ubuntu-slim
    if: inputs.is_bot != 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - name: Check E2E test coverage for all renet functions
        run: .ci/scripts/quality/check-e2e-coverage.sh

  quality-middleware:
    name: Middleware
    runs-on: ubuntu-latest
    if: inputs.is_bot != 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - uses: ./.github/actions/app-token
        id: app-token
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          repositories: console,middleware,renet,license-server
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          submodules: true
          token: ${{ steps.app-token.outputs.token }}
      - name: Apply version bump
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: .ci/scripts/version/bump.sh --version ${{ inputs.next_version }}

      - uses: actions/setup-dotnet@baa11fbfe1d6520db94683bd5c7a3818018e4309  # v5
        with:
          dotnet-version: 9.0.x

      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f  # v6
        with:
          node-version: '22'

      - name: Run middleware quality
        run: .ci/scripts/private/run-middleware.sh quality

  quality-renet:
    name: Renet
    runs-on: ubuntu-latest
    if: inputs.is_bot != 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - uses: ./.github/actions/app-token
        id: app-token
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          preset: ci
          repositories: console,middleware,renet,license-server
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          submodules: true
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 0
          ref: ${{ github.head_ref || github.ref }}

      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5  # v6
        with:
          go-version: 'stable'
          cache: true
          cache-dependency-path: private/renet/go.sum

      - name: Run renet quality
        run: .ci/scripts/private/run-renet.sh quality

      - name: Check renet types freshness
        run: .ci/scripts/quality/check-renet-types.sh
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_HEAD_REF: ${{ github.head_ref }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}

      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f  # v6
        with:
          node-version: '22'
          cache: 'npm'

      - run: .ci/scripts/setup/install-deps.sh

      - name: Check license schema consistency
        run: .ci/scripts/quality/check-license-schema.sh
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_HEAD_REF: ${{ github.head_ref }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}

  quality-license-server:
    name: License Server
    runs-on: ubuntu-latest  # Requires Docker for integration tests
    if: inputs.is_bot != 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - uses: ./.github/actions/app-token
        id: app-token
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          repositories: console,middleware,renet,license-server
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          submodules: true
          token: ${{ steps.app-token.outputs.token }}
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f  # v6
        with:
          node-version: '22'
      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5  # v6
        with:
          go-version: 'stable'
          cache: true
          cache-dependency-path: private/renet/go.sum

      - name: Build shared package (required for license types)
        run: |
          npm ci --workspace=@rediacc/shared
          npm run build --workspace=@rediacc/shared

      - name: Start RustFS for integration tests
        working-directory: private/license-server
        run: |
          npm ci
          npm run test:setup

      - name: Run license-server integration tests
        run: .ci/scripts/private/run-license-server.sh test

      - name: Run Go cross-language signature tests
        working-directory: private/renet
        run: go test -v ./pkg/license/... -run TestCrossLanguage

      - name: Stop RustFS
        if: always()
        working-directory: private/license-server
        run: npm run test:teardown

  # ==============================================================================
  # SUBMODULE BRANCH VALIDATION
  # ==============================================================================
  # PURPOSE: Ensures submodule branches match console branch when coordinated
  #          changes are expected (submodule pointer differs from origin/main),
  #          verifies submodule PRs are linked, and checks review comments.
  #
  # AI TROUBLESHOOTING:
  #   If this job fails, check the error message for specific fix commands.
  #
  #   Branch errors:
  #   - Create missing branch: cd private/<sm> && git checkout -b <branch>
  #   - Push branch: git push -u origin <branch>
  #   - Checkout existing: cd private/<sm> && git checkout <branch>
  #
  #   PR linking errors:
  #   - No open PR: cd private/<sm> && gh pr create --title "..." --body "..."
  #   - PR not linked: Edit console PR description to include submodule PR URL
  #
  #   Review comment errors:
  #   - Unreplied comments: Go to submodule PR and reply to all review comments
  #   - Low-effort replies don't count (e.g., "ok", "done", "fixed")
  #   - Must provide substantive responses explaining what was done
  #
  # WHEN SUBMODULES STAY ON MAIN:
  #   If submodule pointer matches origin/main, no branch coordination needed.
  #   The submodule will stay on main and this check passes.
  # ==============================================================================
  quality-submodule-branches:
    name: Submodule Branches
    runs-on: ubuntu-slim
    if: inputs.is_bot != 'true' && github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - uses: ./.github/actions/app-token
        id: app-token
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          preset: ci  # Needs pull-requests:read for gh pr list
          repositories: console,middleware,renet,license-server
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          fetch-depth: 0
          submodules: true
          token: ${{ steps.app-token.outputs.token }}
      - name: Validate submodule branches
        run: .ci/scripts/quality/check-submodule-branches.sh
        env:
          GITHUB_HEAD_REF: ${{ github.head_ref }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          COMMIT_SHA: ${{ github.event.pull_request.head.sha }}
          GITHUB_REPOSITORY: ${{ github.repository }}

  # Bot PRs skip submodule validation but still need the commit status set to
  # success so branch protection rules don't block auto-merge.
  quality-submodule-branches-bot:
    name: Submodule Branches (Bot)
    runs-on: ubuntu-slim
    if: inputs.is_bot == 'true' && github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          sparse-checkout: .github/actions
      - uses: ./.github/actions/app-token
        id: app-token
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          preset: ci
          repositories: console
      - name: Post success status for bot PR
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          gh api "repos/${{ github.repository }}/statuses/${{ github.event.pull_request.head.sha }}" \
            -X POST \
            -f state="success" \
            -f context="quality/submodule-merge-readiness" \
            -f description="Bot PR â€” submodule validation skipped"

  quality-review-comments:
    name: Review Comments
    runs-on: ubuntu-slim
    if: inputs.is_bot != 'true' && github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - name: Check for unreplied review comments
        run: .ci/scripts/quality/check-review-comments.sh
        env:
          GITHUB_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}

  # NOTE: Resolved Threads check is now in review-gate job in ci.yml
  # It runs AFTER Gemini posts its review, so we can check if threads are resolved

  quality-attribution:
    name: Attribution
    runs-on: ubuntu-slim
    if: inputs.is_bot != 'true' && github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - name: Check for Claude attribution
        run: .ci/scripts/quality/check-claude-attribution.sh
        env:
          GITHUB_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}

  quality-pr-description:
    name: PR Description
    runs-on: ubuntu-slim
    if: inputs.is_bot != 'true' && github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
      - name: Check PR description freshness
        run: .ci/scripts/quality/check-pr-description.sh
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
