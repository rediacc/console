name: Submodule Merge Readiness Watch

on:
  schedule:
    - cron: '3,8,13,18,23,28,33,38,43,48,53,58 * * * *'  # Every 5 min, offset to avoid peak
  workflow_dispatch: {}  # Manual trigger for immediate re-check

permissions:
  statuses: write
  pull-requests: read
  contents: read

jobs:
  check:
    name: Update Merge Readiness
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          sparse-checkout: |
            .ci/scripts
            .github/actions
          fetch-depth: 1

      - uses: ./.github/actions/app-token
        id: app-token
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          preset: ci
          repositories: console,middleware,renet,license-server

      - name: Poll and update submodule merge readiness
        run: .ci/scripts/quality/poll-submodule-merge-status.sh
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          STATUS_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
