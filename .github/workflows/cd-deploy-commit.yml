name: Console CD - Deploy (Commit)

# Phase 2 of two-phase deployment: Commit all staged artifacts
# This phase is fast (~70 seconds) and all operations are idempotent for safe retries
# - Retag Docker images from staging to final version + latest
# - Push version bump commit
# - Create GitHub Release
# - Deploy Pages (from pre-built artifact)
# - Cleanup staging tags

on:
  workflow_call:
    inputs:
      next_version:
        required: true
        type: string
      staging_tag:
        required: true
        type: string
        description: 'Staging tag to promote (e.g., staging-abc123...)'
    secrets:
      GH_PAT:
        required: false
      GPG_PRIVATE_KEY:
        required: false
      GPG_PASSPHRASE:
        required: false

jobs:
  # ===========================================================================
  # COMMIT DOCKER - Retag staging images to final version + latest (~10s)
  # ===========================================================================
  commit-docker:
    name: Commit Docker
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GH_PAT }}

      - name: Retag staging to release version
        run: |
          STAGING_TAG="${{ inputs.staging_tag }}"
          VERSION="${{ inputs.next_version }}"

          # Use --skip-if-exists for idempotent retries
          .ci/scripts/docker/retag-image.sh --image api --from "$STAGING_TAG" --to "$VERSION" --push-latest --skip-if-exists
          .ci/scripts/docker/retag-image.sh --image bridge --from "$STAGING_TAG" --to "$VERSION" --push-latest --skip-if-exists
          .ci/scripts/docker/retag-image.sh --image plugin-terminal --from "$STAGING_TAG" --to "$VERSION" --push-latest --skip-if-exists
          .ci/scripts/docker/retag-image.sh --image plugin-browser --from "$STAGING_TAG" --to "$VERSION" --push-latest --skip-if-exists
          .ci/scripts/docker/retag-image.sh --image web --from "$STAGING_TAG" --to "$VERSION" --push-latest --skip-if-exists
          .ci/scripts/docker/retag-image.sh --image cli --from "$STAGING_TAG" --to "$VERSION" --push-latest --skip-if-exists

      - name: Summary
        run: |
          echo "## Commit Docker Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ inputs.next_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Images promoted from staging:**" >> $GITHUB_STEP_SUMMARY
          echo "- ghcr.io/rediacc/elite/api:${{ inputs.next_version }} + :latest" >> $GITHUB_STEP_SUMMARY
          echo "- ghcr.io/rediacc/elite/bridge:${{ inputs.next_version }} + :latest" >> $GITHUB_STEP_SUMMARY
          echo "- ghcr.io/rediacc/elite/plugin-terminal:${{ inputs.next_version }} + :latest" >> $GITHUB_STEP_SUMMARY
          echo "- ghcr.io/rediacc/elite/plugin-browser:${{ inputs.next_version }} + :latest" >> $GITHUB_STEP_SUMMARY
          echo "- ghcr.io/rediacc/elite/web:${{ inputs.next_version }} + :latest" >> $GITHUB_STEP_SUMMARY
          echo "- ghcr.io/rediacc/elite/cli:${{ inputs.next_version }} + :latest" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # COMMIT VERSION - Version bump + commit + push (~10s)
  # ===========================================================================
  commit-version:
    name: Commit Version
    runs-on: ubuntu-latest
    needs: [commit-docker]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      release_sha: ${{ steps.commit.outputs.sha }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          fetch-depth: 0
          submodules: true
          token: ${{ secrets.GH_PAT || github.token }}
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f  # v6
        with:
          node-version: '22'

      - name: Version bump
        run: .ci/scripts/version/bump.sh --version ${{ inputs.next_version }}

      - name: Bump submodule versions
        run: |
          # Stage submodule pointers without committing; commit.sh will include them
          .ci/scripts/version/bump-submodules.sh --version ${{ inputs.next_version }} --stage-only
        env:
          GITHUB_PAT: ${{ secrets.GH_PAT }}

      - name: Version commit
        id: commit
        run: |
          .ci/scripts/version/commit.sh --version ${{ inputs.next_version }} --push --include-submodules
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
        env:
          GITHUB_HEAD_REF: main

      - name: Summary
        run: |
          echo "## Commit Version Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ inputs.next_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit SHA:** ${{ steps.commit.outputs.sha }}" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # COMMIT RELEASE - Create GitHub Release (~15s)
  # ===========================================================================
  commit-release:
    name: Commit Release
    runs-on: ubuntu-slim
    needs: [commit-version]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          ref: ${{ needs.commit-version.outputs.release_sha }}

      - name: Download staging release artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131  # v7
        with:
          name: staging-release-${{ github.sha }}
          path: dist/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.next_version }}
          name: v${{ inputs.next_version }}
          target_commitish: ${{ needs.commit-version.outputs.release_sha }}
          files: |
            dist/desktop/**/*
            dist/cli/**/*
            dist/packages/**/*
          draft: false
          prerelease: false
          generate_release_notes: true

      - name: Summary
        run: |
          echo "## Commit Release Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** v${{ inputs.next_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target SHA:** ${{ needs.commit-version.outputs.release_sha }}" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # COMMIT PAGES - Deploy Pages from pre-built artifact (~30s)
  # ===========================================================================
  commit-pages:
    name: Commit Pages
    runs-on: ubuntu-slim
    needs: [commit-release]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Download staging pages artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131  # v7
        with:
          name: staging-pages-${{ github.sha }}
          path: dist/

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@7b1f4a764d45c48632c6b24a0339c27f5614fb0b  # v4
        with:
          path: dist/

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e  # v4

      - name: Summary
        run: |
          echo "## Commit Pages Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pages URL:** ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # COMMIT CLEANUP - Delete staging tags (~5s)
  # ===========================================================================
  commit-cleanup:
    name: Cleanup Staging
    runs-on: ubuntu-latest
    needs: [commit-pages]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - name: Cleanup staging Docker tags
        run: |
          STAGING_TAG="${{ inputs.staging_tag }}"
          echo "## Cleanup Staging Tags" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Staging tag cleaned up:** $STAGING_TAG" >> $GITHUB_STEP_SUMMARY

          .ci/scripts/docker/cleanup-staging.sh --tag "$STAGING_TAG"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT || github.token }}

      - name: Final deployment summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ inputs.next_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All Phase 2 (Commit) operations completed successfully." >> $GITHUB_STEP_SUMMARY
