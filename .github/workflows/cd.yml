name: Console CD

on:
  push:
    branches:
      - main

# Required for GitHub Pages deployment and Docker publishing
permissions:
  actions: write
  contents: write
  pages: write
  id-token: write
  packages: write  # For GHCR push

# Queue new releases instead of cancelling in-progress ones
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ============================================================================
  # INITIALIZE
  # ============================================================================
  initialize:
    name: Initialize
    runs-on: ubuntu-latest  # Needs Docker for registry cache check
    if: github.actor != 'github-actions[bot]' && github.actor != 'dependabot[bot]' && !contains(github.event.head_commit.message, '[skip ci]')
    outputs:
      is_bot: ${{ steps.init.outputs.is_bot }}
      next_version: ${{ steps.init.outputs.next_version }}
      api_tag: ${{ steps.init.outputs.api_tag }}
      api_exists: ${{ steps.init.outputs.api_exists }}
      bridge_tag: ${{ steps.init.outputs.bridge_tag }}
      bridge_exists: ${{ steps.init.outputs.bridge_exists }}
      plugins_tag: ${{ steps.init.outputs.plugins_tag }}
      plugins_exists: ${{ steps.init.outputs.plugins_exists }}
      web_tag: ${{ steps.init.outputs.web_tag }}
      web_exists: ${{ steps.init.outputs.web_exists }}
      cli_tag: ${{ steps.init.outputs.cli_tag }}
      cli_exists: ${{ steps.init.outputs.cli_exists }}
      image_tag: ${{ steps.init.outputs.image_tag }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      # Login to GHCR for registry cache check
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GH_PAT }}

      # Run consolidated initialization script
      - name: Initialize CI
        id: init
        env:
          GITHUB_PAT: ${{ secrets.GH_PAT }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_ACTOR: ${{ github.actor }}
          COMMIT_AUTHOR: ${{ github.event.head_commit.author.name }}
        run: |
          .ci/scripts/ci/initialize.sh --output "$GITHUB_OUTPUT"

  # ============================================================================
  # BUILD
  # ============================================================================
  build-docker:
    name: Build (Docker)
    needs: [initialize]
    uses: ./.github/workflows/ci-build-docker.yml
    with:
      next_version: ${{ needs.initialize.outputs.next_version }}
      api_tag: ${{ needs.initialize.outputs.api_tag }}
      api_exists: ${{ needs.initialize.outputs.api_exists }}
      bridge_tag: ${{ needs.initialize.outputs.bridge_tag }}
      bridge_exists: ${{ needs.initialize.outputs.bridge_exists }}
      plugins_tag: ${{ needs.initialize.outputs.plugins_tag }}
      plugins_exists: ${{ needs.initialize.outputs.plugins_exists }}
      web_tag: ${{ needs.initialize.outputs.web_tag }}
      web_exists: ${{ needs.initialize.outputs.web_exists }}
      cli_tag: ${{ needs.initialize.outputs.cli_tag }}
      cli_exists: ${{ needs.initialize.outputs.cli_exists }}
    secrets: inherit

  build-desktop:
    name: Build (Desktop)
    needs: [initialize]
    uses: ./.github/workflows/ci-build-desktop.yml
    with:
      next_version: ${{ needs.initialize.outputs.next_version }}
    secrets: inherit

  build-cli:
    name: Build (CLI)
    needs: [initialize]
    uses: ./.github/workflows/ci-build-cli.yml
    with:
      next_version: ${{ needs.initialize.outputs.next_version }}
    secrets: inherit

  # ============================================================================
  # DEPLOY DRY-RUN
  # ============================================================================
  deploy-dryrun:
    name: Deploy Dry-Run
    needs: [initialize, build-docker, build-desktop, build-cli]
    uses: ./.github/workflows/cd-deploy-stage.yml
    with:
      dry_run: true
      next_version: ${{ needs.initialize.outputs.next_version }}
      staging_tag: dryrun-${{ github.sha }}
      api_tag: ${{ needs.initialize.outputs.api_tag }}
      bridge_tag: ${{ needs.initialize.outputs.bridge_tag }}
      plugins_tag: ${{ needs.initialize.outputs.plugins_tag }}
      web_tag: ${{ needs.initialize.outputs.web_tag }}
      cli_tag: ${{ needs.initialize.outputs.cli_tag }}
    secrets: inherit

  # ============================================================================
  # DEPLOY - PHASE 1 (STAGE)
  # ============================================================================
  deploy-stage:
    name: Deploy (Stage)
    needs: [initialize, build-docker, build-desktop, build-cli, deploy-dryrun]
    if: needs.deploy-dryrun.result == 'success'
    uses: ./.github/workflows/cd-deploy-stage.yml
    with:
      next_version: ${{ needs.initialize.outputs.next_version }}
      staging_tag: staging-${{ github.sha }}
      api_tag: ${{ needs.initialize.outputs.api_tag }}
      bridge_tag: ${{ needs.initialize.outputs.bridge_tag }}
      plugins_tag: ${{ needs.initialize.outputs.plugins_tag }}
      web_tag: ${{ needs.initialize.outputs.web_tag }}
      cli_tag: ${{ needs.initialize.outputs.cli_tag }}
    secrets: inherit

  # ============================================================================
  # DEPLOY - PHASE 2 (COMMIT)
  # ============================================================================
  deploy-commit:
    name: Deploy (Commit)
    needs: [initialize, deploy-stage]
    if: needs.deploy-stage.result == 'success'
    uses: ./.github/workflows/cd-deploy-commit.yml
    with:
      next_version: ${{ needs.initialize.outputs.next_version }}
      staging_tag: staging-${{ github.sha }}
    secrets: inherit
