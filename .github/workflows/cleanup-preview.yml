name: Cleanup PR Preview

on:
  pull_request_target: # security: approved â€” protected by fork guard in job condition
    types: [closed]

permissions:
  contents: read
  actions: read

jobs:
  cleanup:
    name: Cleanup CF Pages Preview
    runs-on: ubuntu-slim
    # Skip fork PRs (no access to secrets)
    if: github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          sparse-checkout: |
            .ci/scripts
            private/account
            packages/shared
            package.json
            package-lock.json

      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f  # v6
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm ci

      - name: Build shared packages
        run: npm run build:packages

      - name: Cleanup preview deployments
        run: .ci/scripts/housekeeping/cleanup-cf-preview.sh --branch "pr-${{ github.event.pull_request.number }}"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}

      - name: Cleanup www preview Worker
        run: npx wrangler delete --name www-pr-${{ github.event.pull_request.number }} --force 2>/dev/null || true
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}

      - name: Cleanup Stripe sandbox
        run: npx tsx scripts/cleanup-sandbox.ts --pr-number ${{ github.event.pull_request.number }}
        working-directory: private/account
        env:
          STRIPE_SANDBOX_SECRET_KEY: ${{ secrets.STRIPE_SANDBOX_SECRET_KEY }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}

      - name: Delete GitHub environment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api -X DELETE "repos/${{ github.repository }}/environments/pr-${{ github.event.pull_request.number }}" 2>/dev/null \
            && echo "Deleted environment pr-${{ github.event.pull_request.number }}" \
            || echo "Environment pr-${{ github.event.pull_request.number }} not found (already deleted)"
