name: Cleanup PR Preview

on:
  pull_request_target:
    types: [closed]

jobs:
  cleanup:
    name: Cleanup CF Pages Preview
    runs-on: ubuntu-slim
    # Skip fork PRs (no access to secrets)
    if: github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          sparse-checkout: .ci/scripts

      - name: Cleanup preview deployments
        run: .ci/scripts/housekeeping/cleanup-cf-preview.sh --branch "pr-${{ github.event.pull_request.number }}"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}

      - name: Cleanup www preview Worker
        run: npx wrangler delete --name www-pr-${{ github.event.pull_request.number }} --force 2>/dev/null || true
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}

      - name: Cleanup Stripe sandbox
        run: .ci/scripts/stripe/cleanup-sandbox.sh --pr-number ${{ github.event.pull_request.number }}
        env:
          STRIPE_SANDBOX_SECRET_KEY: ${{ secrets.STRIPE_SANDBOX_SECRET_KEY }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}

      - name: Delete GitHub environment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api -X DELETE "repos/${{ github.repository }}/environments/pr-${{ github.event.pull_request.number }}" 2>/dev/null \
            && echo "Deleted environment pr-${{ github.event.pull_request.number }}" \
            || echo "Environment pr-${{ github.event.pull_request.number }} not found (already deleted)"
