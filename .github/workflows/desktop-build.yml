name: Desktop Build

# Build and release Electron desktop application for Windows, macOS, and Linux
# Triggers on version tags or manual dispatch

on:
  workflow_dispatch:
    inputs:
      publish:
        description: 'Publish to GitHub Releases'
        required: false
        type: boolean
        default: false
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'

permissions:
  contents: write

concurrency:
  group: desktop-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: win
            artifact: rediacc-console-win
          - os: macos-latest
            platform: mac
            artifact: rediacc-console-mac
          - os: ubuntu-latest
            platform: linux
            artifact: rediacc-console-linux

    runs-on: ${{ matrix.os }}

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'  # Required for @electron/rebuild 4.x
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build shared packages
        run: npm run build:packages

      - name: Build web package
        env:
          REDIACC_BUILD_TYPE: RELEASE
          NODE_ENV: production
        run: npm run build:web

      - name: Build Electron application
        working-directory: packages/desktop
        run: npm run build

      - name: Package for ${{ matrix.platform }}
        working-directory: packages/desktop
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          case "${{ matrix.platform }}" in
            win)
              npm run dist:win
              ;;
            mac)
              npm run dist:mac
              ;;
            linux)
              npm run dist:linux
              ;;
          esac

      - name: List build output
        run: |
          echo "Build output:"
          ls -la dist/desktop/ || echo "No dist/desktop directory"

      - name: Upload artifacts (Windows)
        if: matrix.platform == 'win'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: |
            dist/desktop/*.exe
            dist/desktop/*.yml
            dist/desktop/*.blockmap
          if-no-files-found: error

      - name: Upload artifacts (macOS)
        if: matrix.platform == 'mac'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: |
            dist/desktop/*.dmg
            dist/desktop/*.yml
            dist/desktop/*.blockmap
          if-no-files-found: error

      - name: Upload artifacts (Linux)
        if: matrix.platform == 'linux'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: |
            dist/desktop/*.AppImage
            dist/desktop/*.deb
            dist/desktop/*.yml
            dist/desktop/*.blockmap
          if-no-files-found: error

  publish:
    needs: build
    if: github.event_name == 'push' || github.event.inputs.publish == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          find artifacts -type f -name "*" | head -50

      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Tag is already in X.Y.Z format
            VERSION="${{ github.ref_name }}"
          else
            # Get latest version tag
            VERSION=$(git tag -l '[0-9]*.[0-9]*.[0-9]*' | sort -V | tail -1)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Desktop v${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          files: |
            artifacts/**/*.exe
            artifacts/**/*.dmg
            artifacts/**/*.AppImage
            artifacts/**/*.deb
            artifacts/**/*.yml
            artifacts/**/*.blockmap
          body: |
            ## Rediacc Console Desktop v${{ steps.version.outputs.version }}

            ### Downloads

            **Windows**
            - `rediacc-console-${{ steps.version.outputs.version }}-win-x64.exe` - NSIS installer

            **macOS**
            - `rediacc-console-${{ steps.version.outputs.version }}-mac-x64.dmg` - Intel Macs
            - `rediacc-console-${{ steps.version.outputs.version }}-mac-arm64.dmg` - Apple Silicon

            **Linux**
            - `rediacc-console-${{ steps.version.outputs.version }}-linux.AppImage` - Portable application
            - `rediacc-console-${{ steps.version.outputs.version }}-linux-amd64.deb` - Debian/Ubuntu package

            ### Auto-Updates
            The desktop application will automatically check for updates and notify you when a new version is available.

            ### Installation

            **Windows**: Run the installer and follow the prompts.

            **macOS**: Open the DMG, drag the app to Applications.

            **Linux (AppImage)**: Make executable with `chmod +x` and run.

            **Linux (deb)**: Install with `sudo dpkg -i rediacc-console_*.deb`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate build summary
        run: |
          echo "## Desktop Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Version: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Windows | Built |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS | Built |" >> $GITHUB_STEP_SUMMARY
          echo "| Linux | Built |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ github.event_name }}" == "push" ]] || [[ "${{ github.event.inputs.publish }}" == "true" ]]; then
            echo "### Release" >> $GITHUB_STEP_SUMMARY
            echo "Published to GitHub Releases: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          fi
