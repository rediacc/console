name: Console CT - Install Methods

# Reusable workflow to test all documented installation methods
# Called after successful release to validate published artifacts
#
# Consolidated by runner type to minimize job overhead:
# - Linux x64: Binary, Docker, APT, DNF, APK, Pacman, Quick Install, Linuxbrew
# - Linux arm64: Binary, Docker, Quick Install
# - macOS ARM64: Binary, Homebrew
# - macOS x64: Binary, Homebrew
# - Windows x64: Binary
# - Windows arm64: Binary

on:
  workflow_call:
    inputs:
      version:
        description: 'Version to test (e.g., 0.4.58)'
        required: true
        type: string
    secrets:
      APP_PRIVATE_KEY:
        required: false

permissions:
  contents: read
  packages: read    # GHCR pull for install tests

jobs:
  # ===========================================================================
  # Linux x64: Binary, Docker, APT, DNF, APK, Pacman, Quick Install, Linuxbrew
  # ===========================================================================
  test-linux-x64:
    name: Linux (x64)
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - name: Login to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9  # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Test Binary Download
        run: |
          .ci/scripts/test/test-install-methods.sh \
            --method binary \
            --version ${{ inputs.version }} \
            --platform linux \
            --arch x64

      - name: Test Docker
        run: |
          .ci/scripts/test/test-install-methods.sh \
            --method docker \
            --version ${{ inputs.version }}

      - name: Test APT Installation
        run: |
          .ci/scripts/test/test-install-methods.sh \
            --method apt \
            --version ${{ inputs.version }}

      - name: Test DNF Installation
        run: |
          .ci/scripts/test/test-install-methods.sh \
            --method dnf \
            --version ${{ inputs.version }}

      - name: Test APK Installation
        run: |
          .ci/scripts/test/test-install-methods.sh \
            --method apk \
            --version ${{ inputs.version }}

      - name: Test Pacman Installation
        run: |
          .ci/scripts/test/test-install-methods.sh \
            --method pacman \
            --version ${{ inputs.version }}

      - name: Test Quick Install
        run: |
          .ci/scripts/test/test-install-methods.sh \
            --method quick \
            --version ${{ inputs.version }}

      - name: Install Homebrew (Linuxbrew)
        run: |
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          echo "/home/linuxbrew/.linuxbrew/bin" >> $GITHUB_PATH

      - name: Test Homebrew (Linuxbrew)
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          .ci/scripts/test/test-install-methods.sh \
            --method homebrew \
            --version ${{ inputs.version }}

  # ===========================================================================
  # Linux arm64: Binary, Docker, Quick Install
  # ===========================================================================
  test-linux-arm64:
    name: Linux (arm64)
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - name: Login to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9  # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Test Binary Download
        run: |
          .ci/scripts/test/test-install-methods.sh \
            --method binary \
            --version ${{ inputs.version }} \
            --platform linux \
            --arch arm64

      - name: Test Docker
        run: |
          .ci/scripts/test/test-install-methods.sh \
            --method docker \
            --version ${{ inputs.version }}

      - name: Test Quick Install
        run: |
          .ci/scripts/test/test-install-methods.sh \
            --method quick \
            --version ${{ inputs.version }}

  # ===========================================================================
  # macOS ARM64: Binary, Homebrew
  # ===========================================================================
  test-macos-arm64:
    name: macOS (ARM64)
    runs-on: macos-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - name: Test Binary Download
        run: |
          .ci/scripts/test/test-install-methods.sh \
            --method binary \
            --version ${{ inputs.version }} \
            --platform mac \
            --arch arm64

      - name: Test Homebrew Installation
        run: |
          .ci/scripts/test/test-install-methods.sh \
            --method homebrew \
            --version ${{ inputs.version }}

  # ===========================================================================
  # macOS x64: Binary, Homebrew
  # ===========================================================================
  test-macos-x64:
    name: macOS (x64)
    runs-on: macos-15-intel
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - name: Test Binary Download
        run: |
          .ci/scripts/test/test-install-methods.sh \
            --method binary \
            --version ${{ inputs.version }} \
            --platform mac \
            --arch x64

      - name: Test Homebrew Installation
        run: |
          .ci/scripts/test/test-install-methods.sh \
            --method homebrew \
            --version ${{ inputs.version }}

  # ===========================================================================
  # Windows x64: Binary
  # ===========================================================================
  test-windows-x64:
    name: Windows (x64)
    runs-on: windows-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - name: Test Binary Download
        shell: bash
        run: |
          .ci/scripts/test/test-install-methods.sh \
            --method binary \
            --version ${{ inputs.version }} \
            --platform win \
            --arch x64

  # ===========================================================================
  # Windows arm64: Binary
  # ===========================================================================
  test-windows-arm64:
    name: Windows (arm64)
    runs-on: windows-11-arm
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - name: Test Binary Download
        shell: bash
        run: |
          .ci/scripts/test/test-install-methods.sh \
            --method binary \
            --version ${{ inputs.version }} \
            --platform win \
            --arch arm64

  # ===========================================================================
  # Gate Job - All tests must pass
  # ===========================================================================
  install-methods-complete:
    name: Install Methods Complete
    runs-on: ubuntu-slim
    needs:
      - test-linux-x64
      - test-linux-arm64
      - test-macos-arm64
      - test-macos-x64
      - test-windows-x64
      - test-windows-arm64
    if: always() && !cancelled()
    steps:
      - name: Check all tests passed
        run: |
          echo "## Install Method Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check each job result
          linux_x64="${{ needs.test-linux-x64.result }}"
          linux_arm64="${{ needs.test-linux-arm64.result }}"
          macos_arm64="${{ needs.test-macos-arm64.result }}"
          macos_x64="${{ needs.test-macos-x64.result }}"
          windows_x64="${{ needs.test-windows-x64.result }}"
          windows_arm64="${{ needs.test-windows-arm64.result }}"

          echo "| Platform | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Linux x64 (Binary, Docker, APT, DNF, APK, Pacman, Quick, Linuxbrew) | $linux_x64 |" >> $GITHUB_STEP_SUMMARY
          echo "| Linux arm64 (Binary, Docker, Quick) | $linux_arm64 |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS ARM64 (Binary, Homebrew) | $macos_arm64 |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS x64 (Binary, Homebrew) | $macos_x64 |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows x64 (Binary) | $windows_x64 |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows arm64 (Binary) | $windows_arm64 |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Fail if any test failed
          if [[ "$linux_x64" != "success" ]] || \
             [[ "$linux_arm64" != "success" ]] || \
             [[ "$macos_arm64" != "success" ]] || \
             [[ "$macos_x64" != "success" ]] || \
             [[ "$windows_x64" != "success" ]] || \
             [[ "$windows_arm64" != "success" ]]; then
            echo "**Status:** Some installation method tests failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "**Status:** All installation method tests passed for version ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
