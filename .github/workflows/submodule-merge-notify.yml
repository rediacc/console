name: Submodule Merge Readiness Poll

# Lightweight scheduled poll that re-evaluates the quality/submodule-merge-readiness
# commit status on all open console PRs. Runs every 5 minutes, completes in <30s.
#
# Replaces the cross-repo notify-console.yml dispatch pattern which required
# spreading APP_PRIVATE_KEY across submodule repos (security risk).
#
# Also supports manual trigger and repository_dispatch for backward compatibility.

on:
  schedule:
    - cron: '*/5 * * * *'  # Every 5 minutes
  repository_dispatch:
    types: [submodule-pr-merged]
  workflow_dispatch:

permissions:
  contents: read
  statuses: write

jobs:
  poll:
    name: Re-evaluate Submodule Merge Readiness
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          sparse-checkout: |
            .ci/scripts
            .github/actions

      - uses: ./.github/actions/app-token
        id: app-token
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          preset: ci
          repositories: console,middleware,renet,account,elite,sql,growth,homebrew-tap

      - name: Poll submodule merge readiness
        run: .ci/scripts/quality/poll-submodule-merge-status.sh
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          STATUS_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
