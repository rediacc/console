name: Console CI

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize]
  merge_group:
    types: [checks_requested]
  schedule:
    - cron: '0 3 * * *'  # Nightly at 3:00 UTC
  workflow_dispatch:
    inputs:
      browsers:
        description: 'E2E browsers to test'
        required: false
        type: choice
        default: 'chromium-only'
        options:
          - 'chromium-only'
          - 'all-browsers'

# Required for CI watchdog to cancel/retry workflow on job failures,
# GitHub Pages deployment, autofix commits, and Docker publishing
permissions:
  actions: write
  contents: write
  pages: write
  id-token: write
  packages: write  # For GHCR push

# E2E Browser Configuration
# Default: chromium only. Use workflow_dispatch with "all-browsers" to test all.
# To permanently enable all browsers, change the fallback value below.
env:
  E2E_BROWSERS: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.browsers == 'all-browsers' && 'chromium firefox webkit msedge' || 'chromium' }}

concurrency:
  group: ${{ github.event_name == 'push' && 'ci-main' || format('ci-{0}', github.run_id) }}
  cancel-in-progress: false

jobs:
  # ============================================================================
  # COLUMN 1: INITIALIZE
  # Jobs: initialize, ci-watchdog
  # No dependencies - starts immediately for fast feedback on Quality checks
  # ============================================================================
  initialize:
    name: Initialize
    runs-on: ubuntu-latest  # Needs Docker for registry cache check
    if: github.event_name != 'push' || (github.actor != 'github-actions[bot]' && github.actor != 'dependabot[bot]' && !contains(github.event.head_commit.message, '[skip ci]'))
    outputs:
      is_bot: ${{ steps.init.outputs.is_bot }}
      next_version: ${{ steps.init.outputs.next_version }}
      bump_type: ${{ steps.init.outputs.bump_type }}
      staging_tag: ${{ steps.staging.outputs.staging_tag }}
      api_tag: ${{ steps.init.outputs.api_tag }}
      api_exists: ${{ steps.init.outputs.api_exists }}
      bridge_tag: ${{ steps.init.outputs.bridge_tag }}
      bridge_exists: ${{ steps.init.outputs.bridge_exists }}
      plugins_tag: ${{ steps.init.outputs.plugins_tag }}
      plugins_exists: ${{ steps.init.outputs.plugins_exists }}
      web_tag: ${{ steps.init.outputs.web_tag }}
      web_exists: ${{ steps.init.outputs.web_exists }}
      cli_tag: ${{ steps.init.outputs.cli_tag }}
      cli_exists: ${{ steps.init.outputs.cli_exists }}
      image_tag: ${{ steps.init.outputs.image_tag }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          persist-credentials: false

      - uses: ./.github/actions/app-token
        id: app-token
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          preset: ci
          repositories: console,middleware,renet,license-server

      # PR Validation (PR events only)
      - name: Validate PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd  # v8
        with:
          script: return await require('./.ci/scripts/ci/validate-pr.cjs')({github, context, core})

      # Login to GHCR for registry cache check
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      # Run consolidated initialization script
      - name: Initialize CI
        id: init
        env:
          GITHUB_PAT: ${{ steps.app-token.outputs.token }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_ACTOR: ${{ github.actor }}
          COMMIT_AUTHOR: ${{ github.event.head_commit.author.name }}
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          .ci/scripts/ci/initialize.sh --output "$GITHUB_OUTPUT"

      - name: Generate staging tag
        id: staging
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "staging_tag=staging-${{ github.sha }}" >> $GITHUB_OUTPUT
          else
            echo "staging_tag=dryrun-${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      # Upload CI tags as artifact for debugging
      - name: Upload CI Tags
        if: steps.init.outputs.is_bot != 'true'
        run: |
          cat > ci-tags.txt << EOF
          api_tag=${{ steps.init.outputs.api_tag }}
          bridge_tag=${{ steps.init.outputs.bridge_tag }}
          plugins_tag=${{ steps.init.outputs.plugins_tag }}
          web_tag=${{ steps.init.outputs.web_tag }}
          EOF
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6
        if: steps.init.outputs.is_bot != 'true'
        with:
          name: ci-tags-${{ github.sha }}
          path: ci-tags.txt
          retention-days: 1

  cancel-watchdog:
    name: CI Watchdog
    needs: [initialize]
    runs-on: ubuntu-latest
    timeout-minutes: 180  # 3 hours max
    # Use !cancelled() so force-cancel from newer runs can stop this job
    if: ${{ !cancelled() && needs.initialize.result == 'success' }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          sparse-checkout: .ci/scripts

      - name: Cancel older runs
        if: github.event_name == 'pull_request' && !contains(github.event.pull_request.labels.*.name, 'no-cancel-push')
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: .ci/scripts/ci/cancel-older-runs.sh --timeout 60 --poll-interval 10

      - name: Monitor all jobs and cancel on failure
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd  # v8
        env:
          WATCHDOG_EXCLUDE_PATTERNS: 'Watchdog,CI Complete'
          WATCHDOG_NO_RETRY_PATTERNS: 'Quality,Review Gate'
          WATCHDOG_INDEPENDENT_PATTERNS: 'Build (CLI),Build (Desktop)'
        with:
          script: return await require('./.ci/scripts/ci/watchdog-monitor.cjs')({github, context, core})

  # ============================================================================
  # COLUMN 2: QUALITY
  # Jobs: quality (reusable workflow)
  # Dependencies: [initialize]
  # ============================================================================
  quality:
    name: Quality
    needs: [initialize]
    if: needs.initialize.outputs.is_bot != 'true'
    uses: ./.github/workflows/ci-quality.yml
    with:
      is_bot: ${{ needs.initialize.outputs.is_bot }}
      next_version: ${{ needs.initialize.outputs.next_version }}
    secrets: inherit

  # ============================================================================
  # REVIEW GATE: Trigger Gemini review, wait for it, check resolved threads
  # Dependencies: [initialize, quality]
  # Must pass before Build jobs can start
  #
  # Flow: Quality passes → Trigger Gemini → Wait for response → Check threads
  # ============================================================================
  review-gate:
    name: Review Gate
    needs: [initialize, quality]
    runs-on: ubuntu-slim
    if: needs.initialize.outputs.is_bot != 'true' && github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          sparse-checkout: |
            .ci/scripts
            .github/actions
      - uses: ./.github/actions/app-token
        id: app-token
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          preset: ci
          repositories: console
      - name: Trigger Gemini review
        run: .ci/scripts/quality/trigger-gemini-review.sh
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
      - name: Wait for Gemini review
        run: .ci/scripts/quality/wait-gemini-review.sh
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
      - name: Check resolved threads
        run: .ci/scripts/quality/check-resolved-threads.sh
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_REPOSITORY: ${{ github.repository }}

  # ============================================================================
  # COLUMN 3: BUILD & DOCKER
  # Jobs: build-renet (unified), build-docker, build-desktop (parallel reusable workflows)
  # Dependencies: quality + review-gate -> build-renet -> build-docker, build-cli
  # ============================================================================

  # Unified renet build - produces full binaries with embedded CRIU/rsync
  # Used by BOTH CLI (SEA embedding) and Docker (bridge images)
  build-renet:
    name: Build (Renet)
    needs: [initialize, quality, review-gate]
    if: always() && needs.initialize.result == 'success' && needs.quality.result == 'success' && (needs.review-gate.result == 'success' || needs.review-gate.result == 'skipped')
    uses: ./.github/workflows/ci-build-renet.yml
    with:
      next_version: ${{ needs.initialize.outputs.next_version }}
      skip_build: ${{ needs.initialize.outputs.bridge_exists == 'true' }}
      bridge_tag: ${{ needs.initialize.outputs.bridge_tag }}
    secrets: inherit

  build-docker:
    name: Build (Docker)
    needs: [initialize, quality, review-gate, build-renet]
    if: always() && needs.initialize.result == 'success' && needs.quality.result == 'success' && (needs.review-gate.result == 'success' || needs.review-gate.result == 'skipped')
    uses: ./.github/workflows/ci-build-docker.yml
    with:
      next_version: ${{ needs.initialize.outputs.next_version }}
      api_tag: ${{ needs.initialize.outputs.api_tag }}
      api_exists: ${{ needs.initialize.outputs.api_exists }}
      bridge_tag: ${{ needs.initialize.outputs.bridge_tag }}
      bridge_exists: ${{ needs.initialize.outputs.bridge_exists }}
      plugins_tag: ${{ needs.initialize.outputs.plugins_tag }}
      plugins_exists: ${{ needs.initialize.outputs.plugins_exists }}
      web_tag: ${{ needs.initialize.outputs.web_tag }}
      web_exists: ${{ needs.initialize.outputs.web_exists }}
      cli_tag: ${{ needs.initialize.outputs.cli_tag }}
      cli_exists: ${{ needs.initialize.outputs.cli_exists }}
    secrets: inherit

  build-desktop:
    name: Build (Desktop)
    needs: [initialize, quality, review-gate]
    if: always() && needs.initialize.result == 'success' && needs.quality.result == 'success' && (needs.review-gate.result == 'success' || needs.review-gate.result == 'skipped')
    uses: ./.github/workflows/ci-build-desktop.yml
    with:
      next_version: ${{ needs.initialize.outputs.next_version }}
    secrets: inherit

  build-cli:
    name: Build (CLI)
    needs: [initialize, quality, review-gate, build-renet]
    if: always() && needs.initialize.result == 'success' && needs.quality.result == 'success' && (needs.review-gate.result == 'success' || needs.review-gate.result == 'skipped')
    uses: ./.github/workflows/ci-build-cli.yml
    with:
      next_version: ${{ needs.initialize.outputs.next_version }}
    secrets: inherit

  # ============================================================================
  # COLUMN 3B: DEPLOY DRY-RUN
  # Jobs: deploy-dryrun (reusable workflow)
  # Dependencies: build-docker, build-desktop, build-cli
  # ============================================================================
  deploy-dryrun:
    name: Deploy Dry-Run
    needs: [initialize, build-docker, build-desktop, build-cli]
    if: always() && needs.initialize.outputs.is_bot != 'true' && needs.initialize.result == 'success' && needs.build-docker.result == 'success' && needs.build-desktop.result == 'success' && needs.build-cli.result == 'success'
    uses: ./.github/workflows/cd-dryrun.yml
    with:
      dry_run: ${{ github.event_name != 'push' }}
      upload_pages: ${{ github.event_name == 'pull_request' }}
      next_version: ${{ needs.initialize.outputs.next_version }}
      staging_tag: ${{ needs.initialize.outputs.staging_tag }}
      api_tag: ${{ needs.initialize.outputs.api_tag }}
      bridge_tag: ${{ needs.initialize.outputs.bridge_tag }}
      plugins_tag: ${{ needs.initialize.outputs.plugins_tag }}
      web_tag: ${{ needs.initialize.outputs.web_tag }}
      cli_tag: ${{ needs.initialize.outputs.cli_tag }}
    secrets: inherit

  # ============================================================================
  # COLUMN 4: TESTS + INFRA
  # Jobs: tests (reusable workflow)
  # Dependencies: build-docker (tests can start without waiting for desktop builds)
  # ============================================================================
  tests:
    name: Tests + Infra
    needs: [initialize, build-docker]
    if: always() && needs.initialize.result == 'success' && needs.build-docker.result == 'success'
    uses: ./.github/workflows/ct-tests.yml
    with:
      api_tag: ${{ needs.initialize.outputs.api_tag }}
      bridge_tag: ${{ needs.initialize.outputs.bridge_tag }}
      web_tag: ${{ needs.initialize.outputs.web_tag }}
      e2e_browsers: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.browsers == 'all-browsers' && 'chromium firefox webkit msedge' || 'chromium' }}
      provision_vms: true
    secrets: inherit

  # ============================================================================
  # COLUMN 4B: STANDALONE RUN TEST
  # Validates the standalone-run workflow works correctly with all VM OS variants
  # Dependencies: build-docker (needs Docker images)
  # ============================================================================
  standalone-run-test:
    name: Standalone Run
    needs: [initialize, build-docker]
    if: always() && needs.initialize.result == 'success' && needs.build-docker.result == 'success'
    uses: ./.github/workflows/standalone-run.yml
    with:
      run-name: 'CI Validation'
      duration: '5'
      version: ${{ needs.initialize.outputs.bridge_tag }}
      api-tag: ${{ needs.initialize.outputs.api_tag }}
      web-tag: ${{ needs.initialize.outputs.web_tag }}
      bridge-tag: ${{ needs.initialize.outputs.bridge_tag }}
      ci-mode: true
      vm-os-list: '["none", "ubuntu-24.04", "debian-12"]'
    secrets: inherit

  # ============================================================================
  # COLUMN 5: DEPLOY PREVIEW
  # Deploys pages preview to Cloudflare Pages for PR validation
  # Dependencies: deploy-dryrun, tests, standalone-run-test (ALL must pass)
  # Only runs on pull_request events
  # ============================================================================
  deploy-preview:
    name: Deploy Preview
    needs: [initialize, deploy-dryrun, tests, standalone-run-test]
    runs-on: ubuntu-slim
    if: >-
      always() &&
      github.event_name == 'pull_request' &&
      needs.initialize.result == 'success' &&
      needs.deploy-dryrun.result == 'success' &&
      needs.tests.result == 'success' &&
      needs.standalone-run-test.result == 'success'
    environment:
      name: pr-${{ github.event.pull_request.number }}
      url: https://pr-${{ github.event.pull_request.number }}.rediacc.pages.dev
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          sparse-checkout: .ci/scripts/
          submodules: false

      - name: Download preview pages artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131  # v7
        with:
          name: preview-pages-${{ github.sha }}
          path: dist/pages/

      # Inject e2e test videos into pages for documentation embedding
      - name: Inject E2E videos
        env:
          GH_TOKEN: ${{ github.token }}
        run: .ci/scripts/docs/inject-e2e-videos.sh --run-id "${{ github.run_id }}" --artifact-name "e2e-videos-${{ github.sha }}" --output dist/pages/assets/videos/user-guide/ || true

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@da0e0dfe58b7a431659754fdf3f186c529afbe65  # v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist/pages/ --project-name=rediacc --branch=pr-${{ github.event.pull_request.number }}

      - name: Deployment summary
        run: |
          echo "## Preview Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://pr-${{ github.event.pull_request.number }}.rediacc.pages.dev" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # CI COMPLETE - Gate for merge queue
  # This job only succeeds if ALL CI jobs pass
  # ============================================================================
  ci-complete:
    name: CI Complete
    runs-on: ubuntu-slim
    needs: [initialize, quality, review-gate, build-docker, build-desktop, build-cli, deploy-dryrun, tests, standalone-run-test, deploy-preview]
    if: always() && !cancelled()
    steps:
      - name: Check all jobs passed
        run: |
          # review-gate can be skipped for non-PR events or bots
          REVIEW_GATE_OK="false"
          if [[ "${{ needs.review-gate.result }}" == "success" ]] || [[ "${{ needs.review-gate.result }}" == "skipped" ]]; then
            REVIEW_GATE_OK="true"
          fi

          # deploy-preview can be skipped for non-PR events
          DEPLOY_PREVIEW_OK="false"
          if [[ "${{ needs.deploy-preview.result }}" == "success" ]] || [[ "${{ needs.deploy-preview.result }}" == "skipped" ]]; then
            DEPLOY_PREVIEW_OK="true"
          fi

          if [[ "${{ needs.initialize.result }}" != "success" ]] || \
             [[ "${{ needs.quality.result }}" != "success" ]] || \
             [[ "$REVIEW_GATE_OK" != "true" ]] || \
             [[ "${{ needs.build-docker.result }}" != "success" ]] || \
             [[ "${{ needs.build-desktop.result }}" != "success" ]] || \
             [[ "${{ needs.build-cli.result }}" != "success" ]] || \
             [[ "${{ needs.deploy-dryrun.result }}" != "success" ]] || \
             [[ "${{ needs.tests.result }}" != "success" ]] || \
             [[ "${{ needs.standalone-run-test.result }}" != "success" ]] || \
             [[ "$DEPLOY_PREVIEW_OK" != "true" ]]; then
            echo "One or more jobs failed:"
            echo "  initialize: ${{ needs.initialize.result }}"
            echo "  quality: ${{ needs.quality.result }}"
            echo "  review-gate: ${{ needs.review-gate.result }}"
            echo "  build-docker: ${{ needs.build-docker.result }}"
            echo "  build-desktop: ${{ needs.build-desktop.result }}"
            echo "  build-cli: ${{ needs.build-cli.result }}"
            echo "  deploy-dryrun: ${{ needs.deploy-dryrun.result }}"
            echo "  tests: ${{ needs.tests.result }}"
            echo "  standalone-run-test: ${{ needs.standalone-run-test.result }}"
            echo "  deploy-preview: ${{ needs.deploy-preview.result }}"
            exit 1
          fi
          echo "All CI jobs passed successfully!"


