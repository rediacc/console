{"id":"databases_postgresql","name":"PostgreSQL Template","description":"High-performance PostgreSQL setup with benchmarking and automated configuration.","category":"databases","tags":["databases","postgresql"],"files":[{"name":".env","path":"postgresql/.env","type":"environment","content":"# Network Mode Configuration\n# Options:\n#   bridge - Isolated network, multiple instances supported (default)\n#   host   - Shared host network, checkpoint-compatible (for live migration)\nNETWORK_MODE=bridge\n\n# Note: Host networking required for Docker checkpoint/restore support\n# Bridge mode recommended for development and multi-instance deployments\n\n# PostgreSQL connection details\nPGHOST=127.0.0.1\nPGUSER=postgres\nPGPASSWORD=mysecretpassword\nDBNAME=sysbench_test\n\n# Sysbench configuration\n# THREADS - automatically set to CPU core count (max 8) in postgres.sh\nTABLES=8\nTABLE_SIZE=1000000"},{"name":"README.md","path":"postgresql/README.md","type":"markdown","content":"# PostgreSQL Template\n\nHigh-performance PostgreSQL setup with benchmarking and automated configuration.\n\n## Features\n- Auto-detected container and dynamic port assignment\n- CPU-optimized threading (auto-detects cores, max 8)\n- Sysbench integration for OLTP performance testing\n- Bulk data generation for custom tables\n- One-command host setup for required tools\n\n## Usage\n```bash\nsource Rediaccfile\nprep  # Pull images and create directories\nup    # Start PostgreSQL\ndown  # Stop and cleanup\n```\n\n### Benchmarking\n```bash\n# Install sysbench and PostgreSQL client\n./postgres.sh host_setup\n\n# Initialize database and run benchmarks\nsource ./postgres.sh\n./postgres.sh create_database\n./postgres.sh initialize_sysbench    # Load 8×1M tables\n./postgres.sh benchmark_qps          # Run QPS test\n./postgres.sh cleanup_sysbench       # Remove test data\n```\n\n## Configuration\nEdit `.env` to customize:\n- `PGUSER`: PostgreSQL username (default: postgres)\n- `PGPASSWORD`: Database password (default: mysecretpassword)\n- `DBNAME`: Database name for benchmarks (default: sysbench_test)\n- `TABLES`: Number of sysbench tables (default: 8)\n- `TABLE_SIZE`: Rows per sysbench table (default: 1000000)\n\nContainer name and port are auto-detected. Threads auto-set to CPU cores (max 8).\n\n## Access\n- **Port**: 5432 (Docker auto-assigns host port)\n- **Credentials**: Check `.env` file\n- **Find assigned port**: `docker compose ps`\n- **Connect**: `psql -h 127.0.0.1 -p <host-port> -U postgres`\n\n## Resources\n- [Official Docker Hub](https://hub.docker.com/_/postgres)\n- [PostgreSQL Documentation](https://www.postgresql.org/docs/)\n- [Sysbench Documentation](https://github.com/akopytov/sysbench)"},{"name":"Rediaccfile","path":"postgresql/Rediaccfile","type":"text","content":"#!/bin/bash\n\n# === Renet Compose Support ===\n_use_renet() {\n  [[ -n \"$REPOSITORY_NETWORK_ID\" ]] && command -v renet &>/dev/null\n}\n_compose() {\n  if _use_renet; then\n    renet compose --network-id \"$REPOSITORY_NETWORK_ID\" -- \"$@\"\n  else\n    docker compose \"$@\"\n  fi\n}\n\nprep() {\n  docker pull postgres\n  mkdir -p data\n  return $?\n}\n\nup() {\n  _compose up -d\n  return $?\n}\n\ndown() {\n  _compose down -v\n  return $?\n}"},{"name":"docker-compose.yaml","path":"postgresql/docker-compose.yaml","type":"yaml","content":"services:\n  db:\n    container_name: postgres_sysbench_template\n    network_mode: \"${NETWORK_MODE:-bridge}\"\n    env_file:\n      - .env\n    environment:\n      - POSTGRES_PASSWORD=${PGPASSWORD}\n      - PGDATA=/pgdata\n    ports:\n      - \"5432\"\n    volumes:\n      - ./data:/pgdata\n    tmpfs:\n      - /var/lib/postgresql\n    image: postgres\n    healthcheck:\n      test: [\"CMD-SHELL\", \"pg_isready -U $${POSTGRES_USER:-postgres}\"]\n      interval: 10s\n      timeout: 5s\n      retries: 5\n      start_period: 30s"},{"name":"postgres.sh","path":"postgresql/postgres.sh","type":"script","content":"#!/bin/bash\nset -e\n\n# Load environment variables from .env file\nif [ -f .env ]; then\n    export $(cat .env | grep -v '^#' | xargs)\nfi\n\n# Set THREADS to CPU core count but cap at 8\nif [ -z \"$THREADS\" ]; then\n    THREADS=$(($(nproc) > 8 ? 8 : $(nproc)))\nfi\n\n# Detect container name from docker compose\nCONTAINER_NAME=$(docker inspect $(docker compose ps -q db) --format '{{.Name}}' 2>/dev/null | sed 's/^\\/*//')\n\n# Extract the Docker-assigned port\nPGPORT=$(docker port \"$CONTAINER_NAME\" 5432 2>/dev/null | cut -d: -f2)\n\n# Fallback to default port if container is not running\n: \"${PGPORT:=5432}\"\n\nexport PGHOST PGPORT PGUSER PGPASSWORD\n\n# Function to install required packages for PostgreSQL sysbench testing\nhost_setup() {\n    echo \"Installing required packages for PostgreSQL sysbench testing...\"\n\n    # Update package list\n    sudo apt-get update\n\n    # Install PostgreSQL client tools\n    sudo apt-get install -y postgresql-client\n\n    # Install sysbench\n    sudo apt-get install -y sysbench\n\n    # Verify installations\n    echo \"Checking installed versions:\"\n    psql --version\n    sysbench --version\n\n    echo \"Host setup completed successfully!\"\n    return $?\n}\n\n# Function to execute PostgreSQL commands using psql\npg_exec() {\n    psql -h \"$PGHOST\" -p \"$PGPORT\" -U \"$PGUSER\" -d \"$DBNAME\" -c \"$1\"\n}\n\n# Function to check and create database if it does not exist\ncreate_database() {\n    if ! pg_exec \"SELECT 1 FROM pg_database WHERE datname = '$DBNAME'\" | grep -q 1; then\n        echo \"Database $DBNAME does not exist. Creating...\"\n        psql -h \"$PGHOST\" -p \"$PGPORT\" -U \"$PGUSER\" -c \"CREATE DATABASE $DBNAME\"\n    else\n        echo \"Database $DBNAME already exists, not creating.\"\n    fi\n}\n\n# Function to prepare the database for sysbench\ninitialize_sysbench() {\n    sysbench /usr/share/sysbench/oltp_write_only.lua --db-driver=pgsql \\\n        --pgsql-host=$PGHOST --pgsql-port=$PGPORT --pgsql-user=$PGUSER --pgsql-password=$PGPASSWORD \\\n        --pgsql-db=$DBNAME --threads=$THREADS --tables=$TABLES --table-size=$TABLE_SIZE prepare\n}\n\n# Benchmark Query Per Second (QPS)\nbenchmark_qps() {\n    echo \"Starting Query Per Second (QPS) benchmark...\"\n    sysbench /usr/share/sysbench/oltp_point_select.lua --db-driver=pgsql \\\n        --pgsql-host=\"$PGHOST\" --pgsql-port=$PGPORT --pgsql-user=\"$PGUSER\" --pgsql-password=\"$PGPASSWORD\" \\\n        --pgsql-db=\"$DBNAME\" --threads=\"$THREADS\" --tables=\"$TABLES\" --table-size=\"$TABLE_SIZE\" \\\n        --time=60 --report-interval=10 run\n}\n\n# Cleanup the database from sysbench\ncleanup_sysbench() {\n    sysbench /usr/share/sysbench/oltp_write_only.lua --db-driver=pgsql \\\n        --pgsql-host=$PGHOST --pgsql-port=$PGPORT --pgsql-user=$PGUSER --pgsql-password=$PGPASSWORD \\\n        --pgsql-db=$DBNAME --threads=$THREADS --tables=$TABLES --table-size=$TABLE_SIZE cleanup\n}"}],"readme":"# PostgreSQL Template\n\nHigh-performance PostgreSQL setup with benchmarking and automated configuration.\n\n## Features\n- Auto-detected container and dynamic port assignment\n- CPU-optimized threading (auto-detects cores, max 8)\n- Sysbench integration for OLTP performance testing\n- Bulk data generation for custom tables\n- One-command host setup for required tools\n\n## Usage\n```bash\nsource Rediaccfile\nprep  # Pull images and create directories\nup    # Start PostgreSQL\ndown  # Stop and cleanup\n```\n\n### Benchmarking\n```bash\n# Install sysbench and PostgreSQL client\n./postgres.sh host_setup\n\n# Initialize database and run benchmarks\nsource ./postgres.sh\n./postgres.sh create_database\n./postgres.sh initialize_sysbench    # Load 8×1M tables\n./postgres.sh benchmark_qps          # Run QPS test\n./postgres.sh cleanup_sysbench       # Remove test data\n```\n\n## Configuration\nEdit `.env` to customize:\n- `PGUSER`: PostgreSQL username (default: postgres)\n- `PGPASSWORD`: Database password (default: mysecretpassword)\n- `DBNAME`: Database name for benchmarks (default: sysbench_test)\n- `TABLES`: Number of sysbench tables (default: 8)\n- `TABLE_SIZE`: Rows per sysbench table (default: 1000000)\n\nContainer name and port are auto-detected. Threads auto-set to CPU cores (max 8).\n\n## Access\n- **Port**: 5432 (Docker auto-assigns host port)\n- **Credentials**: Check `.env` file\n- **Find assigned port**: `docker compose ps`\n- **Connect**: `psql -h 127.0.0.1 -p <host-port> -U postgres`\n\n## Resources\n- [Official Docker Hub](https://hub.docker.com/_/postgres)\n- [PostgreSQL Documentation](https://www.postgresql.org/docs/)\n- [Sysbench Documentation](https://github.com/akopytov/sysbench)","generated":"2026-01-16T09:43:38Z"}
