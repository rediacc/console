---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Hero from '../../components/Hero';
import Problem from '../../components/Problem';
import Solutions from '../../components/Solutions';
import Testimonials from '../../components/Testimonials';
import { createTranslator } from '../../i18n/utils';
import { getLanguagePaths } from '../../i18n/language-utils';
import type { Language } from '../../i18n/types';
import { EXTERNAL_LINKS } from '../../config/constants';
import '../../styles/pricing-page.css';

export const getStaticPaths = getLanguagePaths;

const { lang } = Astro.params as { lang: Language };
const { t, ta, to } = createTranslator(lang);

const priceFormatter = new Intl.NumberFormat(lang === 'en' ? 'en-US' : lang, {
  style: 'currency',
  currency: 'USD',
  maximumFractionDigits: 0,
});
const formatPrice = (amount: number) => priceFormatter.format(amount);

const technicalMetrics = ta('pages.pricing.technicalSummary.metrics');
const technicalValues = to('pages.pricing.technicalSummary.values');

const plans = [
  { id: 'community', monthly: 0, yearly: 0, featured: true },
  { id: 'professional', monthly: 349, yearly: 3490 },
  { id: 'business', monthly: 699, yearly: 6990 },
  { id: 'enterprise', monthly: 2100, yearly: 21000 },
];
---

<BaseLayout
  lang={lang}
  title={t('pages.home.meta.title')}
  description={t('pages.home.meta.description')}
  keywords={t('pages.home.meta.keywords')}
  ogType="website"
  structuredDataType="organization"
>
  <Hero client:idle lang={lang} origin={Astro.url.origin} />
  <Problem client:visible lang={lang} />

  <!-- Bridge: narrative transition from pain to solution -->
  <div class="section-bridge" aria-hidden="true">
    <p class="bridge-text">{t('bridge.text')}</p>
    <svg class="bridge-chevron" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </div>

  <Solutions client:visible lang={lang} />
  <Testimonials client:visible lang={lang} />

  <!-- Pricing Section -->
  <section id="pricing" class="cf-pricing-section">
    <div class="cf-pricing-container">
      <div class="pricing-section-header">
        <h2>{t('pages.pricing.hero.title')}</h2>
        <p>{t('pages.pricing.hero.subtitle')}</p>
      </div>
      <div class="cf-pricing-grid">
        {plans.map(plan => (
          <div class:list={['cf-pricing-card', { 'cf-featured': plan.featured }]}>
            <h3 class="cf-plan-name">{t(`pages.pricing.plans.${plan.id}.name`)}</h3>
            <div class="cf-price-block">
              {plan.monthly === 0 ? (
                <span class="cf-price">{formatPrice(0)}</span>
              ) : (
                <>
                  <div class="cf-price-line">
                    <span class="cf-price">{formatPrice(plan.monthly)}</span>
                    <span class="cf-price-period">/mo</span>
                  </div>
                </>
              )}
            </div>
            <ul class="cf-features">
              {technicalMetrics.map((metric: any) => (
                <li>
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                  </svg>
                  <span><strong>{technicalValues?.[plan.id]?.[metric.key] ?? '—'}</strong> {metric.label}</span>
                </li>
              ))}
            </ul>
            <a
              href={EXTERNAL_LINKS.SCHEDULE_CONSULTATION}
              target="_blank"
              rel="noopener noreferrer"
              class:list={['cf-cta-btn', { 'cf-cta-featured': plan.featured }]}
            >
              {plan.monthly === 0 ? t('pages.pricing.ui.cta.community.primary') : t('pages.pricing.ui.cta.professional.primary')}
            </a>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Success/Error Messages -->
  <div class="message-overlay" id="message-overlay" role="dialog" aria-hidden="true">
    <div class="message-content">
      <div class="message-icon" id="message-icon"></div>
      <p class="message-title" id="message-title" aria-label={t('common.aria.statusMessage')}><strong></strong></p>
      <p class="message-text" id="message-text"></p>
      <button class="btn btn-secondary" id="message-close">{t('common.buttons.close')}</button>
    </div>
  </div>

  <!-- Image Modal -->
  <div class="image-modal" id="image-modal" role="dialog" aria-hidden="true" aria-modal="true" aria-label={t('common.aria.imageViewer')}>
    <div class="image-modal-content" id="image-modal-content">
      <button class="image-modal-close" id="image-modal-close-btn" aria-label={t('common.aria.closeImageModal')}>&times;</button>
      <button class="nav-btn nav-prev" id="image-modal-prev-btn" aria-label={t('common.aria.previousImage')}>‹</button>
      <button class="nav-btn nav-next" id="image-modal-next-btn" aria-label={t('common.aria.nextImage')}>›</button>
      <div class="zoom-controls">
        <button class="zoom-btn zoom-in" id="image-modal-zoom-in-btn" aria-label={t('common.aria.zoomIn')}>+</button>
        <button class="zoom-btn zoom-out" id="image-modal-zoom-out-btn" aria-label={t('common.aria.zoomOut')}>−</button>
        <button class="zoom-btn zoom-reset" id="image-modal-zoom-reset-btn" aria-label={t('common.aria.resetZoom')}>⌂</button>
      </div>
      <div class="image-container">
        <img id="modal-image" src="" alt="" class="modal-image" loading="lazy" decoding="async">
      </div>
      <div class="image-indicator">
        <span class="indicator-text" id="image-indicator">1 / 2</span>
      </div>
    </div>
  </div>
</BaseLayout>
