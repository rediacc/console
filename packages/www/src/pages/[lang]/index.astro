---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Hero from '../../components/Hero';
import Problem from '../../components/Problem';
import Solutions from '../../components/Solutions';
import Testimonials from '../../components/Testimonials';
import { createTranslator } from '../../i18n/utils';
import { getLanguagePaths } from '../../i18n/language-utils';
import type { Language } from '../../i18n/types';
import { EXTERNAL_LINKS } from '../../config/constants';
import { PLAN_ORDER, PLAN_PRICING, PLAN_METADATA } from '@rediacc/shared/subscription';
import '../../styles/pricing-page.css';

export const getStaticPaths = getLanguagePaths;

const { lang } = Astro.params as { lang: Language };
const { t, ta, to } = createTranslator(lang);

const priceFormatter = new Intl.NumberFormat(lang === 'en' ? 'en-US' : lang, {
  style: 'currency',
  currency: 'USD',
  maximumFractionDigits: 0,
});
const formatPrice = (amount: number) => priceFormatter.format(amount);

const calculateSavings = (monthlyPrice: number, yearlyPrice: number) => {
  const fullPrice = monthlyPrice * 12;
  const savings = fullPrice - yearlyPrice;
  const roundedSavings = Math.ceil(savings / 100) * 100;
  const percentage = Math.round((savings / fullPrice) * 100);
  return `Save $${roundedSavings.toLocaleString()} (${percentage}% off)`;
};

const technicalMetrics = ta('pages.pricing.technicalSummary.metrics');
const technicalValues = to('pages.pricing.technicalSummary.values');

const plans = PLAN_ORDER.map((code) => ({
  id: code.toLowerCase(),
  monthly: PLAN_PRICING[code].monthlyPriceCents / 100,
  yearly: PLAN_PRICING[code].annualPriceCents / 100,
  featured: PLAN_METADATA[code].featured,
}));
---

<BaseLayout
  lang={lang}
  title={t('pages.home.meta.title')}
  description={t('pages.home.meta.description')}
  keywords={t('pages.home.meta.keywords')}
  ogType="website"
  structuredDataType="organization"
>
  <Hero client:idle lang={lang} origin={Astro.url.origin} />
  <Problem client:visible lang={lang} />

  <!-- Bridge: narrative transition from pain to solution -->
  <div class="section-bridge" aria-hidden="true">
    <p class="bridge-text">{t('bridge.text')}</p>
    <svg class="bridge-chevron" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </div>

  <Solutions client:visible lang={lang} />
  <Testimonials client:visible lang={lang} />

  <!-- Pricing Section -->
  <section id="pricing" class="cf-pricing-section">
    <div class="cf-pricing-container">
      <div class="pricing-section-header">
        <h2>{t('pages.pricing.hero.title')}</h2>
        <p>{t('pages.pricing.hero.subtitle')}</p>
      </div>
      <div class="billing-toggle" role="radiogroup" aria-label="Billing period">
        <button class="billing-toggle-btn active" role="radio" aria-checked="true" data-period="monthly">
          {t('pages.pricing.ui.billingToggle.monthly')}
        </button>
        <button class="billing-toggle-btn" role="radio" aria-checked="false" data-period="annual">
          {t('pages.pricing.ui.billingToggle.annual')}
        </button>
      </div>
      <div class="cf-pricing-grid">
        {plans.map(plan => (
          <div class:list={['cf-pricing-card', { 'cf-featured': plan.featured }]} data-monthly={plan.monthly} data-yearly={plan.yearly}>
            <h3 class="cf-plan-name">{t(`pages.pricing.plans.${plan.id}.name`)}</h3>
            <div class="cf-price-block">
              {plan.monthly === 0 ? (
                <>
                  <span class="cf-price" data-price>{formatPrice(0)}</span>
                  <div class="cf-price-subtitle">{t('pages.pricing.ui.foreverFree')}</div>
                </>
              ) : (
                <>
                  <div class="cf-price-line">
                    <span class="cf-price" data-price>{formatPrice(plan.monthly)}</span>
                    <span class="cf-price-period" data-period-label>/mo</span>
                  </div>
                  <div class="cf-savings-badge savings-badge" data-savings>{calculateSavings(plan.monthly, plan.yearly)}</div>
                </>
              )}
            </div>
            <ul class="cf-features">
              {technicalMetrics.map((metric: any) => (
                <li>
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                  </svg>
                  <span><strong>{technicalValues?.[plan.id]?.[metric.key] ?? '—'}</strong> {metric.label}</span>
                </li>
              ))}
            </ul>
            {plan.monthly === 0 ? (
              <a
                href={`/${lang}/install`}
                class:list={['cf-cta-btn', { 'cf-cta-featured': plan.featured }]}
              >
                {t('pages.pricing.ui.cta.community.primary')}
              </a>
            ) : plan.id === 'enterprise' ? (
              <a
                href={EXTERNAL_LINKS.SCHEDULE_CONSULTATION}
                target="_blank"
                rel="noopener noreferrer"
                class="cf-cta-btn"
              >
                {t('pages.pricing.ui.cta.enterprise.primary')}
              </a>
            ) : (
              <button
                type="button"
                class="cf-cta-btn"
                data-checkout={plan.id}
              >
                {t(`pages.pricing.ui.cta.${plan.id}.primary`)}
              </button>
            )}
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Success/Error Messages -->
  <div class="message-overlay" id="message-overlay" role="dialog" aria-hidden="true">
    <div class="message-content">
      <div class="message-icon" id="message-icon"></div>
      <p class="message-title" id="message-title" aria-label={t('common.aria.statusMessage')}><strong></strong></p>
      <p class="message-text" id="message-text"></p>
      <button class="btn btn-secondary" id="message-close">{t('common.buttons.close')}</button>
    </div>
  </div>

  <!-- Image Modal -->
  <div class="image-modal" id="image-modal" role="dialog" aria-hidden="true" aria-modal="true" aria-label={t('common.aria.imageViewer')}>
    <div class="image-modal-content" id="image-modal-content">
      <button class="image-modal-close" id="image-modal-close-btn" aria-label={t('common.aria.closeImageModal')}>&times;</button>
      <button class="nav-btn nav-prev" id="image-modal-prev-btn" aria-label={t('common.aria.previousImage')}>‹</button>
      <button class="nav-btn nav-next" id="image-modal-next-btn" aria-label={t('common.aria.nextImage')}>›</button>
      <div class="zoom-controls">
        <button class="zoom-btn zoom-in" id="image-modal-zoom-in-btn" aria-label={t('common.aria.zoomIn')}>+</button>
        <button class="zoom-btn zoom-out" id="image-modal-zoom-out-btn" aria-label={t('common.aria.zoomOut')}>−</button>
        <button class="zoom-btn zoom-reset" id="image-modal-zoom-reset-btn" aria-label={t('common.aria.resetZoom')}>⌂</button>
      </div>
      <div class="image-container">
        <img id="modal-image" src="" alt="" class="modal-image" loading="lazy" decoding="async">
      </div>
      <div class="image-indicator">
        <span class="indicator-text" id="image-indicator">1 / 2</span>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const toggle = document.querySelector('.billing-toggle');
      if (!toggle) return;

      const buttons = toggle.querySelectorAll('.billing-toggle-btn');
      const cards = document.querySelectorAll('.cf-pricing-card');

      const lang = document.documentElement.lang;
      const formatter = new Intl.NumberFormat(lang === 'en' ? 'en-US' : lang, {
        style: 'currency',
        currency: 'USD',
        maximumFractionDigits: 0,
      });

      function updatePricing(period: string) {
        cards.forEach((card) => {
          const monthly = Number((card as HTMLElement).dataset.monthly);
          const yearly = Number((card as HTMLElement).dataset.yearly);
          if (monthly === 0) return;

          const priceEl = card.querySelector('[data-price]');
          const periodEl = card.querySelector('[data-period-label]');
          const savingsEl = card.querySelector('[data-savings]') as HTMLElement | null;

          if (period === 'annual') {
            if (priceEl) priceEl.textContent = formatter.format(yearly);
            if (periodEl) periodEl.textContent = '/yr';
            if (savingsEl) savingsEl.classList.add('visible');
          } else {
            if (priceEl) priceEl.textContent = formatter.format(monthly);
            if (periodEl) periodEl.textContent = '/mo';
            if (savingsEl) savingsEl.classList.remove('visible');
          }
        });
      }

      buttons.forEach((btn) => {
        btn.addEventListener('click', () => {
          buttons.forEach((b) => {
            b.classList.remove('active');
            b.setAttribute('aria-checked', 'false');
          });
          btn.classList.add('active');
          btn.setAttribute('aria-checked', 'true');
          updatePricing((btn as HTMLElement).dataset.period!);
        });
      });

      // Stripe Checkout handlers
      const checkoutButtons = document.querySelectorAll<HTMLButtonElement>('[data-checkout]');

      // Same-origin: www worker proxies /account/api/* to account-server via Service Binding
      const accountServerUrl = `${window.location.origin}/account`;

      // Message overlay close handler
      const messageClose = document.getElementById('message-close');
      const messageOverlay = document.getElementById('message-overlay');
      if (messageClose && messageOverlay) {
        messageClose.addEventListener('click', () => {
          messageOverlay.setAttribute('aria-hidden', 'true');
        });
      }

      checkoutButtons.forEach((btn) => {
        const originalText = btn.textContent;
        btn.addEventListener('click', async () => {
          const planId = btn.dataset.checkout!;
          const activeToggle = document.querySelector('.billing-toggle-btn.active') as HTMLElement | null;
          const billingPeriod = activeToggle?.dataset.period === 'annual' ? 'annual' : 'monthly';

          btn.disabled = true;
          btn.textContent = '...';

          try {
            const response = await fetch(`${accountServerUrl}/api/v1/checkout`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                planCode: planId.toUpperCase(),
                billingPeriod,
                successUrl: `${window.location.origin}/${document.documentElement.lang}/checkout/success`,
                cancelUrl: window.location.href,
              }),
            });

            if (!response.ok) throw new Error('Checkout failed');

            const { url } = await response.json();
            if (url) window.location.href = url;
          } catch {
            btn.disabled = false;
            btn.textContent = originalText;
            const overlay = document.getElementById('message-overlay');
            const titleEl = document.querySelector('#message-title strong');
            const textEl = document.getElementById('message-text');
            if (overlay && titleEl && textEl) {
              titleEl.textContent = 'Checkout Error';
              textEl.textContent = 'Something went wrong. Please try again or contact support.';
              overlay.setAttribute('aria-hidden', 'false');
            }
          }
        });
      });
    });
  </script>
</BaseLayout>
