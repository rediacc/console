---
import { getCollection } from 'astro:content';
import ContentLayout from '../../../layouts/ContentLayout.astro';
import StructuredData from '../../../components/StructuredData.astro';
import { DEFAULT_LANGUAGE } from '../../../i18n/language-utils';
import type { Language } from '../../../i18n/types';
import { getBaseSlug } from '../../../utils/slug';
import { SITE_URL } from '../../../config/constants';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  const paths = [];

  for (const post of posts) {
    const lang = (post.data.language || DEFAULT_LANGUAGE) as Language;
    const baseSlug = getBaseSlug(post.slug);

    // Find all translations of this post (match by base slug)
    const translations = posts
      .filter((p) => getBaseSlug(p.slug) === baseSlug)
      .map((p) => ({
        lang: (p.data.language || DEFAULT_LANGUAGE) as Language,
        url: `/${p.data.language || DEFAULT_LANGUAGE}/blog/${baseSlug}`,
      }));

    paths.push({
      params: { lang, slug: baseSlug },
      props: { post, translations },
    });
  }

  return paths;
}

const { post, translations } = Astro.props as {
  post: any;
  translations: Array<{ lang: Language; url: string }>;
};

const { Content } = await post.render();
const currentLang = (post.data.language || DEFAULT_LANGUAGE) as Language;

const baseSlug = getBaseSlug(post.slug);

// Check if this is a fallback (English content shown for Spanish request)
const isFallback = Astro.params.lang !== currentLang;
---

<ContentLayout
  frontmatter={post.data}
  url={`/${Astro.params.lang}/blog/${baseSlug}`}
  currentLang={Astro.params.lang as Language}
  availableLanguages={translations}
  showFallbackNotice={isFallback}
>
  <Fragment slot="head">
    <StructuredData
      type="blogposting"
      data={{
        title: post.data.title,
        description: post.data.description,
        author: post.data.author,
        publishedDate: post.data.publishedDate.toISOString(),
        updatedDate: post.data.updatedDate?.toISOString(),
        image: post.data.image,
        url: `${SITE_URL}/${Astro.params.lang}/blog/${baseSlug}`,
        language: currentLang,
        tags: post.data.tags,
        category: post.data.category
      }}
    />
  </Fragment>
  <Content />
</ContentLayout>
