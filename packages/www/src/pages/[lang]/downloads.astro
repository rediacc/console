---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { createTranslator } from '../../i18n/utils';
import { getLanguagePaths } from '../../i18n/language-utils';
import type { Language } from '../../i18n/types';
import { GITHUB_REPO } from '../../config/constants';
import { parseGitHubRelease, type ReleaseData } from '../../utils/release-parser';
import DownloadsList from '../../components/DownloadsList';
import '../../styles/downloads-page.css';

export const getStaticPaths = getLanguagePaths;

const { lang } = Astro.params as { lang: Language };
const { t } = createTranslator(lang);

// Fetch release data at build time
let releaseData: ReleaseData | null = null;
try {
  const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/releases/latest`);
  if (response.ok) {
    const release = await response.json();
    releaseData = parseGitHubRelease(release, lang);
  }
} catch (error) {
  if (import.meta.env.DEV) {
    console.error('Failed to fetch GitHub release:', error);
  }
}
---

<BaseLayout
  lang={lang}
  title={t('pages.downloads.meta.title')}
  description={t('pages.downloads.meta.description')}
  keywords={t('pages.downloads.meta.keywords')}
  ogType="website"
  structuredDataType="organization"
>
  <article class="downloads-page">
    <!-- Hero Section -->
    <section class="downloads-hero section-dark">
      <div class="downloads-hero-content">
        <h1>{t('pages.downloads.hero.title')}</h1>
        {releaseData && (
          <p class="hero-subtitle">
            {t('pages.downloads.hero.subtitle')} <strong>v{releaseData.version}</strong>
          </p>
          <p class="hero-release-date">
            {t('pages.downloads.hero.released')}: {releaseData.publishedAt}
          </p>
        )}
      </div>
    </section>

    <!-- Downloads Section -->
    <section class="downloads-content section-light">
      <div class="container">
        <DownloadsList client:visible lang={lang} releaseData={releaseData} />
      </div>
    </section>

    <!-- Auto-Update Information -->
    <section class="auto-update-section section-dark">
      <div class="container">
        <h2>{t('pages.downloads.autoUpdate.title')}</h2>
        <p class="auto-update-description">{t('pages.downloads.autoUpdate.description')}</p>
      </div>
    </section>

    <!-- Installation Instructions -->
    <section class="installation-section section-light">
      <div class="container">
        <h2>{t('pages.downloads.installation.title')}</h2>

        <details class="installation-details">
          <summary>{t('pages.downloads.platforms.windows')}</summary>
          <p>{t('pages.downloads.installation.windows')}</p>
        </details>

        <details class="installation-details">
          <summary>{t('pages.downloads.platforms.macos')}</summary>
          <p>{t('pages.downloads.installation.macos')}</p>
        </details>

        <details class="installation-details">
          <summary>{t('pages.downloads.platforms.linux')} - AppImage</summary>
          <p>{t('pages.downloads.installation.linux_appimage')}</p>
        </details>

        <details class="installation-details">
          <summary>{t('pages.downloads.platforms.linux')} - DEB</summary>
          <p>{t('pages.downloads.installation.linux_deb')}</p>
        </details>

        <details class="installation-details">
          <summary>{t('pages.downloads.sections.cli')}</summary>
          <p>{t('pages.downloads.installation.cli')}</p>
        </details>
      </div>
    </section>

    <!-- System Requirements -->
    <section class="requirements-section section-light">
      <div class="container">
        <h2>{t('pages.downloads.requirements.title')}</h2>

        <div class="requirements-grid">
          <div class="requirement-card">
            <h3>{t('pages.downloads.platforms.windows')}</h3>
            <p>{t('pages.downloads.requirements.windows')}</p>
          </div>

          <div class="requirement-card">
            <h3>{t('pages.downloads.platforms.macos')}</h3>
            <p>{t('pages.downloads.requirements.macos')}</p>
          </div>

          <div class="requirement-card">
            <h3>{t('pages.downloads.platforms.linux')}</h3>
            <p>{t('pages.downloads.requirements.linux')}</p>
          </div>

          <div class="requirement-card">
            <h3>{t('pages.downloads.requirements.diskTitle')}</h3>
            <p>{t('pages.downloads.requirements.disk')}</p>
          </div>

          <div class="requirement-card">
            <h3>{t('pages.downloads.requirements.ramTitle')}</h3>
            <p>{t('pages.downloads.requirements.ram')}</p>
          </div>
        </div>
      </div>
    </section>
  </article>

</BaseLayout>
