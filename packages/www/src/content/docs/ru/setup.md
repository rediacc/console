---
title: "Настройка машины"
description: "Создание конфигурации, добавление машин, подготовка серверов и настройка инфраструктуры."
category: "Guides"
order: 3
language: ru
sourceHash: "0c725f9eb65e6c0f"
---

# Настройка машины

На этой странице описывается процесс настройки первой машины: создание конфигурации, регистрация сервера, его подготовка и опциональная настройка инфраструктуры для публичного доступа.

## Шаг 1: Создание конфигурации

**Конфигурация** — это именованный файл конфигурации, хранящий ваши SSH-учетные данные, определения машин и привязки репозиториев. Воспринимайте его как рабочее пространство проекта.

```bash
rdc config init my-infra --ssh-key ~/.ssh/id_ed25519
```

| Опция | Обязательно | Описание |
|-------|-------------|----------|
| `--ssh-key <path>` | Да | Путь к вашему приватному SSH-ключу. Тильда (`~`) раскрывается автоматически. |
| `--renet-path <path>` | Нет | Пользовательский путь к бинарному файлу renet на удаленных машинах. По умолчанию используется стандартное расположение установки. |

Эта команда создает конфигурацию с именем `my-infra` и сохраняет её в `~/.config/rediacc/my-infra.json`. Конфигурация по умолчанию (без указания имени) хранится как `~/.config/rediacc/rediacc.json`.

> Вы можете иметь несколько конфигураций (например, `production`, `staging`, `dev`). Переключайтесь между ними с помощью флага `--config` в любой команде.

## Шаг 2: Добавление машины

Зарегистрируйте ваш удаленный сервер как машину в конфигурации:

```bash
rdc config add-machine server-1 --ip 203.0.113.50 --user deploy
```

| Опция | Обязательно | По умолчанию | Описание |
|-------|-------------|--------------|----------|
| `--ip <address>` | Да | - | IP-адрес или имя хоста удаленного сервера |
| `--user <username>` | Да | - | Имя пользователя SSH на удаленном сервере |
| `--port <port>` | Нет | `22` | Порт SSH |
| `--datastore <path>` | Нет | `/mnt/rediacc` | Путь на сервере, где Rediacc хранит зашифрованные репозитории |

После добавления машины rdc автоматически выполняет `ssh-keyscan` для получения ключей хоста сервера. Вы также можете выполнить это вручную:

```bash
rdc config scan-keys server-1
```

Для просмотра всех зарегистрированных машин:

```bash
rdc config machines
```

## Шаг 3: Настройка машины

Подготовьте удаленный сервер, установив все необходимые зависимости:

```bash
rdc config setup-machine server-1
```

Эта команда:
1. Загружает бинарный файл renet на сервер через SFTP
2. Устанавливает Docker, containerd и cryptsetup (если отсутствуют)
3. Создает системного пользователя `rediacc` (UID 7111)
4. Создает директорию хранилища данных и подготавливает её для зашифрованных репозиториев

| Опция | Обязательно | По умолчанию | Описание |
|-------|-------------|--------------|----------|
| `--datastore <path>` | Нет | `/mnt/rediacc` | Директория хранилища данных на сервере |
| `--datastore-size <size>` | Нет | `95%` | Какую долю доступного диска выделить для хранилища данных |
| `--debug` | Нет | `false` | Включить подробный вывод для диагностики |

> Настройку нужно выполнить только один раз для каждой машины. Повторный запуск безопасен при необходимости.

## Управление ключами хоста

Если SSH-ключи хоста сервера изменились (например, после переустановки), обновите сохраненные ключи:

```bash
rdc config scan-keys server-1
```

Эта команда обновляет поле `knownHosts` в вашей конфигурации для данной машины.

## Проверка SSH-подключения

После добавления машины убедитесь, что она доступна:

```bash
rdc term server-1 -c "hostname"
```

Открывает SSH-подключение к машине и выполняет команду. Если всё прошло успешно, ваша конфигурация SSH верна.

Для более подробной диагностики выполните:

```bash
rdc doctor
```

> **Только для облачного адаптера**: команда `rdc machine test-connection` обеспечивает детальную диагностику SSH, но требует облачного адаптера. Для локального адаптера используйте `rdc term` или `ssh` напрямую.

## Настройка инфраструктуры

Для машин, которым необходимо обслуживать публичный трафик, настройте параметры инфраструктуры:

### Установка инфраструктуры

```bash
rdc config set-infra server-1 \
  --public-ipv4 203.0.113.50 \
  --base-domain example.com \
  --cert-email admin@example.com \
  --cf-dns-token your-cloudflare-api-token
```

| Опция | Описание |
|-------|----------|
| `--public-ipv4 <ip>` | Публичный IPv4-адрес для внешнего доступа |
| `--public-ipv6 <ip>` | Публичный IPv6-адрес для внешнего доступа |
| `--base-domain <domain>` | Базовый домен для приложений (например, `example.com`) |
| `--cert-email <email>` | Email для TLS-сертификатов Let's Encrypt |
| `--cf-dns-token <token>` | API-токен Cloudflare DNS для ACME DNS-01 проверок |
| `--tcp-ports <ports>` | Дополнительные TCP-порты для проброса через запятую (например, `25,143,465,587,993`) |
| `--udp-ports <ports>` | Дополнительные UDP-порты для проброса через запятую (например, `53`) |

### Просмотр инфраструктуры

```bash
rdc config show-infra server-1
```

### Применение на сервере

Сгенерируйте и разверните конфигурацию обратного прокси Traefik на сервере:

```bash
rdc config push-infra server-1
```

Эта команда применяет конфигурацию прокси на основе ваших настроек инфраструктуры. Traefik обрабатывает TLS-терминацию, маршрутизацию и проброс портов.

## Установка значений по умолчанию

Установите значения по умолчанию, чтобы не указывать их в каждой команде:

```bash
rdc config set machine server-1    # Машина по умолчанию
rdc config set team my-team        # Команда по умолчанию (облачный адаптер, экспериментальный)
```

После установки машины по умолчанию можно опускать `-m server-1` в командах:

```bash
rdc repo create my-app --size 10G   # Используется машина по умолчанию
```

## Несколько конфигураций

Управляйте несколькими средами с помощью именованных конфигураций:

```bash
# Создание отдельных конфигураций
rdc config init production --ssh-key ~/.ssh/id_prod
rdc config init staging --ssh-key ~/.ssh/id_staging

# Использование определенной конфигурации
rdc repo list -m server-1 --config production
rdc repo list -m staging-1 --config staging
```

Просмотр всех конфигураций:

```bash
rdc config list
```

Просмотр деталей текущей конфигурации:

```bash
rdc config show
```
