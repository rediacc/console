---
title: "После установки"
description: "Настройка автозапуска, структура контекста и устранение неполадок в Rediacc."
category: "Guides"
order: 3
language: ru
---

# После установки

После завершения [Пошагового руководства](/ru/docs/guide) на этой странице рассматриваются настройка автозапуска, описание файла конфигурации контекста и устранение распространенных неполадок.

## Автозапуск при загрузке

По умолчанию репозитории необходимо вручную монтировать и запускать после перезагрузки сервера. **Автозапуск** настраивает репозитории на автоматическое монтирование, запуск Docker и выполнение Rediaccfile `up()` при загрузке сервера.

### Как это работает

При включении автозапуска для репозитория:

1. Генерируется случайный LUKS-ключевой файл размером 256 байт и добавляется в LUKS-слот 1 репозитория (слот 0 остается для пользовательской парольной фразы).
2. Ключевой файл сохраняется по пути `{datastore}/.credentials/keys/{guid}.key` с правами `0600` (только root).
3. Устанавливается systemd-сервис (`rediacc-autostart`), который при загрузке монтирует все включенные репозитории и запускает их сервисы.

При завершении работы или перезагрузке системы сервис корректно останавливает все сервисы (Rediaccfile `down()`), останавливает Docker-демоны и закрывает тома LUKS.

> **Примечание по безопасности:** Включение автозапуска сохраняет LUKS-ключевой файл на диске сервера. Любой пользователь с root-доступом к серверу может смонтировать репозиторий без парольной фразы. Это компромисс между удобством (автоматическая загрузка) и безопасностью (необходимость ручного ввода парольной фразы). Оцените это с учетом вашей модели угроз.

### Включение автозапуска

```bash
rdc repo autostart enable my-app -m server-1
```

Вам будет предложено ввести парольную фразу репозитория. Она необходима для авторизации добавления ключевого файла в том LUKS.

### Включение автозапуска для всех репозиториев

```bash
rdc repo autostart enable-all -m server-1
```

### Отключение автозапуска

```bash
rdc repo autostart disable my-app -m server-1
```

Эта команда удаляет ключевой файл и деактивирует LUKS-слот 1. Репозиторий больше не будет монтироваться автоматически при загрузке.

### Список статусов автозапуска

```bash
rdc repo autostart list -m server-1
```

Показывает, для каких репозиториев включен автозапуск и установлен ли systemd-сервис.

## Описание конфигурации контекста

Вся конфигурация контекста хранится в `~/.rediacc/config.json`. Вот аннотированный пример того, как выглядит этот файл после завершения руководства:

```json
{
  "contexts": {
    "production": {
      "name": "production",
      "mode": "local",
      "apiUrl": "local://",
      "ssh": {
        "privateKeyPath": "/home/you/.ssh/id_ed25519"
      },
      "machines": {
        "prod-1": {
          "ip": "203.0.113.50",
          "user": "deploy",
          "port": 22,
          "datastore": "/mnt/rediacc",
          "knownHosts": "203.0.113.50 ssh-ed25519 AAAA..."
        }
      },
      "repositories": {
        "webapp": {
          "repositoryGuid": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
          "credential": "base64-encoded-random-passphrase",
          "networkId": 2816
        }
      }
    }
  }
}
```

**Ключевые поля:**

| Поле | Описание |
|------|----------|
| `mode` | `"local"` для локального режима, `"s3"` для контекстов с поддержкой S3. |
| `apiUrl` | `"local://"` означает локальный режим (без удаленного API). |
| `ssh.privateKeyPath` | Путь к приватному SSH-ключу, используемому для всех подключений к машинам. |
| `machines.<name>.knownHosts` | SSH-ключи хоста из `ssh-keyscan`, используемые для проверки подлинности сервера. |
| `repositories.<name>.repositoryGuid` | UUID, идентифицирующий зашифрованный образ диска на сервере. |
| `repositories.<name>.credential` | Парольная фраза шифрования LUKS. **Не хранится на сервере.** |
| `repositories.<name>.networkId` | Идентификатор сети, определяющий IP-подсеть (2816 + n*64). Назначается автоматически. |

> Этот файл содержит конфиденциальные данные (пути к SSH-ключам, учетные данные LUKS). Он хранится с правами `0600` (чтение/запись только для владельца). Не делитесь им и не добавляйте в систему контроля версий.

## Устранение неполадок

### Ошибка SSH-подключения

- Убедитесь, что вы можете подключиться вручную: `ssh -i ~/.ssh/id_ed25519 deploy@203.0.113.50`
- Выполните `rdc context scan-keys server-1` для обновления ключей хоста
- Проверьте, что SSH-порт совпадает: `--port 22`

### Ошибка при настройке машины

- Убедитесь, что пользователь имеет доступ sudo без пароля, или настройте `NOPASSWD` для необходимых команд
- Проверьте доступное дисковое пространство на сервере
- Запустите с `--debug` для подробного вывода: `rdc context setup-machine server-1 --debug`

### Ошибка при создании репозитория

- Убедитесь, что настройка была завершена: директория хранилища данных должна существовать
- Проверьте дисковое пространство на сервере
- Убедитесь, что бинарный файл renet установлен (при необходимости повторите настройку)

### Ошибка при запуске сервисов

- Проверьте синтаксис Rediaccfile: он должен быть корректным Bash-скриптом
- Убедитесь, что файлы `docker compose` используют `network_mode: host`
- Проверьте доступность Docker-образов (рассмотрите `docker compose pull` в `prep()`)
- Проверьте логи контейнеров: подключитесь к серверу по SSH и используйте `docker -H unix:///var/run/rediacc/docker-{networkId}.sock logs {container}`

### Ошибки отказа в доступе

- Операции с репозиториями требуют root на сервере (renet запускается через `sudo`)
- Убедитесь, что ваш пользователь входит в группу `sudo`
- Проверьте, что директория хранилища данных имеет правильные разрешения

### Запуск диагностики

Используйте встроенную команду doctor для диагностики проблем:

```bash
rdc doctor
```

Она проверяет вашу среду, установку renet, конфигурацию контекста и статус аутентификации.
