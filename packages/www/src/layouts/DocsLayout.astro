---
import BaseLayout from './BaseLayout.astro';
import DocsSidebar from '../components/DocsSidebar.astro';
import Breadcrumb from '../components/Breadcrumb.astro';
import type { Language } from '../i18n/types';
import { createTranslator } from '../i18n/utils';
import { generateTOCFromHtml } from '../utils/sidebar-behavior';
import '../styles/sidebar-shared.css';
import '../styles/article-content.css';

interface Props {
  frontmatter: {
    title: string;
    description: string;
    category?: string;
  };
  url: string;
  currentLang: Language;
  availableLanguages?: Array<{ lang: Language; url: string }>;
  showFallbackNotice?: boolean;
}

const { frontmatter, url, currentLang, availableLanguages = [], showFallbackNotice } = Astro.props;

// Generate breadcrumbs
const { t } = createTranslator(currentLang);
const breadcrumbItems = [
  {
    name: t('navigation.home'),
    url: `/${currentLang}/`
  },
  {
    name: t('navigation.docs'),
    url: `/${currentLang}/docs/`
  },
  {
    name: frontmatter.title,
    url: url
  }
];

// Generate table of contents from rendered HTML using shared utility
const toc = generateTOCFromHtml(await Astro.slots.render('default'));
---

<BaseLayout
  title={frontmatter.title}
  description={frontmatter.description}
  lang={currentLang}
>
  <div class="docs-layout">
    <DocsSidebar currentLang={currentLang} currentUrl={url} />

    <main class="docs-content">
      <article class="docs-article">
        <Breadcrumb items={breadcrumbItems} />

        {showFallbackNotice && (
          <div class="fallback-notice" role="alert">
            <div class="fallback-notice-icon">ℹ️</div>
            <div class="fallback-notice-content">
              <strong class="fallback-notice-title">{t('pages.docs.fallbackNotice.title')}</strong>
              <p class="fallback-notice-message">{t('pages.docs.fallbackNotice.message')}</p>
            </div>
          </div>
        )}

        <header class="article-header">
          <h1 class="article-title">{frontmatter.title}</h1>

          {frontmatter.description && (
            <p class="article-description">{frontmatter.description}</p>
          )}
        </header>

        <div class="article-content">
          <slot />
        </div>
      </article>
    </main>

    {toc.length > 0 && (
      <aside class="sidebar-base sidebar-toc toc-sidebar">
        <nav class="sidebar-nav sidebar-nav-with-accent toc-nav" role="navigation" aria-label="Table of contents">
          <h3 class="sidebar-title toc-title">{t('pages.docs.tableOfContents')}</h3>
          <ul class="sidebar-list toc-list">
            {toc.map(heading => (
              <li class={`sidebar-item toc-item toc-level-${heading.level}`}>
                <a href={`#${heading.id}`} class="sidebar-link toc-link">{heading.title}</a>
              </li>
            ))}
          </ul>
        </nav>
      </aside>
    )}
  </div>

  <script is:inline>
    // Initialize active state tracking for TOC as user scrolls
    (function() {
      // Prevent multiple initializations
      if (window.rediaccTOCInitialized) return;
      window.rediaccTOCInitialized = true;

      function initTOCActiveState() {
        const container = document.querySelector('.toc-sidebar');
        if (!container) return; // No TOC sidebar on this page

        const headings = document.querySelectorAll('.article-content h2, .article-content h3, .article-content h4');
        if (headings.length === 0) return; // No headings to track

        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            const id = entry.target.id;
            if (!id) return;

            const tocLink = container?.querySelector(`a[href="#${id}"]`);
            if (!tocLink) return;

            if (entry.isIntersecting) {
              // Remove active class from all links
              container?.querySelectorAll('a').forEach(link => {
                link.classList.remove('active');
              });

              // Add active class to current link
              tocLink.classList.add('active');
            }
          });
        }, {
          rootMargin: '-100px 0px -66%'
        });

        // Start observing all headings
        headings.forEach(heading => {
          observer.observe(heading);
        });
      }

      // Initialize on load events
      function init() {
        initTOCActiveState();
      }

      // Astro View Transitions support
      document.addEventListener('astro:page-load', init);

      // Initial load
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>

  <style>
    .docs-layout {
      display: grid;
      grid-template-columns: 250px 1fr 250px;
      gap: var(--space-8);
      max-width: var(--container-xl);
      margin: 0 auto;
      padding: calc(var(--nav-height) + var(--space-8)) var(--space-4) var(--space-8) var(--space-4);
    }


    /* Main Content */
    .docs-content {
      min-width: 0;
    }

    .docs-article {
      max-width: var(--container-md);
      overflow-wrap: break-word;
    }

    /* Fallback Notice */
    .fallback-notice {
      display: flex;
      gap: var(--space-4);
      padding: var(--space-4) var(--space-5);
      margin: var(--space-6) 0;
      background-color: var(--color-info-bg);
      border-inline-start: 4px solid var(--color-info-border);
      border-radius: var(--radius-sm);
      color: var(--color-info-text, #1565c0);
    }

    .fallback-notice-icon {
      font-size: var(--font-size-2xl);
      line-height: var(--leading-none);
      flex-shrink: 0;
    }

    .fallback-notice-content {
      flex: 1;
    }

    .fallback-notice-title {
      display: block;
      font-size: var(--font-size-base);
      margin-bottom: var(--space-1);
      color: var(--color-info-text, #0d47a1);
      font-weight: var(--font-weight-semibold);
    }

    .fallback-notice-message {
      margin: 0;
      font-size: var(--font-size-sm);
      line-height: var(--leading-normal);
      color: var(--color-info-text, #1565c0);
    }

    .article-header {
      margin-bottom: var(--space-8);
    }

    .article-title {
      font-size: clamp(1.75rem, 3vw, 2.5rem);
      line-height: var(--leading-tight);
      margin: var(--space-4) 0;
      color: var(--color-text);
    }

    .article-description {
      font-size: var(--font-size-lg);
      color: var(--color-text-secondary);
      margin: var(--space-4) 0;
    }

    .article-content {
      line-height: var(--leading-loose);
    }

    /* Right Sidebar - TOC (uses shared styles from sidebar-shared.css) */
    .toc-sidebar {
      /* All base styles inherited from sidebar-base */
    }

    /* Image and caption styles (docs-specific) */
    .article-content :global(p:has(img)) {
      text-align: center;
      margin: var(--space-6) 0 var(--space-8) 0;
    }

    .article-content :global(img) {
      max-width: 100%;
      height: auto;
      border-radius: var(--radius-md);
      margin: 0 auto;
      display: block;
    }

    /* Figure captions - em elements that follow images in the same paragraph */
    .article-content :global(p:has(img) em) {
      display: block;
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      margin-top: var(--space-3);
      font-style: italic;
      line-height: var(--leading-normal);
    }

    /* Responsive Design - TOC sidebar is hidden on tablets/phones (handled in sidebar-shared.css) */
    @media (max-width: 75rem) {
      /* 1200px */
      .docs-layout {
        grid-template-columns: 250px 1fr;
      }
    }

    @media (max-width: 48rem) {
      /* 768px */
      .docs-layout {
        grid-template-columns: 1fr;
        padding: var(--space-4) var(--space-2);
      }

      .article-title {
        font-size: var(--font-size-2xl);
      }
    }
  </style>

</BaseLayout>
