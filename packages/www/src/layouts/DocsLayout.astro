---
import BaseLayout from './BaseLayout.astro';
import DocsSidebar from '../components/DocsSidebar.astro';
import DocsTopTabs from '../components/DocsTopTabs.astro';
import Breadcrumb from '../components/Breadcrumb.astro';
import type { Language } from '../i18n/types';
import { createTranslator } from '../i18n/utils';
import { generateTOCFromHtml } from '../utils/sidebar-behavior';
import '../styles/sidebar-shared.css';
import '../styles/article-content.css';

interface Props {
  frontmatter: {
    title: string;
    description: string;
    category?: string;
  };
  url: string;
  currentLang: Language;
  showFallbackNotice?: boolean;
  variant?: 'article' | 'index';
  tocItems?: Array<{ id: string; title: string; level: number }>;
  tocTrackingSelector?: string;
  showTOC?: boolean;
}

const {
  frontmatter,
  url,
  currentLang,
  showFallbackNotice,
  variant = 'article',
  tocItems,
  tocTrackingSelector = '.article-content h2, .article-content h3, .article-content h4',
  showTOC = true
} = Astro.props as Props;

// Generate breadcrumbs
const { t } = createTranslator(currentLang);
const breadcrumbItems = variant === 'article'
  ? [
      {
        name: t('navigation.home'),
        url: `/${currentLang}/`
      },
      {
        name: t('navigation.docs'),
        url: `/${currentLang}/docs/`
      },
      {
        name: frontmatter.title,
        url: url
      }
    ]
  : [];

// Generate table of contents from rendered HTML using shared utility
const tocFromContent = generateTOCFromHtml(await Astro.slots.render('default'));
const toc = tocItems ?? tocFromContent;
const shouldTrackTOC = !tocItems && toc.length > 0;

// Smart TOC: auto-collapse deeper headings when the list is crowded
const TOC_COLLAPSE_THRESHOLD = 20;
const isCollapsible = toc.length > TOC_COLLAPSE_THRESHOLD;

interface TOCGroup {
  heading: typeof toc[0];
  children: typeof toc;
}
const tocGroups: TOCGroup[] = [];
for (const item of toc) {
  if (item.level === 2) {
    tocGroups.push({ heading: item, children: [] });
  } else if (tocGroups.length > 0) {
    tocGroups[tocGroups.length - 1].children.push(item);
  }
}
const useGrouped = isCollapsible && tocGroups.length > 0;
---

<BaseLayout
  title={frontmatter.title}
  description={frontmatter.description}
  lang={currentLang}
>
  <div class="docs-shell">
    <div class="docs-shell-top">
      <div class="docs-header-row">
        <DocsTopTabs
          currentLang={currentLang}
          currentCategory={frontmatter.category}
          variant={variant}
        />
      </div>
    </div>

    <div class="docs-layout">
      <DocsSidebar
        currentLang={currentLang}
        currentUrl={url}
        visibleCategory={variant === 'article' ? frontmatter.category : undefined}
      />

      <main class="docs-content">
        <article class={`docs-article ${variant === 'index' ? 'docs-article-index' : ''}`}>
          {variant === 'article' && <Breadcrumb items={breadcrumbItems} />}

          {variant === 'article' && showFallbackNotice && (
            <div class="fallback-notice" role="alert">
              <div class="fallback-notice-icon">ℹ️</div>
              <div class="fallback-notice-content">
                <strong class="fallback-notice-title">{t('pages.docs.fallbackNotice.title')}</strong>
                <p class="fallback-notice-message">{t('pages.docs.fallbackNotice.message')}</p>
              </div>
            </div>
          )}

          {variant === 'article' && (
            <header class="article-header">
              <div class="article-header-main">
                <h1 class="article-title">{frontmatter.title}</h1>
              </div>

              {frontmatter.description && (
                <p class="article-description">{frontmatter.description}</p>
              )}
            </header>
          )}

          <div class="article-content">
            <slot />
          </div>
        </article>
      </main>

      {showTOC && toc.length > 0 && (
        <aside class="sidebar-base sidebar-toc toc-sidebar" data-track={shouldTrackTOC ? 'true' : 'false'} data-selector={tocTrackingSelector}>
          <nav class="sidebar-nav sidebar-nav-with-accent toc-nav" role="navigation" aria-label="Table of contents">
            <h3 class="sidebar-title toc-title">{t('pages.docs.tableOfContents')}</h3>
            <ul class={`sidebar-list toc-list${useGrouped ? ' toc-collapsible' : ''}`}>
              {useGrouped ? (
                tocGroups.map(group => (
                  <li class="sidebar-item toc-item toc-level-2 toc-group">
                    <a href={`#${group.heading.id}`} class="sidebar-link toc-link">{group.heading.title}</a>
                    {group.children.length > 0 && (
                      <ul class="toc-children">
                        {group.children.map(child => (
                          <li class={`sidebar-item toc-item toc-level-${child.level}`}>
                            <a href={`#${child.id}`} class="sidebar-link toc-link">{child.title}</a>
                          </li>
                        ))}
                      </ul>
                    )}
                  </li>
                ))
              ) : (
                toc.map(heading => (
                  <li class={`sidebar-item toc-item toc-level-${heading.level}`}>
                    <a href={`#${heading.id}`} class="sidebar-link toc-link">{heading.title}</a>
                  </li>
                ))
              )}
            </ul>
          </nav>
        </aside>
      )}
    </div>
  </div>

  <script is:inline>
    // Initialize active state tracking for TOC as user scrolls
    (function() {
      // Prevent multiple initializations
      if (window.rediaccTOCInitialized) return;
      window.rediaccTOCInitialized = true;

      function initTOCActiveState() {
        const container = document.querySelector('.toc-sidebar');
        if (!container) return; // No TOC sidebar on this page

        const shouldTrack = container.getAttribute('data-track') === 'true';
        if (!shouldTrack) return;

        const selector = container.getAttribute('data-selector') || '.article-content h2, .article-content h3, .article-content h4';
        const headings = document.querySelectorAll(selector);
        if (headings.length === 0) return; // No headings to track

        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            const id = entry.target.id;
            if (!id) return;

            const tocLink = container?.querySelector(`a[href="#${id}"]`);
            if (!tocLink) return;

            if (entry.isIntersecting) {
              // Remove active class from all links
              container?.querySelectorAll('a').forEach(link => {
                link.classList.remove('active');
              });

              // Add active class to current link
              tocLink.classList.add('active');

              // Update collapsible group active state
              container?.querySelectorAll('.toc-group').forEach(g => g.classList.remove('toc-group-active'));
              const parentGroup = tocLink.closest('.toc-group');
              if (parentGroup) {
                parentGroup.classList.add('toc-group-active');
              }
            }
          });
        }, {
          rootMargin: '-100px 0px -66%'
        });

        // Start observing all headings
        headings.forEach(heading => {
          observer.observe(heading);
        });

        // Expand first group by default so page doesn't start fully collapsed
        const firstGroup = container?.querySelector('.toc-group');
        if (firstGroup) firstGroup.classList.add('toc-group-active');
      }

      // Initialize on load events
      function init() {
        initTOCActiveState();
      }

      // Astro View Transitions support
      document.addEventListener('astro:page-load', init);

      // Initial load
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>

  <!-- Tutorial player hydration (lazy — only loads if page has .cast embeds) -->
  <script src="../scripts/tutorial-hydrate.ts"></script>

  <style>
    .docs-shell {
      max-width: 1400px;
      margin: 0 auto;
      padding: calc(var(--nav-height) + var(--space-4)) var(--space-4) var(--space-8) var(--space-4);
      font-family: 'Inter', var(--font-family);
    }

    .docs-shell-top {
      display: block;
      margin-bottom: var(--space-4);
    }

    .docs-header-row {
      display: block;
      align-items: center;
      border-bottom: 1px solid var(--color-border);
      min-height: 3rem;
    }

    .docs-layout {
      display: grid;
      grid-template-columns: 250px 1fr 250px;
      gap: var(--space-8);
      padding: 0;
    }


    /* Main Content */
    .docs-content {
      min-width: 0;
      font-size: var(--font-size-base);
    }

    /* Flatten sidebars to match integrated docs rails style */
    .docs-shell :global(.docs-sidebar .sidebar-nav),
    .docs-shell :global(.toc-sidebar .sidebar-nav) {
      background: transparent;
      border: none;
      border-radius: 0;
      padding: var(--space-2) 0;
      box-shadow: none;
    }

    .docs-article {
      max-width: var(--container-md);
      overflow-wrap: break-word;
    }

    .docs-article-index {
      max-width: none;
    }

    /* Fallback Notice */
    .fallback-notice {
      display: flex;
      gap: var(--space-4);
      padding: var(--space-4) var(--space-5);
      margin: var(--space-6) 0;
      background-color: var(--color-info-bg);
      border-inline-start: 4px solid var(--color-info-border);
      border-radius: var(--radius-sm);
      color: var(--color-info-text, #1565c0);
    }

    .fallback-notice-icon {
      font-size: var(--font-size-2xl);
      line-height: var(--leading-none);
      flex-shrink: 0;
    }

    .fallback-notice-content {
      flex: 1;
    }

    .fallback-notice-title {
      display: block;
      font-size: var(--font-size-base);
      margin-bottom: var(--space-1);
      color: var(--color-info-text, #0d47a1);
      font-weight: var(--font-weight-semibold);
    }

    .fallback-notice-message {
      margin: 0;
      font-size: var(--font-size-sm);
      line-height: var(--leading-normal);
      color: var(--color-info-text, #1565c0);
    }

    .article-header {
      margin-bottom: var(--space-8);
    }

    .article-header-main {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: var(--space-4);
    }

    .article-title {
      font-size: clamp(1.75rem, 3vw, 2.5rem);
      line-height: var(--leading-tight);
      margin: var(--space-4) 0;
      color: var(--color-text);
    }

    .article-description {
      font-size: 1.05rem;
      color: var(--color-text-secondary);
      margin: var(--space-4) 0;
    }

    .article-content {
      line-height: var(--leading-loose);
      font-size: var(--font-size-base);
    }

    /* Right Sidebar - TOC (uses shared styles from sidebar-shared.css) */
    .toc-sidebar {
      /* All base styles inherited from sidebar-base */
    }

    /* Image and caption styles (docs-specific) */
    .article-content :global(p:has(img)) {
      text-align: center;
      margin: var(--space-6) 0 var(--space-8) 0;
    }

    .article-content :global(img) {
      max-width: 100%;
      height: auto;
      border-radius: var(--radius-md);
      margin: 0 auto;
      display: block;
    }

    /* Figure captions - em elements that follow images in the same paragraph */
    .article-content :global(p:has(img) em) {
      display: block;
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      margin-top: var(--space-3);
      font-style: italic;
      line-height: var(--leading-normal);
    }

    /* Video container and placeholder styles (docs-specific) */
    .article-content :global(.video-container) {
      text-align: center;
      margin: var(--space-6) 0 var(--space-8) 0;
    }

    .article-content :global(.video-container video) {
      width: 100%;
      max-width: 100%;
      height: auto;
      aspect-ratio: 16 / 9;
      border-radius: var(--radius-md);
      display: block;
      margin: 0 auto;
      background-color: #000;
    }

    .article-content :global(.video-placeholder) {
      width: 100%;
      aspect-ratio: 16 / 9;
      border-radius: var(--radius-md);
      background-color: var(--color-bg-light);
      border: 2px dashed var(--color-border);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: var(--space-3);
      margin: 0 auto;
    }

    .article-content :global(.video-placeholder-icon) {
      width: 4rem;
      height: 4rem;
      border-radius: 50%;
      background-color: var(--color-border);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text-secondary);
    }

    .article-content :global(.video-placeholder-icon svg) {
      width: 2rem;
      height: 2rem;
      margin-inline-start: 0.15rem;
    }

    .article-content :global(.video-placeholder-text) {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      font-weight: var(--font-weight-semibold);
    }

    .article-content :global(.video-container em) {
      display: block;
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      margin-top: var(--space-3);
      font-style: italic;
      line-height: var(--leading-normal);
    }

    /* Terminal tutorial player */
    .article-content :global(.terminal-tutorial) {
      margin: var(--space-6) 0;
    }
    .article-content :global(.terminal-tutorial-header) {
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-3);
    }
    .article-content :global(.terminal-tutorial-layout) {
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      background: #1a1a2e;
    }
    .article-content :global(.terminal-tutorial-player) {
      display: flex;
      flex-direction: column;
    }
    .article-content :global(.terminal-tutorial-player-inner) {
      flex: 1;
      min-height: 400px;
      /* No overflow hidden here — asciinema's .ap-terminal already clips
         terminal text, and we need control-bar tooltips to overflow. */
    }
    /* Override asciinema-player's overflow:hidden on .ap-player so that
       control-bar tooltips (marker labels, "Fullscreen (f)") are visible.
       Terminal text stays clipped via .ap-terminal's own overflow:hidden. */
    .article-content :global(.terminal-tutorial-player-inner .ap-player) {
      overflow: visible !important;
    }
    /* Reset player size after exiting fullscreen */
    .article-content :global(.terminal-tutorial-player-inner .ap-wrapper) {
      max-width: 100%;
    }
    .article-content :global(.terminal-tutorial-controls) {
      padding: var(--space-2) var(--space-3);
      background: rgba(0, 0, 0, 0.3);
    }
    .article-content :global(.terminal-tutorial-play-btn) {
      padding: var(--space-1) var(--space-3);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: var(--radius-sm);
      background: transparent;
      color: #fff;
      cursor: pointer;
      font-size: var(--font-size-sm);
    }
    .article-content :global(.terminal-tutorial-play-btn:hover) {
      background: rgba(255, 255, 255, 0.1);
    }

    /* Responsive Design - TOC sidebar is hidden on tablets/phones (handled in sidebar-shared.css) */
    @media (max-width: 75rem) {
      /* 1200px */
      .docs-layout {
        grid-template-columns: 250px 1fr;
      }
    }

    @media (max-width: 48rem) {
      .docs-shell {
        padding: calc(var(--nav-height) + var(--space-3)) var(--space-2) var(--space-4) var(--space-2);
      }

      .docs-header-row {
        align-items: stretch;
      }

      /* 768px */
      .docs-layout {
        grid-template-columns: 1fr;
      }

      .article-title {
        font-size: var(--font-size-2xl);
      }

      .article-header-main {
        flex-direction: column;
      }

    }
  </style>

</BaseLayout>
