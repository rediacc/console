---
import BaseLayout from './BaseLayout.astro';
import Breadcrumb from '../components/Breadcrumb.astro';
import type { Language } from '../i18n/types';
import { createTranslator } from '../i18n/utils';
import { generateTOCFromMarkdown } from '../utils/sidebar-behavior';
import '../styles/sidebar-shared.css';
import '../styles/article-content.css';

interface Props {
  frontmatter: {
    title: string;
    description: string;
    publishedDate?: Date;
    author?: string;
    category?: string;
    tags?: string[];
    toc?: boolean;
  };
  url: string;
  currentLang?: Language;
  availableLanguages?: Array<{ lang: Language; url: string }>;
  showFallbackNotice?: boolean;
}

const { frontmatter, url, currentLang, availableLanguages = [], showFallbackNotice = false } = Astro.props;

// Determine if this is a blog post or doc
const isBlogPost = url.includes('/blog/');
const isDoc = url.includes('/docs/');

// Generate breadcrumbs
const { t } = createTranslator(currentLang || 'en');
const breadcrumbItems = [];

if (currentLang) {
  // Add Home
  breadcrumbItems.push({
    name: t('navigation.home'),
    url: `/${currentLang}/`
  });

  // Add collection level (Blog or Docs)
  if (isBlogPost) {
    breadcrumbItems.push({
      name: t('navigation.blog'),
      url: `/${currentLang}/blog/`
    });
  } else if (isDoc) {
    breadcrumbItems.push({
      name: t('navigation.docs'),
      url: `/${currentLang}/docs/`
    });
  }

  // Add current page
  breadcrumbItems.push({
    name: frontmatter.title,
    url: url
  });
}

// Generate table of contents from markdown using shared utility (respecting toc frontmatter flag)
const toc = frontmatter.toc !== false ? generateTOCFromMarkdown(await Astro.slots.render('default')) : [];
---

<BaseLayout
  title={frontmatter.title}
  description={frontmatter.description}
  lang={currentLang}
>
  <Fragment slot="head">
    <slot name="head" />
  </Fragment>
  <article class="content-article">
    {breadcrumbItems.length > 0 && (
      <Breadcrumb items={breadcrumbItems} />
    )}
    <header class="article-header">
      <div class="article-meta">
        {isBlogPost && frontmatter.author && (
          <span class="meta-item">
            <span class="meta-label">By</span>
            <span class="meta-value">{frontmatter.author}</span>
          </span>
        )}

        {isBlogPost && frontmatter.publishedDate && (
          <span class="meta-item">
            <span class="meta-label">Published</span>
            <time datetime={frontmatter.publishedDate.toISOString()}>
              {new Date(frontmatter.publishedDate).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
              })}
            </time>
          </span>
        )}

        {isBlogPost && frontmatter.category && (
          <span class="meta-item">
            <span class="meta-label">Category</span>
            <span class="meta-value">{frontmatter.category}</span>
          </span>
        )}
      </div>

      <h1 class="article-title">{frontmatter.title}</h1>

      {frontmatter.description && (
        <p class="article-description">{frontmatter.description}</p>
      )}

      {isBlogPost && frontmatter.tags && frontmatter.tags.length > 0 && (
        <div class="article-tags">
          {frontmatter.tags.map(tag => (
            <a href={`/blog/tags/${tag}`} class="tag">#{tag}</a>
          ))}
        </div>
      )}
    </header>

    <div class="article-container">
      {toc.length > 0 && (
        <aside class="sidebar-base sidebar-toc toc-sidebar">
          <nav class="sidebar-nav sidebar-nav-with-accent toc-nav" role="navigation" aria-label="Table of contents">
            <h3 class="sidebar-title toc-title">On this page</h3>
            <ul class="sidebar-list toc-list">
              {toc.map(heading => (
                <li class={`sidebar-item toc-item toc-level-${heading.level}`}>
                  <a href={`#${heading.id}`} class="sidebar-link toc-link">{heading.title}</a>
                </li>
              ))}
            </ul>
          </nav>
        </aside>
      )}

      <main class="article-content">
        <slot />
      </main>
    </div>
  </article>

  <style is:global>
    .content-article {
      max-width: var(--container-md);
      margin: 0 auto;
      padding: calc(var(--nav-height) + var(--space-8)) var(--space-4) var(--space-8);
    }

    .article-header {
      margin-bottom: var(--space-12);
    }

    .article-meta {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-6);
      margin-bottom: var(--space-4);
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
    }

    .meta-item {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .meta-label {
      font-weight: var(--font-weight-semibold);
    }

    .article-title {
      font-size: clamp(1.75rem, 3vw, 2.5rem);
      line-height: var(--leading-tight);
      margin: var(--space-4) 0;
      color: var(--color-text);
    }

    .article-description {
      font-size: var(--font-size-lg);
      color: var(--color-text-secondary);
      margin: var(--space-4) 0;
    }

    .article-tags {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
      margin-top: var(--space-4);
    }

    .tag {
      display: inline-block;
      padding: var(--space-1) var(--space-3);
      background-color: var(--color-bg-light);
      color: var(--color-brand-primary);
      border-radius: var(--radius-sm);
      text-decoration: none;
      font-size: var(--font-size-sm);
      transition: background-color var(--transition-duration-base) ease;
    }

    .tag:hover {
      background-color: var(--color-hover);
    }

    .tag:focus-visible {
      outline: 2px solid var(--color-brand-primary);
      outline-offset: 2px;
    }

    .article-container {
      display: grid;
      grid-template-columns: 1fr 250px;
      gap: var(--space-12);
    }

    /* TOC Sidebar - ContentLayout specific positioning */
    .toc-sidebar {
      position: sticky;
      top: var(--space-8);
      height: fit-content;
      max-height: calc(100vh - var(--space-16));
      overflow-y: auto;
      overscroll-behavior: contain;
      scrollbar-width: thin;
      scrollbar-color: var(--color-border) transparent;
    }

    .content-article .toc-item a {
      color: var(--color-text);
    }

    .content-article .toc-item a:hover {
      color: var(--color-brand-primary);
    }

    .content-article .toc-item a:focus-visible {
      color: var(--color-brand-primary);
      outline: 2px solid var(--color-brand-primary);
      outline-offset: 2px;
      border-radius: var(--radius-sm);
    }

    .article-content {
      min-width: 0;
      overflow-wrap: break-word;
    }

    @media (max-width: 48rem) {
      /* 768px */
      .article-container {
        grid-template-columns: 1fr;
      }

      .toc-sidebar {
        position: static;
        top: auto;
        margin-bottom: var(--space-8);
      }

      .article-title {
        font-size: var(--font-size-2xl);
      }

      .article-meta {
        font-size: var(--font-size-xs);
        gap: var(--space-4);
      }
    }
  </style>
</BaseLayout>
