import{j as e,u as t}from"./chunk-DXw4Pgvm.js";import{f as s,g as a,r as i,R as r,u as n}from"./chunk-DZuWtVpy.js";import{r as o,a as c,b as l,c as d,i as m,e as u,f as h,C as p,M as y,s as x,g,j as f,D as j,k as v,u as b,I as N,l as w,m as k,H as C,h as S,n as T,o as I,A as z,G as _,p as M,W as D,P as $}from"../index-yX3ttfFw.js";import{E as B}from"./chunk-BlloZxKc.js";import{S as V,D as R}from"./chunk-DznnOiqm.js";import{C as E}from"./chunk-tthewbz1.js";import{R as F}from"./chunk-BSOr0LTQ.js";import{u as A,a as O,W as P,b as L,c as G,U as W,d as U,e as q,f as K,g as Q,h as H,i as J,j as X,k as Y,l as Z,m as ee,n as te,o as se,p as ae,q as ie,r as re,s as ne}from"./chunk-TZcEmCSf.js";import{I as oe}from"./chunk-D_GZ82xV.js";import{I as ce}from"./chunk-B8UNr02g.js";import{u as le,a as de,M as me,b as ue,F as he,L as pe,c as ye,A as xe,R as ge,V as fe,P as je,T as ve}from"./chunk-Bj7Wr12n.js";import{R as be,D as Ne,P as we,Q as ke}from"./chunk-DpD9152K.js";import{C as Ce}from"./chunk-CNWXBXgB.js";import{u as Se,a as Te,C as Ie}from"./chunk-C1NFjQ3o.js";import{u as ze}from"./chunk-CM3g5OHp.js";import{a as _e,T as Me,g as De,M as $e,P as Be,i as Ve,w as Re,B as Ee,k as Fe,x as Ae,n as Oe,p as Pe,U as Le,y as Ge,z as We,S as Ue,E as qe,G as Ke,I as Qe,H as He,J as Je,K as Xe,c as Ye,N as Ze,O as et,Q as tt,o as st,h as at,q as it,s as rt,u as nt,f as ot,D as ct,V as lt}from"./chunk-CSjZqX98.js";import{A as dt,S as mt}from"./chunk-DJtkLMHK.js";import{T as ut}from"./chunk-Dup-ioXh.js";import{C as ht}from"./chunk-BoPzgTQ_.js";import{u as pt}from"./chunk-BP6R0kRn.js";import{f as yt,g as xt,a as gt}from"./chunk-xSw6NTs2.js";import{D as ft,C as jt}from"./chunk-BCwlQNV5.js";import{F as vt}from"./chunk-C2DqzhJJ.js";import"./chunk-BNqsZZGB.js";import"./chunk-C0XEpv6B.js";import"./chunk-DCAm5-CN.js";import"./chunk-0VeV4Lca.js";import"./chunk-e2suWao5.js";import"./forkTokenService.ts-DPueIQdC.js";import"./chunk-DfgqoFX0.js";import"./chunk-DETbo3Nb.js";var bt,Nt,wt,kt={exports:{}},Ct={},St={};function Tt(){if(bt)return St;bt=1,Object.defineProperty(St,"__esModule",{value:!0});return St.default={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M880 298.4H521L403.7 186.2a8.15 8.15 0 00-5.5-2.2H144c-17.7 0-32 14.3-32 32v592c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V330.4c0-17.7-14.3-32-32-32zM840 768H184V256h188.5l119.6 114.4H840V768z"}}]},name:"folder",theme:"outlined"},St}function It(){if(Nt)return Ct;Nt=1;var e=o().default,t=c().default;Object.defineProperty(Ct,"__esModule",{value:!0}),Ct.default=void 0;var a=t(l()),i=e(s()),r=t(Tt()),n=t(d()),m=function(e,t){return i.createElement(n.default,(0,a.default)({},e,{ref:t,icon:r.default}))},u=i.forwardRef(m);return Ct.default=u,Ct}function zt(){return wt||(wt=1,function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var s;const a=(s=It())&&s.__esModule?s:{default:s};t.default=a,e.exports=a}(kt,kt.exports)),kt.exports}const _t=a(zt());var Mt,Dt,$t,Bt={exports:{}},Vt={},Rt={};function Et(){if(Mt)return Rt;Mt=1,Object.defineProperty(Rt,"__esModule",{value:!0});return Rt.default={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M832 64H192c-17.7 0-32 14.3-32 32v832c0 17.7 14.3 32 32 32h640c17.7 0 32-14.3 32-32V96c0-17.7-14.3-32-32-32zm-40 824H232V687h97.9c11.6 32.8 32 62.3 59.1 84.7 34.5 28.5 78.2 44.3 123 44.3s88.5-15.7 123-44.3c27.1-22.4 47.5-51.9 59.1-84.7H792v-63H643.6l-5.2 24.7C626.4 708.5 573.2 752 512 752s-114.4-43.5-126.5-103.3l-5.2-24.7H232V136h560v752zM320 341h384c4.4 0 8-3.6 8-8v-48c0-4.4-3.6-8-8-8H320c-4.4 0-8 3.6-8 8v48c0 4.4 3.6 8 8 8zm0 160h384c4.4 0 8-3.6 8-8v-48c0-4.4-3.6-8-8-8H320c-4.4 0-8 3.6-8 8v48c0 4.4 3.6 8 8 8z"}}]},name:"container",theme:"outlined"},Rt}function Ft(){if(Dt)return Vt;Dt=1;var e=o().default,t=c().default;Object.defineProperty(Vt,"__esModule",{value:!0}),Vt.default=void 0;var a=t(l()),i=e(s()),r=t(Et()),n=t(d()),m=function(e,t){return i.createElement(n.default,(0,a.default)({},e,{ref:t,icon:r.default}))},u=i.forwardRef(m);return Vt.default=u,Vt}function At(){return $t||($t=1,function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var s;const a=(s=Ft())&&s.__esModule?s:{default:s};t.default=a,e.exports=a}(Bt,Bt.exports)),Bt.exports}const Ot=a(At());var Pt,Lt,Gt,Wt={exports:{}},Ut={},qt={};function Kt(){if(Pt)return qt;Pt=1,Object.defineProperty(qt,"__esModule",{value:!0});return qt.default={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M740 161c-61.8 0-112 50.2-112 112 0 50.1 33.1 92.6 78.5 106.9v95.9L320 602.4V318.1c44.2-15 76-56.9 76-106.1 0-61.8-50.2-112-112-112s-112 50.2-112 112c0 49.2 31.8 91 76 106.1V706c-44.2 15-76 56.9-76 106.1 0 61.8 50.2 112 112 112s112-50.2 112-112c0-49.2-31.8-91-76-106.1v-27.8l423.5-138.7a50.52 50.52 0 0034.9-48.2V378.2c42.9-15.8 73.6-57 73.6-105.2 0-61.8-50.2-112-112-112zm-504 51a48.01 48.01 0 0196 0 48.01 48.01 0 01-96 0zm96 600a48.01 48.01 0 01-96 0 48.01 48.01 0 0196 0zm408-491a48.01 48.01 0 010-96 48.01 48.01 0 010 96z"}}]},name:"branches",theme:"outlined"},qt}function Qt(){if(Lt)return Ut;Lt=1;var e=o().default,t=c().default;Object.defineProperty(Ut,"__esModule",{value:!0}),Ut.default=void 0;var a=t(l()),i=e(s()),r=t(Kt()),n=t(d()),m=function(e,t){return i.createElement(n.default,(0,a.default)({},e,{ref:t,icon:r.default}))},u=i.forwardRef(m);return Ut.default=u,Ut}function Ht(){return Gt||(Gt=1,function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var s;const a=(s=Qt())&&s.__esModule?s:{default:s};t.default=a,e.exports=a}(Wt,Wt.exports)),Wt.exports}const Jt=a(Ht());var Xt,Yt,Zt,es={exports:{}},ts={},ss={};function as(){if(Xt)return ss;Xt=1,Object.defineProperty(ss,"__esModule",{value:!0});return ss.default={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372zm198.4-588.1a32 32 0 00-24.5.5L414.9 415 296.4 686c-3.6 8.2-3.6 17.5 0 25.7 3.4 7.8 9.7 13.9 17.7 17 3.8 1.5 7.7 2.2 11.7 2.2 4.4 0 8.7-.9 12.8-2.7l271-118.6 118.5-271a32.06 32.06 0 00-17.7-42.7zM576.8 534.4l26.2 26.2-42.4 42.4-26.2-26.2L380 644.4 447.5 490 422 464.4l42.4-42.4 25.5 25.5L644.4 380l-67.6 154.4zM464.4 422L422 464.4l25.5 25.6 86.9 86.8 26.2 26.2 42.4-42.4-26.2-26.2-86.8-86.9z"}}]},name:"compass",theme:"outlined"},ss}function is(){if(Yt)return ts;Yt=1;var e=o().default,t=c().default;Object.defineProperty(ts,"__esModule",{value:!0}),ts.default=void 0;var a=t(l()),i=e(s()),r=t(as()),n=t(d()),m=function(e,t){return i.createElement(n.default,(0,a.default)({},e,{ref:t,icon:r.default}))},u=i.forwardRef(m);return ts.default=u,ts}function rs(){return Zt||(Zt=1,function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var s;const a=(s=is())&&s.__esModule?s:{default:s};t.default=a,e.exports=a}(es,es.exports)),es.exports}const ns=a(rs());var os,cs,ls,ds={exports:{}},ms={},us={};function hs(){if(os)return us;os=1,Object.defineProperty(us,"__esModule",{value:!0});return us.default={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M624 706.3h-74.1V464c0-4.4-3.6-8-8-8h-60c-4.4 0-8 3.6-8 8v242.3H400c-6.7 0-10.4 7.7-6.3 12.9l112 141.7a8 8 0 0012.6 0l112-141.7c4.1-5.2.4-12.9-6.3-12.9z"}},{tag:"path",attrs:{d:"M811.4 366.7C765.6 245.9 648.9 160 512.2 160S258.8 245.8 213 366.6C127.3 389.1 64 467.2 64 560c0 110.5 89.5 200 199.9 200H304c4.4 0 8-3.6 8-8v-60c0-4.4-3.6-8-8-8h-40.1c-33.7 0-65.4-13.4-89-37.7-23.5-24.2-36-56.8-34.9-90.6.9-26.4 9.9-51.2 26.2-72.1 16.7-21.3 40.1-36.8 66.1-43.7l37.9-9.9 13.9-36.6c8.6-22.8 20.6-44.1 35.7-63.4a245.6 245.6 0 0152.4-49.9c41.1-28.9 89.5-44.2 140-44.2s98.9 15.3 140 44.2c19.9 14 37.5 30.8 52.4 49.9 15.1 19.3 27.1 40.7 35.7 63.4l13.8 36.5 37.8 10C846.1 454.5 884 503.8 884 560c0 33.1-12.9 64.3-36.3 87.7a123.07 123.07 0 01-87.6 36.3H720c-4.4 0-8 3.6-8 8v60c0 4.4 3.6 8 8 8h40.1C870.5 760 960 670.5 960 560c0-92.7-63.1-170.7-148.6-193.3z"}}]},name:"cloud-download",theme:"outlined"},us}function ps(){if(cs)return ms;cs=1;var e=o().default,t=c().default;Object.defineProperty(ms,"__esModule",{value:!0}),ms.default=void 0;var a=t(l()),i=e(s()),r=t(hs()),n=t(d()),m=function(e,t){return i.createElement(n.default,(0,a.default)({},e,{ref:t,icon:r.default}))},u=i.forwardRef(m);return ms.default=u,ms}function ys(){return ls||(ls=1,function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var s;const a=(s=ps())&&s.__esModule?s:{default:s};t.default=a,e.exports=a}(ds,ds.exports)),ds.exports}const xs=a(ys());async function gs(e,t=3e4){const s=Date.now();for(;Date.now()-s<t;){const t=await fs(e);if(t)return t;await new Promise(e=>setTimeout(e,1e3))}return vs("Operation timeout - no response received","TIMEOUT")}async function fs(e){try{const t=await m.get("/GetQueueItemTrace",{taskId:e}),s=t.resultSets?.[1]?.data?.[0];if(!s)return null;const a=s.status||s.Status;switch(a){case"COMPLETED":return function(e){const t=e.resultSets?.[3]?.data?.[0];if(!t?.vaultContent)return js("Hello function completed successfully","COMPLETED");try{const e=JSON.parse(t.vaultContent);return e.result&&"string"==typeof e.result&&e.result.includes("Error")?vs(e.result,"COMPLETED",e):js(e.result||"Hello function completed successfully","COMPLETED",e)}catch{return js("Hello function completed","COMPLETED")}}(t);case"FAILED":case"CANCELLED":return function(e,t){const s=e.lastFailureReason||e.LastFailureReason||"Operation failed";return vs(s,t)}(s,a);default:return null}}catch(t){return null}}function js(e,t,s){return{success:!0,message:e,status:t,responseData:s}}function vs(e,t,s){return{success:!1,message:e,status:t,responseData:s}}function bs(e){const{buildQueueVault:t}=A();le();const s=Se(),{data:a}=O(),r=i.useCallback(async e=>{try{const i=function(e,t){if(e.teamVault&&"{}"!==e.teamVault)return e.teamVault;const s=t?.find(t=>t.teamName===e.teamName);return s?.vaultContent||"{}"}(e,a),r=await async function(e,t,s){const a=4,i="Ping connectivity test",r="ping-service",n="{}";return s({teamName:e.teamName,machineName:e.machineName,bridgeName:e.bridgeName,functionName:"ping",params:{},priority:e.priority||a,description:e.description||i,addedVia:e.addedVia||r,machineVault:e.machineVault||n,teamVault:t,repositoryVault:e.repositoryVault||n})}(e,i,t),n=await async function(e,t,s){const a=4;return s.mutateAsync({teamName:e.teamName,machineName:e.machineName,bridgeName:e.bridgeName,queueVault:t,priority:e.priority||a})}(e,r,s);return{taskId:n?.taskId,success:!!n?.taskId||!!n?.isQueued}}catch(i){return{success:!1,error:i.message||"Failed to execute ping function"}}},[t,s,a]),n=i.useCallback(async(e,t)=>r({teamName:e.teamName,machineName:e.machineName,bridgeName:e.bridgeName,priority:t?.priority,description:t?.description,addedVia:t?.addedVia,machineVault:e.vaultContent||"{}"}),[r]),o=i.useCallback(async(e,t)=>{const s=await r(e);if(!s.success||!s.taskId)return s;const a=await gs(s.taskId,t);return{...s,completionResult:a,success:a.success,error:a.success?void 0:a.message}},[r]),c=i.useCallback(async(e,t)=>o({teamName:e.teamName,machineName:e.machineName,bridgeName:e.bridgeName,priority:t?.priority,description:t?.description,addedVia:t?.addedVia,machineVault:e.vaultContent||"{}"},t?.timeout),[o]);return{executePing:r,executePingForMachine:n,executePingAndWait:o,executePingForMachineAndWait:c,waitForQueueItemCompletion:gs,isLoading:s.isPending}}const{Text:Ns}=Me,ws=({open:t,onClose:s,machines:a})=>{const{t:r}=ze(["machines","common"]),{theme:n}=u(),[o,c]=i.useState([]),[l,d]=i.useState(!1),[m,b]=i.useState(0),[N,w]=i.useState(-1),{executePingForMachine:k,waitForQueueItemCompletion:C}=bs();i.useEffect(()=>{if(t&&a.length>0){const e=a.map(e=>({machineName:e.machineName,teamName:e.teamName,bridgeName:e.bridgeName,status:"pending"}));c(e),b(0),w(-1)}},[t,a]);const S=e=>e.success?r("machines:connectionSuccessful"):"TIMEOUT"===e.status?r("machines:testTimeout"):e.message||r("machines:connectionFailed"),T=async(e,t)=>{const s=Date.now();c(e=>e.map((e,s)=>s===t?{...e,status:"testing",timestamp:(new Date).toISOString()}:e));try{const a=await k(e,{priority:4,description:"Connectivity test",addedVia:"connectivity-test"});if(!a.success||!a.taskId)throw new Error(a.error||"Failed to create test task");{c(e=>e.map((e,s)=>s===t?{...e,taskId:a.taskId}:e));const e=await C(a.taskId),i=Date.now()-s;c(s=>s.map((s,a)=>a===t?{...s,status:e.success?"success":"failed",message:S(e),duration:i}:s))}}catch(a){const e=Date.now()-s;c(s=>s.map((s,i)=>i===t?{...s,status:"failed",message:a.message||"Failed to create test task",duration:e}:s))}},I=[{title:r("machines:machineName"),dataIndex:"machineName",key:"machineName",render:(t,s)=>e.jsxs(_e,{"data-testid":`connectivity-machine-${t}`,children:["testing"===s.status&&e.jsx(V,{spin:!0,style:{color:"#1890ff"},"data-testid":`connectivity-status-icon-testing-${t}`}),"success"===s.status&&e.jsx(h,{style:{color:"#52c41a"},"data-testid":`connectivity-status-icon-success-${t}`}),"failed"===s.status&&e.jsx(Ce,{style:{color:"#ff4d4f"},"data-testid":`connectivity-status-icon-failed-${t}`}),"pending"===s.status&&e.jsx(p,{style:{color:"#8c8c8c"},"data-testid":`connectivity-status-icon-pending-${t}`}),e.jsx(Ns,{strong:!0,children:t})]})},{title:r("machines:team"),dataIndex:"teamName",key:"teamName",render:t=>e.jsx(De,{color:"#8FBC8F",children:t})},{title:r("machines:bridge"),dataIndex:"bridgeName",key:"bridgeName",render:t=>e.jsx(De,{color:"green",children:t})},{title:r("machines:status"),dataIndex:"status",key:"status",width:120,render:(t,s)=>{const a={pending:{color:"default",text:r("machines:pending")},testing:{color:"processing",text:r("machines:testing")},success:{color:"success",text:r("machines:connected")},failed:{color:"error",text:r("machines:failed")}};return e.jsx(De,{color:a[t].color,"data-testid":`connectivity-status-tag-${s.machineName}-${t}`,children:a[t].text})}},{title:r("machines:responseTime"),dataIndex:"duration",key:"duration",width:120,render:e=>e?e<1e3?`${e}ms`:`${(e/1e3).toFixed(1)}s`:"-"},{title:r("machines:message"),dataIndex:"message",key:"message",ellipsis:!0,render:(t,s)=>t?e.jsx(Ns,{type:"failed"===s.status?"danger":void 0,children:t}):"-"}];return e.jsx($e,{"data-testid":"connectivity-modal",title:e.jsxs(_e,{children:[e.jsx(P,{style:{fontSize:j.DIMENSIONS.ICON_MD}}),e.jsx("span",{style:{fontSize:f("BASE")},children:r("machines:connectivityTest")})]}),open:t,onCancel:s,className:y.ExtraLarge,destroyOnHidden:!0,footer:[e.jsx(Ee,{type:"primary",icon:e.jsx(V,{style:{fontSize:j.DIMENSIONS.ICON_SM}}),onClick:async()=>{d(!0);for(let s=0;s<a.length;s++)w(s),b(Math.round(s/a.length*100)),await T(a[s],s);b(100),d(!1),w(-1);const e=o.filter(e=>"success"===e.status).length,t=o.filter(e=>"failed"===e.status).length;0===t?v("success",r("machines:allMachinesConnected",{count:e})):v("warning",r("machines:machinesConnectedWithFailures",{successCount:e,failedCount:t}))},disabled:l||0===a.length,loading:l,style:{fontSize:f("SM")},"data-testid":"connectivity-run-test-button",children:r(l?"machines:testing":"machines:runTest")},"run"),e.jsx(Fe,{title:"Close",children:e.jsx(Ee,{icon:e.jsx(Ce,{}),onClick:s,style:{borderRadius:g("LG"),fontSize:f("SM")},"data-testid":"connectivity-close-button","aria-label":"Close"},"close")},"close-tooltip")],children:e.jsxs(_e,{direction:"vertical",size:"large",style:{width:"100%"},children:[l&&e.jsxs("div",{style:{marginBottom:x("MD")},"data-testid":"connectivity-progress-container",children:[e.jsx(Be,{percent:m,status:"active",strokeColor:{"0%":"var(--color-primary)","100%":"var(--color-success)"},style:{borderRadius:g("LG")},"data-testid":"connectivity-progress-bar"}),N>=0&&N<a.length&&e.jsx(Ns,{type:"secondary",style:{fontSize:f("XS"),marginTop:x("XS"),display:"block"},"data-testid":"connectivity-progress-text",children:r("machines:testingMachine",{machineName:a[N].machineName})})]}),e.jsx(Ve,{message:r("machines:connectivityTestDescription"),type:"info",showIcon:!0,icon:e.jsx(P,{style:{fontSize:j.DIMENSIONS.ICON_MD}}),style:{borderRadius:g("LG"),fontSize:f("SM")},"data-testid":"connectivity-info-alert"}),e.jsx(Re,{columns:I,dataSource:o,rowKey:"machineName",pagination:!1,scroll:{y:400},loading:0===a.length,rowClassName:e=>"testing"===e.status?"connectivity-test-active-row":"success"===e.status?"connectivity-test-success-row":"failed"===e.status?"connectivity-test-failed-row":"",style:{borderRadius:g("LG"),overflow:"hidden"},"data-testid":"connectivity-results-table"}),!l&&o.some(e=>"pending"!==e.status)&&e.jsx("div",{style:{padding:x("MD"),background:"dark"===n?"var(--color-fill-quaternary)":"var(--color-fill-tertiary)",borderRadius:g("LG")},"data-testid":"connectivity-summary-statistics",children:e.jsxs(_e,{size:"large",children:[e.jsxs("div",{"data-testid":"connectivity-total-machines",children:[e.jsxs(Ns,{type:"secondary",children:[r("machines:totalMachines"),":"]})," ",e.jsx(Ns,{strong:!0,children:a.length})]}),e.jsxs("div",{"data-testid":"connectivity-connected-count",children:[e.jsxs(Ns,{type:"secondary",children:[r("machines:connected"),":"]})," ",e.jsx(Ns,{strong:!0,style:{color:"#52c41a"},children:o.filter(e=>"success"===e.status).length})]}),e.jsxs("div",{"data-testid":"connectivity-failed-count",children:[e.jsxs(Ns,{type:"secondary",children:[r("machines:failed"),":"]})," ",e.jsx(Ns,{strong:!0,style:{color:"#ff4d4f"},children:o.filter(e=>"failed"===e.status).length})]}),e.jsxs("div",{"data-testid":"connectivity-average-response",children:[e.jsxs(Ns,{type:"secondary",children:[r("machines:averageResponse"),":"]})," ",e.jsx(Ns,{strong:!0,children:(()=>{const e=o.filter(e=>"success"===e.status&&e.duration);if(0===e.length)return"-";const t=e.reduce((e,t)=>e+(t.duration||0),0)/e.length;return t<1e3?`${Math.round(t)}ms`:`${(t/1e3).toFixed(1)}s`})()})]})]})})]})})},{Step:ks}=Oe,{Text:Cs,Title:Ss,Paragraph:Ts}=Me,Is=({open:t,onClose:s,teamName:a,onImportComplete:r})=>{const{t:n}=ze(["resources","common"]),o=b(),[c,l]=i.useState(0),[d,m]=i.useState([]),[u,h]=i.useState([]),[p,y]=i.useState([]),[g,f]=i.useState(!1),[v,k]=i.useState(null),C=L(),{data:S=[]}=G(a),T=e=>{const{type:t,config:s}=e,a={drive:"drive",onedrive:"onedrive",s3:"s3",b2:"b2",mega:"mega",dropbox:"dropbox",box:"box",azureblob:"azureblob",swift:"swift",webdav:"webdav",ftp:"ftp",sftp:"sftp"}[t];if(!a)return null;const i={};return Object.entries(s).forEach(([e,t])=>{if("type"===e)i.provider=a;else{let s=t;if("string"==typeof t&&("token"===e||e.endsWith("_token"))&&t.startsWith("{"))try{s=JSON.parse(t)}catch{s=t}i[e]=s}}),i.provider||(i.provider=a),i},I=async e=>{k(null);try{const t=(e=>{const t=[],s=e.split("\n");let a=null,i={};for(const r of s){const e=r.trim();if(!e||e.startsWith("#")||e.startsWith(";"))continue;const s=e.match(/^\[(.+)\]$/);if(s)a&&i.type&&t.push({name:a,type:i.type,config:{...i}}),a=s[1],i={};else if(a){const t=e.match(/^([^=]+)=(.*)$/);if(t){const e=t[1].trim(),s=t[2].trim();try{i[e]=JSON.parse(s)}catch{i[e]=s}}}}return a&&i.type&&t.push({name:a,type:i.type,config:{...i}}),t})(await e.text());if(0===t.length)return k(n("resources:storage.import.noConfigsFound")),!1;h(t);const s=t.map(e=>{const t=S.some(t=>t.storageName===e.name);return{name:e.name,status:"pending",exists:t,selected:!t}});return y(s),l(1),!1}catch(t){return k(n("resources:storage.import.parseError")),!1}},z=()=>{l(0),m([]),h([]),y([]),f(!1),k(null),2===c&&p.some(e=>"success"===e.status)&&r?.(),s()},_=[{title:e.jsx(Ae,{checked:p.every(e=>e.selected),indeterminate:p.some(e=>e.selected)&&!p.every(e=>e.selected),onChange:e=>{return t=e.target.checked,void y(e=>e.map(e=>({...e,selected:t})));var t},disabled:2===c,"data-testid":"rclone-wizard-select-all-checkbox"}),dataIndex:"selected",key:"selected",width:50,render:(t,s,a)=>e.jsx(Ae,{checked:s.selected,onChange:()=>(e=>{y(t=>{const s=[...t];return s[e]={...s[e],selected:!s[e].selected},s})})(a),disabled:2===c,"data-testid":`rclone-wizard-config-checkbox-${s.name}`})},{title:n("resources:storage.storageName"),dataIndex:"name",key:"name",render:(t,s)=>e.jsxs(_e,{children:[e.jsx(E,{}),e.jsx(Cs,{strong:!0,children:t}),s.exists&&e.jsx(Fe,{title:n("resources:storage.import.alreadyExists"),children:e.jsxs(De,{color:"warning",children:[e.jsx(N,{})," ",n("resources:storage.import.exists")]})})]})},{title:n("resources:storage.provider"),key:"provider",width:120,render:(t,s)=>{const a=u.find(e=>e.name===s.name);if(!a)return null;const i=a.type.charAt(0).toUpperCase()+a.type.slice(1);return e.jsx(De,{color:"blue",children:i})}},{title:n("resources:storage.import.status"),dataIndex:"status",key:"status",width:150,render:(t,s)=>{if(c<2)return null;const a={pending:{color:"default",text:n("resources:storage.import.pending")},success:{color:"success",text:n("resources:storage.import.success")},error:{color:"error",text:n("resources:storage.import.error")},skipped:{color:"warning",text:n("resources:storage.import.skipped")}}[t]||{color:"default",text:t};return e.jsxs(_e,{direction:"vertical",size:"small",children:[e.jsx(De,{color:a.color,children:a.text}),s.message&&e.jsx(Cs,{type:"secondary",style:{fontSize:12},children:s.message})]})}}];return e.jsxs($e,{title:e.jsxs(_e,{children:[e.jsx(E,{}),n("resources:storage.import.title")]}),open:t,onCancel:z,style:w(j.DIMENSIONS.MODAL_WIDTH_XL),footer:0===c?e.jsx(Ee,{onClick:z,"data-testid":"rclone-wizard-cancel-button",style:o.buttonSecondary,children:n("common:actions.cancel")}):1===c?e.jsxs(e.Fragment,{children:[e.jsx(Ee,{onClick:()=>l(0),"data-testid":"rclone-wizard-back-button",style:o.buttonSecondary,children:n("common:actions.back")}),e.jsx(Ee,{onClick:z,"data-testid":"rclone-wizard-cancel-button",style:o.buttonSecondary,children:n("common:actions.cancel")}),e.jsx(Ee,{type:"primary",onClick:async()=>{f(!0);const e=u.filter((e,t)=>p[t].selected);for(let s=0;s<e.length;s++){const i=e[s],r=u.findIndex(e=>e.name===i.name);try{const e=T(i);if(!e){y(e=>{const t=[...e];return t[r]={...t[r],status:"error",message:n("resources:storage.import.unsupportedProvider",{type:i.type})},t});continue}const t=JSON.stringify(e);await C.mutateAsync({teamName:a,storageName:i.name,storageVault:t}),y(e=>{const t=[...e];return t[r]={...t[r],status:"success",message:n("resources:storage.import.imported")},t})}catch(t){y(e=>{const s=[...e];return s[r]={...s[r],status:"error",message:t.message||n("resources:storage.import.importError")},s})}}f(!1),l(2)},disabled:!p.some(e=>e.selected),loading:g,"data-testid":"rclone-wizard-import-button",style:o.buttonPrimary,children:n("resources:storage.import.importSelected")})]}):e.jsx(Ee,{type:"primary",onClick:z,"data-testid":"rclone-wizard-close-button",style:o.buttonPrimary,children:n("common:actions.close")}),children:[e.jsxs(Oe,{current:c,style:{marginBottom:x("LG")},"data-testid":"rclone-wizard-steps",children:[e.jsx(ks,{title:n("resources:storage.import.step1")}),e.jsx(ks,{title:n("resources:storage.import.step2")}),e.jsx(ks,{title:n("resources:storage.import.step3")})]}),(()=>{switch(c){case 0:return e.jsxs("div",{style:{padding:"20px 0"},children:[e.jsx(Ve,{message:n("resources:storage.import.instructions"),description:e.jsxs("div",{children:[e.jsx(Ts,{children:n("resources:storage.import.instructionsDetail")}),e.jsx(Ts,{children:e.jsx(Cs,{code:!0,children:"rclone config file"})}),e.jsx(Ts,{children:n("resources:storage.import.uploadPrompt")})]}),type:"info",showIcon:!0,icon:e.jsx(N,{}),style:{marginBottom:20}}),e.jsxs(Le.Dragger,{accept:".conf",fileList:d,beforeUpload:I,onChange:({fileList:e})=>m(e),maxCount:1,"data-testid":"rclone-wizard-upload-dragger",children:[e.jsx("p",{className:"ant-upload-drag-icon",children:e.jsx(W,{})}),e.jsx("p",{className:"ant-upload-text",children:n("resources:storage.import.dragDropText")}),e.jsx("p",{className:"ant-upload-hint",children:n("resources:storage.import.supportedFormats")})]}),v&&e.jsx(Ve,{message:v,type:"error",showIcon:!0,style:{marginTop:16}})]});case 1:return e.jsxs("div",{children:[e.jsx(Ve,{message:n("resources:storage.import.selectStorages"),description:n("resources:storage.import.selectDescription"),type:"info",showIcon:!0,style:{marginBottom:16}}),e.jsx(Re,{dataSource:p,columns:_,rowKey:"name",pagination:!1,size:"small","data-testid":"rclone-wizard-config-table"})]});case 2:return e.jsx("div",{children:g?e.jsxs("div",{style:{textAlign:"center",padding:"40px 0"},children:[e.jsx(Pe,{size:"large"}),e.jsx(Ss,{level:4,style:{marginTop:16},children:n("resources:storage.import.importing")})]}):e.jsxs(e.Fragment,{children:[e.jsx(Ve,{message:n("resources:storage.import.complete"),description:n("resources:storage.import.completeDescription"),type:"success",showIcon:!0,style:{marginBottom:16}}),e.jsx(Re,{dataSource:p,columns:_,rowKey:"name",pagination:!1,size:"small","data-testid":"rclone-wizard-results-table"})]})});default:return null}})()]})},zs=({open:t,onCancel:s,machineName:a,teamName:r,bridgeName:n,onPullSelected:o,onClose:c,onQueueItemCreated:l})=>{const{t:d}=ze(["resources","common","machines"]),{data:m}=Te(),u=k(),h=b(),{data:p,isLoading:x}=G(r),{data:g,isLoading:f}=U(r),{data:j}=O(),{buildQueueVault:N}=A(),{mutateAsync:w}=le(),[C,S]=i.useState(!1),[T,I]=i.useState([]),[z,_]=i.useState(""),[M,D]=i.useState(""),[$,B]=i.useState(""),[V,R]=i.useState(""),[E,F]=i.useState("table"),P=i.useMemo(()=>{const e=[];return g&&g.length>0&&g.forEach(t=>{e.push({value:t.machineName,label:`${t.machineName} (Machine)`,type:"machine"})}),p&&p.length>0&&p.forEach(t=>{e.push({value:t.storageName,label:`${t.storageName} (Cloud Storage)`,type:"storage"})}),e},[g,p]);i.useEffect(()=>{!M&&a&&D(a)},[a,M]);const L=async()=>{if(M){S(!0);try{const s=P.find(e=>e.value===M),i="storage"===s?.type,o={},c=g?.find(e=>e.machineName===a);c&&c.vaultContent&&(o.machineVault=c.vaultContent);const l=j?.find(e=>e.teamName===r);if(l&&l.vaultContent&&(o.teamVault=l.vaultContent),!i&&M!==a){const t=g?.find(e=>e.machineName===M);if(t&&t.vaultContent)try{const e=JSON.parse(t.vaultContent);o.additionalMachineData={[M]:e}}catch(e){}}if(i){const t=p?.find(e=>e.storageName===M);if(t&&t.vaultContent)try{const e=JSON.parse(t.vaultContent);o.additionalStorageData={[M]:e}}catch(e){}}const m=await N({teamName:r,machineName:a,bridgeName:n,functionName:"list",params:{from:M,path:z||"",format:"json"},priority:4,description:`List files from ${M}`,addedVia:"file-browser",...o}),u=await w({teamName:r,machineName:a,bridgeName:n,queueVault:m,priority:4}),h=u.taskId||u.queueId;if(!h)throw new Error("Failed to create queue item - no taskId returned");if(u.isQueued)v("info","File listing has been queued. Please try again in a moment."),I([]);else{const s=await gs(h,3e4);if(s.success){let a=[],i="";try{const t=s.responseData?.result;if(!t&&!s.responseData)return void I([]);if("string"==typeof t)try{i=JSON.parse(t).command_output||""}catch(e){i=t}if("string"==typeof i)if(i.includes("DEBUG:")){const e=i.lastIndexOf("["),t=i.lastIndexOf("]");if(-1!==e&&-1!==t&&e<t){const s=i.substring(e,t+1);i=s}}else if(i.includes("[")){const e=i.indexOf("["),t=i.lastIndexOf("]");if(-1!==e&&-1!==t){const s=i.substring(e,t+1);i=s.replace(/\\\\/g,"\\").replace(/\\n/g,"\n")}}const r="string"==typeof i?JSON.parse(i):i;Array.isArray(r)?a=r.map(e=>({name:e.name||e.Name||"",size:parseInt(e.size||e.Size||"0"),isDirectory:void 0!==e.isDirectory?e.isDirectory:e.permissions?.startsWith("d")||e.IsDir||!1,modTime:e.date?`${e.date} ${e.time}`:e.ModTime,path:e.Path||(z?`${z}/${e.name||e.Name}`:e.name||e.Name)})):r.entries&&(a=r.entries.map(e=>({name:e.Name,size:e.Size||0,isDirectory:e.IsDir||!1,modTime:e.ModTime,mimeType:e.MimeType,path:e.Path||(z?`${z}/${e.Name}`:e.Name)})))}catch(t){if("string"==typeof i&&i.includes('"Path":')&&i.includes('"Name":')){const t=i.match(/\{[^}]+\}/g);t&&(a=t.map(t=>{try{const e=JSON.parse(t);return{name:e.Name||"",size:e.Size||0,isDirectory:e.IsDir||!1,modTime:e.ModTime,mimeType:e.MimeType,path:e.Path||(z?`${z}/${e.Name}`:e.Name)}}catch(e){return null}}).filter(e=>null!==e))}else{const e=("string"==typeof i?i:JSON.stringify(i)).trim().split("\n").filter(e=>e.trim());a=e.filter(e=>!(e.startsWith("Listing")||e.startsWith("Setting up")||e.startsWith("Error:")||e.startsWith("DEBUG:")||""===e.trim())).map(e=>{const t=e.match(/^\s*(\d+)\s+(.+)$/);if(t){const[,e,s]=t;return{name:s.trim(),size:parseInt(e),isDirectory:s.endsWith("/"),path:z?`${z}/${s.trim()}`:s.trim()}}return{name:e.trim(),size:0,isDirectory:e.endsWith("/"),path:z?`${z}/${e.trim()}`:e.trim()}})}}I(a.filter(e=>e.name))}else v("error",s.message||d("resources:remoteFiles.loadError")),I([])}}catch(s){v("error",s.message||d("resources:remoteFiles.loadError")),I([])}finally{S(!1)}}},W=e=>{_(e),B(""),I([])},q=i.useMemo(()=>V?T.filter(e=>e.name.toLowerCase().includes(V.toLowerCase())):T,[T,V]),K=[{title:d("resources:remoteFiles.name"),dataIndex:"name",key:"name",render:(t,s)=>e.jsxs(_e,{children:[s.isDirectory?e.jsx(Ge,{style:{color:"#1890ff"}}):e.jsx(We,{style:{color:"#666"}}),s.isDirectory?e.jsx("a",{onClick:()=>W(z?`${z}/${t}`:t),"data-testid":`file-browser-folder-${t}`,children:t}):e.jsx("span",{"data-testid":`file-browser-file-${t}`,children:t})]}),sorter:(e,t)=>e.isDirectory&&!t.isDirectory?-1:!e.isDirectory&&t.isDirectory?1:e.name.localeCompare(t.name)},{title:d("resources:remoteFiles.size"),dataIndex:"size",key:"size",width:120,render:(e,t)=>t.isDirectory?"-":(e=>{if(0===e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["B","KB","MB","GB","TB"][t]})(e),sorter:(e,t)=>e.size-t.size},{title:d("resources:remoteFiles.modified"),dataIndex:"modTime",key:"modTime",width:200,render:e=>e?yt(e):"-",sorter:(e,t)=>e.modTime&&t.modTime?new Date(e.modTime).getTime()-new Date(t.modTime).getTime():0}],Q=i.useMemo(()=>{const t=[{title:e.jsx("span",{"data-testid":"file-browser-breadcrumb-home",children:e.jsx(et,{})}),onClick:()=>W("")}];if(z){const s=z.split("/").filter(Boolean);s.forEach((a,i)=>{const r=s.slice(0,i+1).join("/");t.push({title:e.jsx("span",{"data-testid":`file-browser-breadcrumb-${a}`,children:a}),onClick:()=>W(r)})})}return t},[z]);return e.jsx($e,{"data-testid":"file-browser-modal",title:e.jsxs(_e,{children:[e.jsx(Ze,{}),d("resources:remoteFiles.title")]}),open:t,onCancel:s,className:y.Large,footer:[e.jsx(Fe,{title:d("common:actions.cancel"),children:e.jsx(Ee,{icon:e.jsx(Xe,{}),onClick:s,style:h.touchTarget,"data-testid":"file-browser-cancel-button","aria-label":d("common:actions.cancel")})},"cancel"),e.jsx(Fe,{title:d("common:actions.refresh"),children:e.jsx(Ee,{icon:e.jsx(Ye,{}),onClick:L,loading:C,style:h.touchTarget,"data-testid":"file-browser-refresh-button","aria-label":d("common:actions.refresh")})},"refresh"),e.jsx(Fe,{title:d("resources:remoteFiles.pull"),children:e.jsx(Ee,{type:"primary",icon:e.jsx(Ze,{}),onClick:async()=>{if(!$)return void v("warning",d("resources:remoteFiles.selectFile"));const e=T.find(e=>e.name===$);if(e)if(o)o([e],M),s();else{const i=e,o={},c=P.find(e=>e.value===M),m="storage"===c?.type,u=g?.find(e=>e.machineName===a);u&&u.vaultContent&&(o.machineVault=u.vaultContent);const h=j?.find(e=>e.teamName===r);if(h&&h.vaultContent&&(o.teamVault=h.vaultContent),m){const e=p?.find(e=>e.storageName===M);if(e&&e.vaultContent)try{const t=JSON.parse(e.vaultContent);o.additionalStorageData={[M]:t}}catch(t){}}if(!m&&M!==a){const e=g?.find(e=>e.machineName===M);if(e&&e.vaultContent)try{const t=JSON.parse(e.vaultContent);o.additionalMachineData={[M]:t}}catch(t){}}const y=await N({teamName:r,machineName:a,bridgeName:n,functionName:"pull",params:{from:M,repo:i.name,path:z||"",sourceType:m?"storage":"machine"},priority:3,description:`Pull ${i.name} from ${M}`,addedVia:"file-browser",...o}),x=await w({teamName:r,machineName:a,bridgeName:n,queueVault:y,priority:3});x?.taskId&&l?l(x.taskId,a):x?.isQueued&&v("info",d("resources:messages.pullOperationQueued")),v("success",d("resources:remoteFiles.pullStarted")),s()}},disabled:!$,style:h.touchTarget,"data-testid":"file-browser-pull-button","aria-label":d("resources:remoteFiles.pull")})},"pull")],children:e.jsxs(_e,{direction:"vertical",style:{width:"100%"},size:"middle",children:[e.jsxs("div",{"data-testid":"file-browser-source-container",children:[e.jsx("div",{style:{marginBottom:8,fontWeight:500},"data-testid":"file-browser-source-label",children:d("resources:remoteFiles.sourceLabel")}),e.jsxs(_e,{style:{width:"100%",justifyContent:"space-between"},children:[e.jsxs(_e,{children:[e.jsx(Ue,{style:{width:300},placeholder:d("resources:remoteFiles.selectSource"),value:M,onChange:e=>{D(e),_(""),B(""),I([])},loading:x||f,notFoundContent:x||f?e.jsx(Pe,{size:"small"}):0===P.length?e.jsx(qe,{image:qe.PRESENTED_IMAGE_SIMPLE,description:d("resources:remoteFiles.noSources")}):null,options:P,"data-testid":"file-browser-source-select"}),e.jsx(Fe,{title:d("resources:remoteFiles.loadFiles"),children:e.jsx(Ee,{icon:e.jsx(Ke,{}),onClick:L,loading:C,disabled:!M,style:h.touchTarget,"data-testid":"file-browser-load-files-button","aria-label":d("resources:remoteFiles.loadFiles")})})]}),e.jsx(Qe.Search,{placeholder:d("common:actions.search"),value:V,onChange:e=>R(e.target.value),style:{width:250},"data-testid":"file-browser-search-input"})]})]}),z&&e.jsx(He,{items:Q,separator:e.jsx(Je,{}),"data-testid":"file-browser-breadcrumb"}),e.jsx(Pe,{spinning:C,children:0===q.length?e.jsx(qe,{description:d(C?"common:general.loading":"resources:remoteFiles.noFiles"),"data-testid":"file-browser-empty-state"}):e.jsx(Re,{dataSource:q,columns:K,rowKey:"name",pagination:{pageSize:10,showSizeChanger:!0,showTotal:(e,t)=>d("common:table.showingRecords",{start:t[0],end:t[1],total:e})},rowSelection:{type:"radio",selectedRowKeys:$?[$]:[],onChange:e=>B(e[0]||""),getCheckboxProps:e=>({disabled:e.isDirectory})},scroll:{y:400},style:u.tableContainer,"data-testid":"file-browser-table",onRow:e=>({"data-testid":`file-browser-row-${e.name}`})})}),e.jsx(Ve,{type:"info",message:d("resources:remoteFiles.info"),showIcon:!0,"data-testid":"file-browser-info-alert"})]})})},_s=e=>{if(!e||"string"!=typeof e)return 0;const t=e.match(/^([\d.]+)\s*([KMGT]i?B?)?$/i);if(!t)return 0;const s=parseFloat(t[1]);if(isNaN(s))return 0;const a=(t[2]||"").toUpperCase();return s*({KI:1024,MI:1048576,GI:1073741824,TI:1099511627776,KIB:1024,MIB:1048576,GIB:1073741824,TIB:1099511627776}[a]||{KB:1e3,MB:1e6,GB:1e9,TB:1e12}[a]||{K:1024,M:1048576,G:1073741824,T:1099511627776,B:1}[a]||1)},Ms=(e,t,s)=>{if(e){const t=parseInt(e);if(!isNaN(t)&&t>=0)return Math.min(100,t)}if(!t||!s)return 0;const a=_s(t),i=_s(s);if(0===i)return 0;const r=Math.round(a/i*100);return Math.min(100,Math.max(0,r))},{Text:Ds}=Me,$s=({machine:t,onViewDetails:s,onManageAssignment:a})=>{const{t:i}=ze(["distributedStorage","machines"]),r=b(),n=!!t.distributedStorageClusterName,{data:o,isLoading:c}=de(t.machineName,t.teamName,!n),l=n?"CLUSTER":o?.assignmentType||"AVAILABLE",d=n?`Assigned to cluster: ${t.distributedStorageClusterName}`:o?.assignmentDetails;return c?e.jsx("div",{style:{...r.flexCenter,...r.padding.lg},"data-testid":"ds-section-loading",children:e.jsx(Pe,{})}):e.jsxs(e.Fragment,{children:[e.jsx(tt,{style:r.marginBottom.lg,"data-testid":"ds-section-divider",children:e.jsxs(_e,{style:r.flexCenter,children:[e.jsx(ht,{style:r.icon.medium}),e.jsx("span",{style:r.heading5,children:i("machineSection.title")})]})}),e.jsx(st,{size:"small","data-testid":"ds-section-card",style:{...r.card,border:"1px solid var(--color-border-secondary)"},children:e.jsxs(_e,{direction:"vertical",style:{width:"100%"},size:"middle",children:[e.jsxs("div",{children:[e.jsx(Ds,{type:"secondary",style:{display:"block",...r.marginBottom.xs,...r.label},"data-testid":"ds-section-assignment-label",children:i("assignment.currentAssignment")}),e.jsx(me,{assignmentType:l,assignmentDetails:d,size:"default","data-testid":"ds-section-assignment-badge"})]}),"AVAILABLE"!==l&&d&&e.jsx(Ve,{message:e.jsx("span",{style:r.body,children:d}),type:"info",icon:"CLUSTER"===l?e.jsx(ft,{style:r.icon.small}):"IMAGE"===l?e.jsx(C,{style:r.icon.small}):"CLONE"===l?e.jsx(jt,{style:r.icon.small}):e.jsx(ht,{style:r.icon.small}),showIcon:!0,style:{borderRadius:"var(--border-radius-lg)"},"data-testid":"ds-section-assignment-alert"}),e.jsxs(_e,{children:[s&&e.jsx(Ee,{size:"small",icon:e.jsx(S,{style:r.icon.small}),onClick:s,style:{...r.buttonSecondary,...r.touchTargetSmall},"data-testid":"ds-section-history-button",children:e.jsx("span",{style:r.caption,children:i("assignment.history")})}),a&&"AVAILABLE"!==l&&e.jsx(Ee,{size:"small",type:"primary",icon:e.jsx(be,{style:r.icon.small}),onClick:a,style:{...r.buttonPrimary,...r.touchTargetSmall},"data-testid":"ds-section-manage-button",children:e.jsx("span",{style:r.caption,children:i("machineSection.manageAssignment")})})]}),"AVAILABLE"!==l&&e.jsx(Ve,{message:e.jsx("span",{style:r.body,children:i("warnings.exclusivity")}),type:"warning",showIcon:!0,style:{...r.marginBottom.xs,borderRadius:"var(--border-radius-lg)"},"data-testid":"ds-section-exclusivity-warning"})]})})]})},{Text:Bs,Title:Vs}=Me,Rs=({machine:t,visible:s,onClose:a,splitView:r=!1})=>{const{t:n}=ze(["machines","resources","common","distributedStorage"]),{theme:o}=u(),c=b(),[l,d]=i.useState({open:!1,entityType:null,entityIdentifier:null}),m=i.useMemo(()=>{if(!t?.vaultStatus)return null;try{if(t.vaultStatus.trim().startsWith("jq:")||t.vaultStatus.trim().startsWith("error:")||!t.vaultStatus.trim().startsWith("{"))return null;const e=JSON.parse(t.vaultStatus);if("completed"===e.status&&e.result){let t=e.result;if(t.match(/(\}[\s\n]*$)/)){const e=t.lastIndexOf("}");e<t.length-10&&(t=t.substring(0,e+1))}const s=t.indexOf("\njq:");return s>0&&(t=t.substring(0,s)),t=t.trim(),JSON.parse(t)}}catch(e){}return null},[t]);return i.useEffect(()=>{const e=e=>{"Escape"===e.key&&s&&a()};return s&&document.addEventListener("keydown",e),()=>{document.removeEventListener("keydown",e)}},[s,a]),t&&s?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"machine-vault-status-panel",style:r?{height:"100%",backgroundColor:"dark"===o?"#141414":"#fff",overflowY:"auto",overflowX:"hidden"}:{position:"fixed",top:0,right:s?0:"-520px",bottom:0,width:"520px",maxWidth:"100vw",backgroundColor:"dark"===o?"#141414":"#fff",boxShadow:"-2px 0 8px rgba(0, 0, 0, 0.15)",zIndex:1e3,transition:"right 0.3s ease-in-out",overflowY:"auto",overflowX:"hidden"},children:[e.jsxs("div",{style:{padding:"16px 24px",borderBottom:"1px solid "+("dark"===o?"#303030":"#f0f0f0"),position:"sticky",top:0,backgroundColor:"dark"===o?"#141414":"#fff",zIndex:r?0:1},"data-testid":"vault-status-header",children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(_e,{children:[e.jsx(ht,{style:{fontSize:24,color:"#556b2f"}}),e.jsx(Vs,{level:4,style:{margin:0},"data-testid":"vault-status-machine-name",children:t.machineName})]}),e.jsx(Ee,{type:"text",icon:e.jsx(T,{}),onClick:a,style:c.touchTarget,"data-testid":"vault-status-close"})]}),e.jsxs(_e,{wrap:!0,style:{marginTop:8},children:[e.jsxs(De,{color:"#8FBC8F",icon:e.jsx(I,{}),"data-testid":"vault-status-team-tag",children:["Team: ",t.teamName]}),e.jsxs(De,{color:"green",icon:e.jsx(z,{}),"data-testid":"vault-status-bridge-tag",children:["Bridge: ",t.bridgeName]}),t.regionName&&e.jsxs(De,{color:"purple",icon:e.jsx(_,{}),"data-testid":"vault-status-region-tag",children:["Region: ",t.regionName]}),e.jsx(at,{count:t.queueCount,style:{backgroundColor:"#52c41a"},"data-testid":"vault-status-queue-badge",children:e.jsx(De,{color:"blue",children:n("machines:queueItems")})}),e.jsxs(De,{color:"blue","data-testid":"vault-status-version-tag",children:[n("machines:vaultVersion"),": ",t.vaultVersion]})]}),t.vaultStatusTime&&e.jsx("div",{style:{marginTop:8},children:e.jsxs(Bs,{type:"secondary",style:{fontSize:12},title:gt(t.vaultStatusTime,"datetime"),"data-testid":"vault-status-last-updated",children:[n("machines:lastUpdated"),": ",xt(t.vaultStatusTime,n)]})})]}),e.jsx("div",{style:{padding:"24px"},"data-testid":"vault-status-content",children:m?e.jsxs(e.Fragment,{children:[m.system&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:16},children:[e.jsx(R,{style:{fontSize:20,color:"#556b2f"}}),e.jsx(Vs,{level:5,style:{margin:0},"data-testid":"vault-status-system-info-title",children:n("resources:repositories.systemInfo")})]}),e.jsxs(it,{gutter:[16,16],style:c.marginBottom.md,children:[e.jsx(rt,{span:12,children:e.jsx(st,{size:"small",style:{height:"100%"},"data-testid":"vault-status-hostname-card",children:e.jsx(nt,{title:n("resources:repositories.hostname"),value:m.system.hostname,prefix:e.jsx(ht,{}),valueStyle:{fontSize:16}})})}),e.jsx(rt,{span:12,children:e.jsx(st,{size:"small",style:{height:"100%"},"data-testid":"vault-status-uptime-card",children:e.jsx(nt,{title:n("resources:repositories.uptime"),value:m.system.uptime,prefix:e.jsx(vt,{}),valueStyle:{fontSize:16}})})}),e.jsx(rt,{span:24,children:e.jsx(st,{size:"small","data-testid":"vault-status-os-info-card",children:e.jsxs(_e,{direction:"vertical",style:{width:"100%"},size:"small",children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsxs(Bs,{type:"secondary",children:[n("resources:repositories.osName"),":"]}),e.jsx(Bs,{strong:!0,"data-testid":"vault-status-os-name",children:m.system.os_name})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsxs(Bs,{type:"secondary",children:[n("resources:repositories.kernel"),":"]}),e.jsx(Bs,{"data-testid":"vault-status-kernel",children:m.system.kernel})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsxs(Bs,{type:"secondary",children:[n("resources:repositories.cpu"),":"]}),e.jsxs(Bs,{"data-testid":"vault-status-cpu",children:[m.system.cpu_count," × ",m.system.cpu_model]})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsxs(Bs,{type:"secondary",children:[n("resources:repositories.systemTime"),":"]}),e.jsxs(Bs,{"data-testid":"vault-status-system-time",children:[m.system.system_time_human," (",m.system.timezone,")"]})]})]})})})]}),e.jsx(tt,{style:{margin:"24px 0"},children:e.jsxs(_e,{children:[e.jsx(N,{}),n("resources:repositories.resourceUsage")]})}),e.jsxs(it,{gutter:[16,16],style:c.marginBottom.lg,children:[e.jsx(rt,{span:24,children:e.jsxs(st,{size:"small","data-testid":"vault-status-memory-card",children:[e.jsx("div",{style:{marginBottom:12},children:e.jsxs(_e,{children:[e.jsx(ft,{style:{color:"#1890ff"}}),e.jsx(Bs,{strong:!0,children:n("resources:repositories.memory")})]})}),e.jsx("div",{style:{marginBottom:8},children:e.jsxs(Bs,{children:[m.system.memory.used," / ",m.system.memory.total]})}),e.jsx(Be,{percent:Ms(void 0,m.system.memory.used,m.system.memory.total),strokeColor:"#1890ff",trailColor:"dark"===o?"rgba(255,255,255,0.08)":void 0}),e.jsxs(Bs,{type:"secondary",style:{fontSize:12},children:[n("resources:repositories.available"),": ",m.system.memory.available]})]})}),e.jsx(rt,{span:24,children:e.jsxs(st,{size:"small","data-testid":"vault-status-disk-card",children:[e.jsx("div",{style:{marginBottom:12},children:e.jsxs(_e,{children:[e.jsx(C,{style:{color:"#fa8c16"}}),e.jsx(Bs,{strong:!0,children:n("resources:repositories.rootDisk")})]})}),e.jsx("div",{style:{marginBottom:8},children:e.jsxs(Bs,{children:[m.system.disk.used," / ",m.system.disk.total]})}),e.jsx(Be,{percent:Ms(m.system.disk.use_percent,m.system.disk.used,m.system.disk.total),status:(parseInt(m.system.disk.use_percent)||0)>90?"exception":"normal",strokeColor:(parseInt(m.system.disk.use_percent)||0)>90?"#ff4d4f":"#fa8c16",trailColor:"dark"===o?"rgba(255,255,255,0.08)":void 0}),e.jsxs(Bs,{type:"secondary",style:{fontSize:12},children:[n("resources:repositories.available"),": ",m.system.disk.available]})]})}),m.system.datastore?.path&&e.jsx(rt,{span:24,children:e.jsxs(st,{size:"small","data-testid":"vault-status-datastore-card",children:[e.jsx("div",{style:{marginBottom:12},children:e.jsxs(_e,{children:[e.jsx(ft,{style:{color:"#52c41a"}}),e.jsx(Bs,{strong:!0,children:n("resources:repositories.datastore")})]})}),e.jsx(Bs,{type:"secondary",style:{fontSize:11,display:"block",marginBottom:8,wordBreak:"break-all"},children:m.system.datastore.path}),e.jsx("div",{style:{marginBottom:8},children:e.jsxs(Bs,{children:[m.system.datastore.used," / ",m.system.datastore.total]})}),e.jsx(Be,{percent:Ms(m.system.datastore.use_percent,m.system.datastore.used,m.system.datastore.total),status:(parseInt(m.system.datastore.use_percent)||0)>90?"exception":"normal",strokeColor:(parseInt(m.system.datastore.use_percent)||0)>90?"#ff4d4f":"#52c41a",trailColor:"dark"===o?"rgba(255,255,255,0.08)":void 0}),e.jsxs(Bs,{type:"secondary",style:{fontSize:12},children:[n("resources:repositories.available"),": ",m.system.datastore.available]})]})})]})]}),m.network&&e.jsxs(e.Fragment,{children:[e.jsx(tt,{style:{margin:"24px 0"},children:e.jsxs(_e,{children:[e.jsx(P,{}),n("resources:repositories.networkInfo")]})}),m.network.default_gateway&&e.jsx(st,{size:"small",style:{marginBottom:16},"data-testid":"vault-status-gateway-card",children:e.jsxs(_e,{direction:"vertical",style:{width:"100%"},size:"small",children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsxs(Bs,{type:"secondary",children:[n("resources:repositories.defaultGateway"),":"]}),e.jsx(Bs,{strong:!0,"data-testid":"vault-status-gateway",children:m.network.default_gateway})]}),m.network.default_interface&&e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsxs(Bs,{type:"secondary",children:[n("resources:repositories.defaultInterface"),":"]}),e.jsx(Bs,{"data-testid":"vault-status-interface",children:m.network.default_interface})]})]})}),e.jsx(ot,{dataSource:m.network.interfaces.filter(e=>"unknown"!==e.state&&"lo"!==e.name),style:c.marginBottom.lg,"data-testid":"vault-status-network-list",renderItem:t=>e.jsxs(st,{size:"small",style:{marginBottom:12},"data-testid":`vault-status-network-${t.name}`,children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12},children:[e.jsxs(_e,{children:[e.jsx(ns,{style:{color:"#1890ff"}}),e.jsx(Bs,{strong:!0,"data-testid":`vault-status-network-name-${t.name}`,children:t.name})]}),e.jsx(De,{color:"UP"===t.state?"success":"default","data-testid":`vault-status-network-state-${t.name}`,children:t.state})]}),e.jsxs(_e,{direction:"vertical",style:{width:"100%"},size:"small",children:[t.ipv4_addresses.length>0&&e.jsxs("div",{children:[e.jsxs(Bs,{type:"secondary",children:[n("resources:repositories.ipAddresses"),":"]}),t.ipv4_addresses.map((t,s)=>e.jsx("div",{style:{marginLeft:16},children:e.jsx(De,{color:"blue","data-testid":`vault-status-ip-${t}`,children:t})},s))]}),t.mac_address&&"unknown"!==t.mac_address&&e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsxs(Bs,{type:"secondary",children:[n("resources:repositories.macAddress"),":"]}),e.jsx(Bs,{style:{fontSize:12},children:t.mac_address})]}),t.mtu>0&&e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsx(Bs,{type:"secondary",children:"MTU:"}),e.jsx(Bs,{children:t.mtu})]})]})]})})]}),m.block_devices&&m.block_devices.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(tt,{style:{margin:"24px 0"},children:e.jsxs(_e,{children:[e.jsx(C,{}),n("resources:repositories.blockDevices")]})}),e.jsx(ot,{dataSource:m.block_devices,style:c.marginBottom.lg,"data-testid":"vault-status-block-devices-list",renderItem:t=>e.jsxs(st,{size:"small",style:{marginBottom:12},"data-testid":`vault-status-block-device-${t.name}`,children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12},children:[e.jsxs(_e,{children:[e.jsx(C,{style:{color:"#fa8c16"}}),e.jsx(Bs,{strong:!0,"data-testid":`vault-status-device-path-${t.name}`,children:t.path})]}),e.jsxs(_e,{children:[e.jsx(De,{"data-testid":`vault-status-device-type-${t.name}`,children:t.type}),e.jsx(De,{color:"blue","data-testid":`vault-status-device-size-${t.name}`,children:t.size_human})]})]}),e.jsxs(_e,{direction:"vertical",style:{width:"100%"},size:"small",children:[t.model&&"Unknown"!==t.model&&e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsxs(Bs,{type:"secondary",children:[n("resources:repositories.model"),":"]}),e.jsx(Bs,{style:{fontSize:12},children:t.model})]}),t.partitions.length>0&&e.jsxs("div",{children:[e.jsxs(Bs,{type:"secondary",children:[n("resources:repositories.partitions"),":"]}),e.jsx("div",{style:{marginLeft:16,marginTop:8},children:t.partitions.map((t,s)=>e.jsx("div",{style:{marginBottom:4},children:e.jsxs(_e,{children:[e.jsx(Ie,{style:{fontSize:12}}),e.jsxs(Bs,{style:{fontSize:12},children:[t.name,": ",t.size_human,t.filesystem&&` (${t.filesystem})`,t.mountpoint&&` → ${t.mountpoint}`]})]})},s))})]})]})]})})]}),m.system_containers&&m.system_containers.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(tt,{style:{margin:"24px 0"},children:e.jsxs(_e,{children:[e.jsx(Ot,{}),n("resources:repositories.systemContainers")]})}),e.jsx(ot,{dataSource:m.system_containers,style:c.marginBottom.lg,"data-testid":"vault-status-containers-list",renderItem:t=>e.jsxs(st,{size:"small",style:{marginBottom:12},"data-testid":`vault-status-container-${t.id}`,children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12},children:[e.jsxs(_e,{children:[e.jsx(Ot,{style:{color:"#722ed1"}}),e.jsx(Bs,{strong:!0,"data-testid":`vault-status-container-name-${t.id}`,children:t.name})]}),e.jsx(De,{color:"running"===t.state?"success":"default","data-testid":`vault-status-container-state-${t.id}`,children:t.state})]}),e.jsxs(_e,{direction:"vertical",style:{width:"100%"},size:"small",children:[e.jsx(Bs,{type:"secondary",style:{fontSize:12},ellipsis:!0,children:t.image}),t.cpu_percent&&e.jsxs(_e,{style:{width:"100%",justifyContent:"space-between"},children:[e.jsx(Bs,{type:"secondary",children:"CPU:"}),e.jsx(Bs,{children:t.cpu_percent})]}),t.memory_usage&&e.jsxs(_e,{style:{width:"100%",justifyContent:"space-between"},children:[e.jsxs(Bs,{type:"secondary",children:[n("resources:repositories.memory"),":"]}),e.jsx(Bs,{children:t.memory_usage})]})]})]})})]}),t&&e.jsx("div",{"data-testid":"vault-status-distributed-storage",children:e.jsx($s,{machine:t,onViewDetails:()=>{d({open:!0,entityType:"Machine",entityIdentifier:t.machineName,entityName:t.machineName})}})})]}):e.jsx(qe,{description:n("machines:noVaultData"),style:{marginTop:48},"data-testid":"vault-status-empty"})})]}),e.jsx(dt,{open:l.open,onCancel:()=>d({open:!1,entityType:null,entityIdentifier:null}),entityType:l.entityType,entityIdentifier:l.entityIdentifier,entityName:l.entityName})]}):null},Es=({teamFilter:s,showActions:a=!0,className:n="",onEditMachine:o,onFunctionsMachine:c,onDeleteMachine:l,onCreateRepository:d,enabled:m=!0,onQueueItemCreated:u,expandedRowKeys:h,onExpandedRowsChange:p,refreshKeys:y,onRowClick:x,selectedMachine:g,onMachineRepositoryClick:f,onMachineContainerClick:w,onRefreshMachines:k})=>{const{t:C}=ze(["machines","common","functions","resources"]),T=t(e=>e.ui.uiMode),I="expert"===T,{executePingForMachineAndWait:z}=bs(),D=b(),$=i.useRef(null),[V,E]=i.useState("machine"),[F,A]=i.useState([]),[O,L]=i.useState({}),[G,W]=i.useState({}),[Q,H]=i.useState(!1),[J,X]=i.useState(null),[Y,Z]=i.useState(null),[ee,te]=i.useState(!1),[se,ae]=i.useState([]),ie=void 0!==h?h:F,re=p||A,ne=void 0!==y?y:G,[ce,le]=i.useState({open:!1,entityType:null,entityIdentifier:null}),[de,me]=i.useState({open:!1,machine:null}),[je,ve]=i.useState({open:!1,machine:null}),[we,ke]=i.useState(!1),[Ce,Se]=i.useState(!1),[Te,Ie]=i.useState(!1),[Me,$e]=i.useState(null),[Be,Ve]=i.useState(!1);r.useEffect(()=>()=>{J&&clearTimeout(J)},[J]);const{data:Ae=[],isLoading:Oe,refetch:Pe}=U(s,m),{data:Le=[]}=q(s),Ge=pt($,{containerOffset:170,minRows:5,maxRows:50}),We=Ae,Ue=e=>{try{if(!e.vaultStatus||e.vaultStatus.trim().startsWith("jq:")||e.vaultStatus.trim().startsWith("error:")||!e.vaultStatus.trim().startsWith("{"))return[];const t=JSON.parse(e.vaultStatus);if("completed"===t.status&&t.result){let e=t.result;if(e.match(/(\}[\s\n]*$)/)){const t=e.lastIndexOf("}");t<e.length-10&&(e=e.substring(0,t+1))}const s=e.indexOf("\njq:");s>0&&(e=e.substring(0,s)),e=e.trim();const a=JSON.parse(e);if(a?.repositories&&Array.isArray(a.repositories))return a.repositories.map(e=>{if(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(e.name)){const t=Le.find(t=>t.repositoryGuid===e.name);if(t)return{...e,name:t.repositoryName,repositoryGuid:t.repositoryGuid,grandGuid:t.grandGuid}}return e})}}catch(t){}return[]},Ke=i.useCallback(e=>{l&&l(e)},[l]),Qe=i.useCallback(e=>{x?x(e):($e(e),Ve(!0))},[x]),He=i.useCallback(()=>{Ve(!1),$e(null)},[]),{getFunctionsByCategory:Je}=K(),Xe=i.useMemo(()=>Je("machine").filter(e=>e&&!1!==e.showInMenu&&"mount"!==e.name&&"pull"!==e.name),[Je]),Ye=r.useMemo(()=>{const t=[];return t.push({title:C("machines:machineName"),dataIndex:"machineName",key:"machineName",ellipsis:!0,sorter:(e,t)=>e.machineName.localeCompare(t.machineName),render:(t,s)=>{const a=ie.includes(s.machineName);return e.jsxs(_e,{children:[e.jsx("span",{style:{display:"inline-block",width:12,transition:"transform 0.3s ease",transform:a?"rotate(90deg)":"rotate(0deg)"},"data-testid":`machine-expand-${s.machineName}`,children:e.jsx(be,{style:{fontSize:12,color:"#999"}})}),e.jsx(R,{style:{color:"#556b2f"}}),e.jsx("strong",{children:t})]})}}),x||t.push({title:C("machines:team"),dataIndex:"teamName",key:"teamName",width:150,ellipsis:!0,render:t=>e.jsx(De,{color:"#8FBC8F",children:t}),sorter:(e,t)=>e.teamName.localeCompare(t.teamName)}),x||(I?t.push({title:C("machines:region"),dataIndex:"regionName",key:"regionName",width:150,ellipsis:!0,render:t=>t?e.jsx(De,{color:"purple",children:t}):"-",sorter:(e,t)=>(e.regionName||"").localeCompare(t.regionName||"")},{title:C("machines:bridge"),dataIndex:"bridgeName",key:"bridgeName",width:150,ellipsis:!0,render:t=>e.jsx(De,{color:"green",children:t}),sorter:(e,t)=>e.bridgeName.localeCompare(t.bridgeName)}):"simple"!==T&&t.push({title:C("bridges.bridge"),dataIndex:"bridgeName",key:"bridgeName",width:150,ellipsis:!0,render:t=>e.jsx(De,{color:"#8FBC8F",children:t})})),!x&&I&&t.push({title:C("machines:assignmentStatus.title"),key:"assignmentStatus",width:180,ellipsis:!0,render:(t,s)=>e.jsx(ue,{machine:s})}),x||t.push({title:C("machines:queueItems"),dataIndex:"queueCount",key:"queueCount",width:100,align:"center",sorter:(e,t)=>e.queueCount-t.queueCount,render:t=>e.jsx(at,{count:t,showZero:!0,style:{backgroundColor:t>0?"#52c41a":"#d9d9d9"}})}),a&&t.push({title:C("common:table.actions"),key:"actions",width:j.DIMENSIONS.CARD_WIDTH,render:(t,s)=>e.jsxs(_e,{children:[e.jsx(Fe,{title:C("common:actions.edit"),children:e.jsx(Ee,{type:"primary",size:"small",icon:e.jsx(B,{}),onClick:()=>o&&o(s),"data-testid":`machine-edit-${s.machineName}`,"aria-label":C("common:actions.edit")})}),e.jsx(ct,{"data-testid":`machine-dropdown-${s.machineName}`,menu:{items:[{key:"createRepo",label:C("machines:createRepo"),icon:e.jsx(oe,{}),onClick:()=>d&&d(s),"data-testid":`machine-create-repo-${s.machineName}`},{key:"pull",label:C("functions:functions.pull.name"),icon:e.jsx(xs,{}),onClick:()=>{me({open:!0,machine:s})},"data-testid":`machine-pull-${s.machineName}`},{key:"functions",label:C("machines:runAction"),icon:e.jsx(he,{}),"data-testid":`machine-functions-${s.machineName}`,children:[...Xe.map(t=>({key:`function-${t?.name||"unknown"}`,label:e.jsx("span",{title:t?.description||"",children:t?.name||"Unknown"}),onClick:()=>{c&&t?.name&&(c(s,t.name),void 0===y&&W(e=>({...e,[s.machineName]:Date.now()})))},"data-testid":`machine-function-${t?.name||"unknown"}-${s.machineName}`})),{type:"divider"},{key:"advanced",label:C("machines:advanced"),icon:e.jsx(he,{}),onClick:()=>{c&&(c(s),void 0===y&&W(e=>({...e,[s.machineName]:Date.now()})))},"data-testid":`machine-advanced-${s.machineName}`}]},{key:"test",label:C("machines:connectivityTest"),icon:e.jsx(P,{}),onClick:async()=>{v("info",C("machines:testingConnection"));const e=await z(s,{priority:4,description:"Connectivity test",addedVia:"machine-table",timeout:15e3});e.success?v("success",C("machines:connectionSuccessful")):v("error",e.error||C("machines:connectionFailed"))},"data-testid":`machine-test-${s.machineName}`},...I?[{key:"assignCluster",label:s.distributedStorageClusterName?C("machines:changeClusterAssignment"):C("machines:assignToCluster"),icon:e.jsx(ht,{}),onClick:()=>{ve({open:!0,machine:s})},"data-testid":`machine-assign-cluster-${s.machineName}`}]:[]]},trigger:["click"],children:e.jsx(Fe,{title:C("machines:remote"),children:e.jsx(Ee,{type:"primary",size:"small",icon:e.jsx(he,{}),"data-testid":`machine-remote-${s.machineName}`,"aria-label":C("machines:remote")})})}),e.jsx(Fe,{title:C("machines:trace"),children:e.jsx(Ee,{type:"primary",size:"small",icon:e.jsx(S,{}),onClick:()=>{le({open:!0,entityType:"Machine",entityIdentifier:s.machineName,entityName:s.machineName})},"data-testid":`machine-trace-${s.machineName}`,"aria-label":C("machines:trace")})}),e.jsx(Fe,{title:C("common:actions.delete"),children:e.jsx(Ee,{type:"primary",danger:!0,size:"small",icon:e.jsx(M,{}),onClick:()=>Ke(s),"data-testid":`machine-delete-${s.machineName}`,"aria-label":C("common:actions.delete")})}),e.jsx(pe,{machine:s.machineName,teamName:s.teamName})]})}),t},[I,T,a,C,Ke,o,c,d,z,Xe,ie,y,W,ve,le,me,x]),Ze=I?{selectedRowKeys:se,onChange:e=>{ae(e)},getCheckboxProps:e=>({disabled:!1,"data-testid":`machine-checkbox-${e.machineName}`})}:void 0,et=i.useMemo(()=>{const e={};return"machine"===V||We.forEach(t=>{let s="";if("bridge"===V)s=t.bridgeName;else if("team"===V)s=t.teamName;else if("region"===V)s=t.regionName||"Unknown";else{if("repository"===V){const s=Ue(t);if(0===s.length)return;return void s.forEach(s=>{const a=s.name;e[a]||(e[a]=[]),e[a].find(e=>e.machineName===t.machineName)||e[a].push(t)})}if("status"===V){const e=Ue(t);if(0===e.length)s="No Repositories";else{const t=e.some(e=>!e.accessible),a=e.some(e=>e.mounted&&e.docker_running),i=e.some(e=>e.mounted&&!e.docker_running),r=e.some(e=>!e.mounted);s=t?"Inaccessible":a?"Active (Running)":i?"Ready (Stopped)":r?"Not Mounted":"Unknown Status"}}else if("grand"===V){const s=Ue(t);if(0===s.length)return;return void s.forEach(s=>{let a="No Grand Repository";if(s.grandGuid){const e=Le.find(e=>e.repositoryGuid===s.grandGuid);e&&(a=e.repositoryName)}e[a]||(e[a]=[]),e[a].find(e=>e.machineName===t.machineName)||e[a].push(t)})}}s&&(e[s]||(e[s]=[]),e[s].push(t))}),e},[We,V,Le,Ue]);return e.jsxs("div",{className:n,children:[e.jsx("div",{style:{marginBottom:16},children:e.jsxs(_e,{wrap:!0,size:"small",children:[e.jsx(Fe,{title:C("machines:machine"),children:e.jsx(Ee,{type:"machine"===V?"primary":"default",icon:e.jsx(R,{}),onClick:()=>E("machine"),style:D.touchTargetSmall,"data-testid":"machine-view-toggle-machine","aria-label":C("machines:machine")})}),e.jsx("div",{style:{width:1,height:24,backgroundColor:"var(--color-border)",margin:"0 8px"}}),e.jsx(Fe,{title:C("machines:groupByBridge"),children:e.jsx(Ee,{type:"bridge"===V?"primary":"default",icon:e.jsx(ht,{}),onClick:()=>E("bridge"),style:D.touchTargetSmall,"data-testid":"machine-view-toggle-bridge","aria-label":C("machines:groupByBridge")})}),e.jsx(Fe,{title:C("machines:groupByTeam"),children:e.jsx(Ee,{type:"team"===V?"primary":"default",icon:e.jsx(ut,{}),onClick:()=>E("team"),style:D.touchTargetSmall,"data-testid":"machine-view-toggle-team","aria-label":C("machines:groupByTeam")})}),I&&e.jsx(Fe,{title:C("machines:groupByRegion"),children:e.jsx(Ee,{type:"region"===V?"primary":"default",icon:e.jsx(_,{}),onClick:()=>E("region"),style:D.touchTargetSmall,"data-testid":"machine-view-toggle-region","aria-label":C("machines:groupByRegion")})}),e.jsx(Fe,{title:C("machines:groupByRepository"),children:e.jsx(Ee,{type:"repository"===V?"primary":"default",icon:e.jsx(oe,{}),onClick:()=>E("repository"),style:D.touchTargetSmall,"data-testid":"machine-view-toggle-repository","aria-label":C("machines:groupByRepository")})}),e.jsx(Fe,{title:C("machines:groupByStatus"),children:e.jsx(Ee,{type:"status"===V?"primary":"default",icon:e.jsx(Ne,{}),onClick:()=>E("status"),style:D.touchTargetSmall,"data-testid":"machine-view-toggle-status","aria-label":C("machines:groupByStatus")})}),e.jsx(Fe,{title:C("machines:groupByGrand"),children:e.jsx(Ee,{type:"grand"===V?"primary":"default",icon:e.jsx(Jt,{}),onClick:()=>E("grand"),style:D.touchTargetSmall,"data-testid":"machine-view-toggle-grand","aria-label":C("machines:groupByGrand")})})]})}),I&&0!==se.length?e.jsxs("div",{style:{marginBottom:16,padding:"12px 16px",backgroundColor:"#f0f2f5",borderRadius:8,display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs(_e,{children:[e.jsx("span",{style:{fontWeight:500},children:C("machines:bulkActions.selected",{count:se.length})}),e.jsx(Fe,{title:C("common:actions.clearSelection"),children:e.jsx(Ee,{size:"small",onClick:()=>ae([]),"data-testid":"machine-bulk-clear-selection","aria-label":C("common:actions.clearSelection")})})]}),e.jsxs(_e,{children:[e.jsx(Fe,{title:C("machines:bulkActions.assignToCluster"),children:e.jsx(Ee,{type:"primary",icon:e.jsx(ht,{}),onClick:()=>ke(!0),"data-testid":"machine-bulk-assign-cluster","aria-label":C("machines:bulkActions.assignToCluster")})}),e.jsx(Fe,{title:C("machines:bulkActions.removeFromCluster"),children:e.jsx(Ee,{icon:e.jsx(ht,{}),onClick:()=>Se(!0),"data-testid":"machine-bulk-remove-cluster","aria-label":C("machines:bulkActions.removeFromCluster")})}),e.jsx(Fe,{title:C("machines:bulkActions.viewAssignmentStatus"),children:e.jsx(Ee,{icon:e.jsx(N,{}),onClick:()=>Ie(!0),"data-testid":"machine-bulk-view-status","aria-label":C("machines:bulkActions.viewAssignmentStatus")})})]})]}):null,"machine"===V?e.jsx("div",{ref:$,style:{flex:1,display:"flex",flexDirection:"column",overflow:"hidden"},children:e.jsx(Re,{columns:Ye,dataSource:We,rowKey:"machineName",loading:Oe,scroll:{x:!0,y:"calc(100vh - 400px)"},rowSelection:Ze,rowClassName:e=>g?.machineName===e.machineName?"ant-table-row-selected":"","data-testid":"machine-table",pagination:{pageSize:Ge,showSizeChanger:!1,showTotal:(e,t)=>C("common:table.showingRecords",{start:t[0],end:t[1],total:e})},onRow:e=>({"data-testid":`machine-row-${e.machineName}`,onClick:t=>{const s=t.target;if(s.closest("button")||s.closest(".ant-dropdown-trigger"))return;if(ie.includes(e.machineName))re(ie.filter(t=>t!==e.machineName));else if(re([...ie,e.machineName]),L(t=>({...t,[e.machineName]:Date.now()})),k){Z(e.machineName),te(!0);const t=setTimeout(()=>{H(!0)},1e3);X(t),k().finally(()=>{J&&clearTimeout(J),te(!1),H(!1),Z(null),X(null)})}x&&Qe(e)},style:{cursor:"pointer",transition:"background-color 0.3s ease"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor="rgba(0, 0, 0, 0.02)"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor=""}}),expandable:{expandedRowRender:t=>e.jsx(ye,{machine:t,refreshKey:ne[t.machineName],onActionComplete:()=>{void 0===y&&W(e=>({...e,[t.machineName]:Date.now()}))},onRepositoryClick:e=>f?.(t,e),onContainerClick:e=>w?.(t,e),onCreateRepository:d,isLoading:Q&&Y===t.machineName,onRefreshMachines:k,onQueueItemCreated:u},`${t.machineName}-${O[t.machineName]||0}-${ne[t.machineName]||0}`),rowExpandable:()=>!0,expandedRowKeys:ie,onExpandedRowsChange:e=>{const t=e;re(t);const s={...O};t.forEach(e=>{ie.includes(e)||(s[e]=Date.now())}),L(s)},expandIcon:()=>null,expandRowByClick:!1},sticky:!0})}):(()=>{const t=()=>{switch(V){case"machine":case"repository":return"#556b2f";case"bridge":return"green";case"team":return"#8FBC8F";case"region":return"purple";case"status":return"geekblue";case"grand":return"blue";default:return"default"}};if(0===Object.keys(et).length)return e.jsx(qe,{image:qe.PRESENTED_IMAGE_SIMPLE,description:C("resources:repositories.noRepositories"),style:{marginTop:48}});const s=e=>e%2==0?"rgba(0, 0, 0, 0.02)":"transparent",a=e=>e%2==0?"rgba(0, 0, 0, 0.08)":"#f0f0f0",i=e=>e%2==0?"#595959":"transparent";return e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:32},children:Object.entries(et).map(([r,n],o)=>e.jsx(st,{title:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,padding:"8px 0"},children:[o%2==0&&e.jsx("div",{style:{width:4,height:j.DIMENSIONS.ICON_XL,backgroundColor:i(o),borderRadius:2}}),e.jsxs(_e,{children:[e.jsxs("span",{style:{fontSize:"18px",fontWeight:"bold",color:"#333",marginRight:8},children:["#",o+1]}),e.jsx(De,{color:t(),style:{fontSize:"16px",padding:"4px 16px",fontWeight:500},icon:"bridge"===V?e.jsx(ht,{}):"team"===V?e.jsx(ut,{}):"region"===V?e.jsx(_,{}):"repository"===V?e.jsx(oe,{}):"status"===V?e.jsx(Ne,{}):"grand"===V?e.jsx(Jt,{}):null,children:r}),e.jsxs("span",{style:{fontSize:"14px",color:"#666"},children:[n.length," ",1===n.length?C("machines:machine"):C("machines:machines")]})]})]}),styles:{body:{padding:0,backgroundColor:s(o)}},style:{borderColor:a(o),borderWidth:2,boxShadow:"0 2px 8px rgba(0, 0, 0, 0.06)"},headStyle:{backgroundColor:s(o),borderBottom:`2px solid ${a(o)}`},children:n.map((t,s)=>e.jsx("div",{style:{borderBottom:s<n.length-1?`1px solid ${a(o)}`:"none",backgroundColor:s%2==0?"transparent":"rgba(0, 0, 0, 0.01)"},children:e.jsx(ye,{machine:t,refreshKey:ne[t.machineName],onActionComplete:()=>{void 0===y&&W(e=>({...e,[t.machineName]:Date.now()}))},onRepositoryClick:e=>f?.(t,e),onContainerClick:e=>w?.(t,e),onCreateRepository:d,hideSystemInfo:!0,isLoading:Q&&Y===t.machineName,onRefreshMachines:k,onQueueItemCreated:u},`${t.machineName}-${O[t.machineName]||0}-${ne[t.machineName]||0}`)},t.machineName))},r))})})(),e.jsx(dt,{open:ce.open,onCancel:()=>le({open:!1,entityType:null,entityIdentifier:null}),entityType:ce.entityType,entityIdentifier:ce.entityIdentifier,entityName:ce.entityName}),de.machine&&e.jsx(zs,{open:de.open,onCancel:()=>me({open:!1,machine:null}),machineName:de.machine.machineName,teamName:de.machine.teamName,bridgeName:de.machine.bridgeName,onQueueItemCreated:u}),je.machine&&e.jsx(xe,{open:je.open,machine:je.machine,onCancel:()=>ve({open:!1,machine:null}),onSuccess:()=>{ve({open:!1,machine:null}),Pe()}}),e.jsx(xe,{open:we,machines:Ae.filter(e=>se.includes(e.machineName)),onCancel:()=>ke(!1),onSuccess:()=>{ke(!1),ae([]),Pe()}}),e.jsx(ge,{open:Ce,machines:Ae.filter(e=>se.includes(e.machineName)),onCancel:()=>Se(!1),onSuccess:()=>{Se(!1),ae([]),Pe()}}),e.jsx(fe,{open:Te,machines:Ae.filter(e=>se.includes(e.machineName)),onCancel:()=>Ie(!1)}),!x&&e.jsx(Rs,{machine:Me,visible:Be,onClose:He})]})},{Text:Fs,Title:As}=Me,Os=({repository:t,visible:s,onClose:a,splitView:r=!1})=>{const{t:n}=ze(["resources","common","machines"]),{theme:o}=u(),{data:c=[]}=U(t?.teamName),l=b(),d=i.useMemo(()=>{if(!t||!c.length)return null;for(const s of c)if(s.vaultStatus)try{if(s.vaultStatus.trim().startsWith("jq:")||s.vaultStatus.trim().startsWith("error:")||!s.vaultStatus.trim().startsWith("{"))continue;const e=JSON.parse(s.vaultStatus);if("completed"===e.status&&e.result){let a=e.result;if(a.match(/(\}[\s\n]*$)/)){const e=a.lastIndexOf("}");e<a.length-10&&(a=a.substring(0,e+1))}const i=a.indexOf("\njq:");i>0&&(a=a.substring(0,i)),a=a.trim();const r=JSON.parse(a);if(r.repositories&&Array.isArray(r.repositories)){const e=r.repositories.find(e=>e.name===t.repositoryName||e.name===t.repositoryGuid);if(e){const a=[];return r.services&&Array.isArray(r.services)&&r.services.forEach(s=>{if(s.repository===e.name||s.repository===t.repositoryGuid)a.push(s);else if(s.service_name||s.unit_file){const i=(s.service_name||s.unit_file||"").match(/rediacc_([0-9a-f-]{36})_/);!i||i[1]!==t.repositoryGuid&&i[1]!==e.name||a.push(s)}}),{machine:s,repositoryData:e,systemData:r.system,services:a}}}}}catch(e){}return null},[t,c]);return i.useEffect(()=>{const e=e=>{"Escape"===e.key&&s&&a()};return s&&document.addEventListener("keydown",e),()=>{document.removeEventListener("keydown",e)}},[s,a]),t&&s?e.jsx(e.Fragment,{children:e.jsxs("div",{className:"repository-detail-panel","data-testid":"repo-detail-panel",style:r?{height:"100%",backgroundColor:"dark"===o?"#141414":"#fff",overflowY:"auto",overflowX:"hidden"}:{position:"fixed",top:0,right:s?0:"-520px",bottom:0,width:"520px",maxWidth:"100vw",backgroundColor:"dark"===o?"#141414":"#fff",boxShadow:"-2px 0 8px rgba(0, 0, 0, 0.15)",zIndex:1e3,transition:"right 0.3s ease-in-out",overflowY:"auto",overflowX:"hidden"},children:[e.jsxs("div",{style:{padding:"16px 24px",borderBottom:"1px solid "+("dark"===o?"#303030":"#f0f0f0"),position:"sticky",top:0,backgroundColor:"dark"===o?"#141414":"#fff",zIndex:r?0:1},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(_e,{children:[e.jsx(_t,{style:{fontSize:24,color:"#8FBC8F"}}),e.jsx(As,{level:4,style:{margin:0},"data-testid":`repo-detail-title-${t.repositoryName}`,children:t.repositoryName})]}),e.jsx(Ee,{type:"text",icon:e.jsx(T,{}),onClick:a,style:l.touchTarget,"data-testid":"repo-detail-close"})]}),e.jsxs(_e,{wrap:!0,style:{marginTop:8},children:[e.jsxs(De,{color:"#8FBC8F",icon:e.jsx(I,{}),"data-testid":`repo-detail-team-tag-${t.repositoryName}`,children:["Team: ",t.teamName]}),d&&e.jsxs(De,{color:"green",icon:e.jsx(ht,{}),"data-testid":`repo-detail-machine-tag-${t.repositoryName}`,children:["Machine: ",d.machine.machineName]}),e.jsxs(De,{color:"blue","data-testid":`repo-detail-vault-version-tag-${t.repositoryName}`,children:[n("resources:repositories.vaultVersion"),": ",t.vaultVersion]})]})]}),e.jsx("div",{style:{padding:"24px"},"data-testid":"repo-detail-content",children:d?e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:16},"data-testid":"repo-detail-info-section",children:[e.jsx(_t,{style:{fontSize:20,color:"#8FBC8F"}}),e.jsx(As,{level:5,style:{margin:0},children:n("resources:repositories.repositoryInfo")})]}),e.jsx(it,{gutter:[16,16],style:l.marginBottom.lg,children:e.jsx(rt,{span:24,children:e.jsx(st,{size:"small",style:l.card,"data-testid":"repo-detail-info-card",children:e.jsxs(_e,{direction:"vertical",style:{width:"100%"},size:"small",children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsxs(Fs,{type:"secondary",children:[n("resources:repositories.repositoryGuid"),":"]}),e.jsx(Fs,{copyable:!0,style:{fontSize:11,fontFamily:"monospace"},"data-testid":`repo-detail-guid-${t.repositoryName}`,children:t.repositoryGuid})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsxs(Fs,{type:"secondary",children:[n("resources:repositories.status"),":"]}),e.jsxs(_e,{children:[d.repositoryData.mounted?e.jsx(De,{color:"success",icon:e.jsx(h,{}),"data-testid":`repo-detail-status-mounted-${t.repositoryName}`,children:n("resources:repositories.mounted")}):e.jsx(De,{color:"default",icon:e.jsx(mt,{}),"data-testid":`repo-detail-status-unmounted-${t.repositoryName}`,children:n("resources:repositories.notMounted")}),d.repositoryData.accessible&&e.jsx(De,{color:"green","data-testid":`repo-detail-status-accessible-${t.repositoryName}`,children:n("resources:repositories.accessible")})]})]}),d.repositoryData.has_rediaccfile&&e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsxs(Fs,{type:"secondary",children:[n("resources:repositories.rediaccfile"),":"]}),e.jsx(De,{color:"purple","data-testid":`repo-detail-rediaccfile-${t.repositoryName}`,children:n("resources:repositories.hasRediaccfile")})]}),d.repositoryData.docker_running&&d.repositoryData.volume_status&&"none"!==d.repositoryData.volume_status&&e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsx(Fs,{type:"secondary",children:"Docker Volumes:"}),"safe"===d.repositoryData.volume_status?e.jsxs(De,{color:"success",icon:e.jsx(h,{}),"data-testid":`repo-detail-volume-safe-${t.repositoryName}`,children:[d.repositoryData.internal_volumes," Safe Volume",1!==d.repositoryData.internal_volumes?"s":""]}):"warning"===d.repositoryData.volume_status?e.jsxs(De,{color:"warning",icon:e.jsx(D,{}),"data-testid":`repo-detail-volume-warning-${t.repositoryName}`,children:[d.repositoryData.external_volumes," External, ",d.repositoryData.internal_volumes," Internal"]}):null]})]})})})}),"warning"===d.repositoryData.volume_status&&d.repositoryData.external_volume_names&&d.repositoryData.external_volume_names.length>0&&e.jsx(Ve,{type:"warning",showIcon:!0,icon:e.jsx(D,{}),message:"External Docker Volumes Detected",description:e.jsxs("div",{children:[e.jsx(Fs,{children:"The following volumes are stored outside the repository:"}),e.jsx("ul",{style:{marginTop:8,marginBottom:8},children:d.repositoryData.external_volume_names.map(t=>e.jsx("li",{children:e.jsx(Fs,{code:!0,children:t})},t))}),e.jsxs(Fs,{type:"secondary",children:[e.jsx("strong",{children:"Warning:"})," If this repository is cloned, these volumes will be orphaned. Consider using bind mounts to ",e.jsx(Fs,{code:!0,children:"$REPO_PATH"})," instead."]})]}),style:{marginBottom:16},"data-testid":`repo-detail-volume-warning-alert-${t.repositoryName}`}),e.jsx(tt,{style:{margin:"24px 0"},"data-testid":"repo-detail-storage-divider",children:e.jsxs(_e,{children:[e.jsx(N,{}),n("resources:repositories.storageInfo")]})}),e.jsxs(it,{gutter:[16,16],style:l.marginBottom.lg,children:[e.jsx(rt,{span:12,children:e.jsx(st,{size:"small",style:{height:"100%"},"data-testid":`repo-detail-image-size-card-${t.repositoryName}`,children:e.jsx(nt,{title:n("resources:repositories.imageSize"),value:d.repositoryData.size_human,prefix:e.jsx(C,{}),valueStyle:{fontSize:16}})})}),e.jsx(rt,{span:12,children:e.jsx(st,{size:"small",style:{height:"100%"},"data-testid":`repo-detail-last-modified-card-${t.repositoryName}`,children:e.jsx(nt,{title:n("resources:repositories.lastModified"),value:d.repositoryData.modified_human,prefix:e.jsx(p,{}),valueStyle:{fontSize:16}})})}),d.repositoryData.mounted&&d.repositoryData.disk_space&&e.jsx(rt,{span:24,children:e.jsxs(st,{size:"small","data-testid":`repo-detail-disk-usage-card-${t.repositoryName}`,children:[e.jsx("div",{style:{marginBottom:12},children:e.jsxs(_e,{children:[e.jsx(ft,{style:{color:"#52c41a"}}),e.jsx(Fs,{strong:!0,children:n("resources:repositories.diskUsage")})]})}),e.jsx("div",{style:{marginBottom:8},children:e.jsxs(Fs,{children:[d.repositoryData.disk_space.used," / ",d.repositoryData.disk_space.total]})}),e.jsx(Be,{percent:parseInt(d.repositoryData.disk_space.use_percent),status:parseInt(d.repositoryData.disk_space.use_percent)>90?"exception":"normal",strokeColor:parseInt(d.repositoryData.disk_space.use_percent)>90?"#ff4d4f":"#52c41a",trailColor:"dark"===o?"rgba(255,255,255,0.08)":void 0,"data-testid":`repo-detail-disk-usage-progress-${t.repositoryName}`}),e.jsxs(Fs,{type:"secondary",style:{fontSize:12},children:[n("resources:repositories.available"),": ",d.repositoryData.disk_space.available]})]})})]}),e.jsx(tt,{style:{margin:"24px 0"},"data-testid":"repo-detail-file-paths-divider",children:e.jsxs(_e,{children:[e.jsx(_t,{}),n("resources:repositories.filePaths")]})}),e.jsx(st,{size:"small",style:l.card,"data-testid":`repo-detail-file-paths-card-${t.repositoryName}`,children:e.jsxs(_e,{direction:"vertical",style:{width:"100%"},size:"small",children:[e.jsxs("div",{children:[e.jsxs(Fs,{type:"secondary",children:[n("resources:repositories.imagePath"),":"]}),e.jsx(Fs,{copyable:!0,style:{display:"block",fontSize:12,wordBreak:"break-all",marginTop:4},"data-testid":`repo-detail-image-path-${t.repositoryName}`,children:d.repositoryData.image_path})]}),d.repositoryData.mount_path&&e.jsxs("div",{children:[e.jsxs(Fs,{type:"secondary",children:[n("resources:repositories.mountPath"),":"]}),e.jsx(Fs,{copyable:!0,style:{display:"block",fontSize:12,wordBreak:"break-all",marginTop:4},"data-testid":`repo-detail-mount-path-${t.repositoryName}`,children:d.repositoryData.mount_path})]})]})}),d.repositoryData.mounted&&e.jsxs(e.Fragment,{children:[e.jsx(tt,{style:{margin:"24px 0"},"data-testid":"repo-detail-activity-divider",children:e.jsxs(_e,{children:[e.jsx(vt,{}),n("resources:repositories.activity")]})}),e.jsxs(it,{gutter:[16,16],style:l.marginBottom.lg,children:[d.repositoryData.docker_running&&e.jsx(rt,{span:12,children:e.jsx(st,{size:"small",style:{height:"100%"},"data-testid":`repo-detail-containers-card-${t.repositoryName}`,children:e.jsx(nt,{title:n("resources:repositories.containers"),value:d.repositoryData.container_count,valueStyle:{color:"#1890ff"}})})}),d.repositoryData.has_services&&e.jsx(rt,{span:12,children:e.jsx(st,{size:"small",style:{height:"100%"},"data-testid":`repo-detail-services-card-${t.repositoryName}`,children:e.jsx(nt,{title:n("resources:repositories.services"),value:d.repositoryData.service_count,valueStyle:{color:"#fa8c16"}})})})]})]}),d.services&&d.services.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(tt,{style:{margin:"24px 0"},"data-testid":"repo-detail-services-divider",children:e.jsxs(_e,{children:[e.jsx(Ie,{}),n("resources:repositories.servicesSection")]})}),e.jsx(_e,{direction:"vertical",style:{width:"100%"},size:"middle","data-testid":"repo-detail-services-list",children:d.services.map((s,a)=>e.jsx(st,{size:"small","data-testid":`repo-detail-service-card-${t.repositoryName}-${s.name}`,style:{borderLeft:"4px solid "+("active"===s.active_state?"#52c41a":"failed"===s.active_state?"#ff4d4f":"#d9d9d9")},children:e.jsxs(it,{gutter:[16,8],children:[e.jsx(rt,{span:24,children:e.jsxs(_e,{style:{width:"100%",justifyContent:"space-between"},children:[e.jsx(Fs,{strong:!0,"data-testid":`repo-detail-service-name-${t.repositoryName}-${s.name}`,children:s.name}),e.jsx(De,{"data-testid":`repo-detail-service-status-${t.repositoryName}-${s.name}`,color:"active"===s.active_state?"success":"failed"===s.active_state?"error":"default",children:s.active_state})]})}),(s.memory_human||s.main_pid||s.uptime_human)&&e.jsx(rt,{span:24,children:e.jsxs(_e,{wrap:!0,size:"middle",children:[s.memory_human&&e.jsxs("div",{children:[e.jsx(Fs,{type:"secondary",style:{fontSize:11},children:"Memory"}),e.jsx("br",{}),e.jsx(Fs,{style:{fontSize:12},children:s.memory_human})]}),s.main_pid&&e.jsxs("div",{children:[e.jsx(Fs,{type:"secondary",style:{fontSize:11},children:"PID"}),e.jsx("br",{}),e.jsx(Fs,{style:{fontSize:12},children:s.main_pid})]}),s.uptime_human&&e.jsxs("div",{children:[e.jsx(Fs,{type:"secondary",style:{fontSize:11},children:"Uptime"}),e.jsx("br",{}),e.jsx(Fs,{style:{fontSize:12},children:s.uptime_human})]}),void 0!==s.restarts&&e.jsxs("div",{children:[e.jsx(Fs,{type:"secondary",style:{fontSize:11},children:"Restarts"}),e.jsx("br",{}),e.jsx(Fs,{style:{fontSize:12},children:s.restarts})]})]})})]})},`${s.name}-${a}`))})]})]}):e.jsx(qe,{description:n("resources:repositories.noRepositoryData"),style:{marginTop:48},"data-testid":"repo-detail-empty-state"})})]})}):null},{Text:Ps,Title:Ls}=Me,Gs=({container:t,visible:s,onClose:a,splitView:r=!1})=>{const{t:n}=ze(["resources","common"]),{theme:o}=u(),c=b();i.useEffect(()=>{const e=e=>{"Escape"===e.key&&s&&a()};if(s)return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[s,a]);const l=i.useMemo(()=>{if(!t)return null;const e=parseFloat(t.cpu_percent?.replace("%","")||"0"),s=t.memory_usage?.split(" / ")||[],a=s[0]||"0",i=s[1]||"0",r=parseFloat(t.memory_percent?.replace("%","")||"0"),n=t.net_io?.split(" / ")||[],o=n[0]||"0",c=n[1]||"0",l=t.block_io?.split(" / ")||[];return{cpu:e,memoryUsed:a,memoryTotal:i,memoryPercent:r,netIn:o,netOut:c,blockRead:l[0]||"0",blockWrite:l[1]||"0",pids:parseInt(t.pids||"0")}},[t]),d=t?.name?.startsWith("plugin-"),m=d&&t?t.name.replace("plugin-",""):null;return s&&t?e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{padding:r?"16px 24px":"16px 24px 0",borderBottom:"1px solid "+("dark"===o?"#303030":"#f0f0f0"),display:"flex",justifyContent:"space-between",alignItems:"center"},"data-testid":"container-detail-header",children:[e.jsx(Ls,{level:4,style:{margin:0},"data-testid":"container-detail-title",children:n(d?"resources:containers.pluginDetails":"resources:containers.containerDetails")}),!r&&e.jsx(Ee,{type:"text",icon:e.jsx(T,{}),onClick:a,style:{...c.touchTarget,marginRight:-8},"data-testid":"container-detail-close"})]}),e.jsxs("div",{style:{padding:"24px",height:r?"calc(100% - 57px)":void 0,overflow:"auto"},children:[e.jsx("div",{style:{marginBottom:16},children:e.jsxs(_e,{size:"small",style:{marginBottom:8},children:[e.jsx(De,{color:d?"blue":"cyan",icon:d?e.jsx(z,{}):e.jsx(I,{}),"data-testid":"container-detail-name-tag",children:d?`Plugin: ${m}`:t.name}),e.jsx(De,{color:"running"===t.state?"success":"default",icon:"running"===t.state?e.jsx(we,{}):e.jsx(je,{}),"data-testid":"container-detail-state-tag",children:t.state})]})}),t&&e.jsxs(e.Fragment,{children:[e.jsx(st,{size:"small",style:{...c.card,marginBottom:16},"data-testid":"container-detail-basic-info",children:e.jsx(it,{gutter:[16,16],style:c.marginBottom.lg,children:e.jsx(rt,{span:24,children:e.jsxs(_e,{direction:"vertical",style:{width:"100%"},size:"small",children:[e.jsxs("div",{children:[e.jsxs(Ps,{type:"secondary",children:[n("resources:containers.containerID"),":"]}),e.jsx("br",{}),e.jsx(Ps,{copyable:!0,style:{fontFamily:"monospace",fontSize:12},"data-testid":"container-detail-id",children:t.id})]}),e.jsxs("div",{children:[e.jsxs(Ps,{type:"secondary",children:[n("resources:containers.image"),":"]}),e.jsx("br",{}),e.jsx(Ps,{style:{fontSize:12,wordBreak:"break-all"},"data-testid":"container-detail-image",children:t.image})]}),e.jsxs("div",{children:[e.jsxs(Ps,{type:"secondary",children:[n("resources:containers.status"),":"]}),e.jsx("br",{}),e.jsx(Ps,{style:{fontSize:12},"data-testid":"container-detail-status",children:t.status})]}),e.jsxs("div",{children:[e.jsxs(Ps,{type:"secondary",children:[n("resources:containers.created"),":"]}),e.jsx("br",{}),e.jsx(Ps,{style:{fontSize:12},"data-testid":"container-detail-created",children:t.created})]})]})})})}),e.jsx(tt,{style:{margin:"24px 0"},children:e.jsxs(_e,{children:[e.jsx(ht,{}),n("resources:containers.resourceUsage")]})}),e.jsxs(it,{gutter:[16,16],style:c.marginBottom.lg,children:[e.jsx(rt,{xs:24,sm:12,children:e.jsxs(st,{size:"small","data-testid":"container-detail-cpu-card",children:[e.jsx(nt,{title:n("resources:containers.cpuUsage"),value:l?.cpu||0,suffix:"%",valueStyle:{color:l?.cpu&&l.cpu>80?"#ff4d4f":void 0}}),e.jsx(Be,{percent:l?.cpu||0,showInfo:!1,status:l?.cpu&&l.cpu>80?"exception":"normal"})]})}),e.jsx(rt,{xs:24,sm:12,children:e.jsxs(st,{size:"small","data-testid":"container-detail-memory-card",children:[e.jsx(nt,{title:n("resources:containers.memoryUsage"),value:`${l?.memoryUsed} / ${l?.memoryTotal}`,valueStyle:{fontSize:16}}),e.jsx(Be,{percent:l?.memoryPercent||0,status:l?.memoryPercent&&l.memoryPercent>90?"exception":"normal"})]})}),e.jsx(rt,{xs:24,sm:12,children:e.jsx(st,{size:"small","data-testid":"container-detail-network-card",children:e.jsxs(_e,{direction:"vertical",style:{width:"100%"},children:[e.jsx("div",{style:{display:"flex",justifyContent:"space-between"},children:e.jsxs(Ps,{type:"secondary",children:[n("resources:containers.networkIO"),":"]})}),e.jsx("div",{children:e.jsxs(Ps,{style:{fontSize:12},children:[e.jsx(P,{style:{marginRight:4}}),"↓ ",l?.netIn," / ↑ ",l?.netOut]})})]})})}),e.jsx(rt,{xs:24,sm:12,children:e.jsx(st,{size:"small","data-testid":"container-detail-block-io-card",children:e.jsxs(_e,{direction:"vertical",style:{width:"100%"},children:[e.jsx("div",{style:{display:"flex",justifyContent:"space-between"},children:e.jsxs(Ps,{type:"secondary",children:[n("resources:containers.blockIO"),":"]})}),e.jsx("div",{children:e.jsxs(Ps,{style:{fontSize:12},children:[e.jsx(C,{style:{marginRight:4}}),"R: ",l?.blockRead," / W: ",l?.blockWrite]})})]})})})]}),e.jsx(tt,{style:{margin:"24px 0"},children:e.jsxs(_e,{children:[e.jsx(Ie,{}),n("resources:containers.configuration")]})}),e.jsx(st,{size:"small",style:{...c.card,marginBottom:16},"data-testid":"container-detail-configuration",children:e.jsxs(_e,{direction:"vertical",style:{width:"100%"},size:"middle",children:[e.jsxs("div",{children:[e.jsxs(Ps,{type:"secondary",children:[n("resources:containers.command"),":"]}),e.jsx("br",{}),e.jsx(Ps,{code:!0,style:{fontSize:11,wordBreak:"break-all"},"data-testid":"container-detail-command",children:t.command})]}),(t.port_mappings&&t.port_mappings.length>0||t.ports)&&e.jsxs("div",{children:[e.jsxs(Ps,{type:"secondary",children:[n("resources:containers.ports"),":"]}),e.jsx("br",{}),t.port_mappings&&t.port_mappings.length>0?e.jsx(_e,{direction:"vertical",size:"small",style:{marginTop:4},children:t.port_mappings.map((t,s)=>e.jsx(De,{color:"blue","data-testid":`container-detail-port-${s}`,children:t.host_port?`${t.host||"0.0.0.0"}:${t.host_port} → ${t.container_port}/${t.protocol}`:`${t.container_port}/${t.protocol}`},s))}):t.ports?e.jsx(Ps,{style:{fontSize:12},"data-testid":"container-detail-ports-text",children:t.ports}):null]}),e.jsxs("div",{children:[e.jsxs(Ps,{type:"secondary",children:[n("resources:containers.networks"),":"]}),e.jsx("br",{}),e.jsx(De,{color:"purple","data-testid":"container-detail-network-tag",children:t.networks})]}),e.jsxs("div",{children:[e.jsxs(Ps,{type:"secondary",children:[n("resources:containers.size"),":"]}),e.jsx("br",{}),e.jsx(Ps,{style:{fontSize:12},"data-testid":"container-detail-size",children:t.size})]}),e.jsxs("div",{children:[e.jsxs(Ps,{type:"secondary",children:[n("resources:containers.processes"),":"]}),e.jsx("br",{}),e.jsxs(De,{"data-testid":"container-detail-pids",children:[l?.pids||0," ",n("resources:containers.pids")]})]})]})}),e.jsx(tt,{style:{margin:"24px 0"},children:e.jsxs(_e,{children:[e.jsx(_t,{}),n("resources:containers.environment")]})}),e.jsx(st,{size:"small",style:c.card,"data-testid":"container-detail-environment",children:e.jsxs(_e,{direction:"vertical",style:{width:"100%"},size:"middle",children:[e.jsxs("div",{children:[e.jsxs(Ps,{type:"secondary",children:[n("resources:containers.mounts"),":"]}),e.jsx("br",{}),e.jsx(Ps,{style:{fontSize:11,wordBreak:"break-all"},"data-testid":"container-detail-mounts",children:t.mounts})]}),t.labels&&e.jsxs("div",{children:[e.jsxs(Ps,{type:"secondary",children:[n("resources:containers.labels"),":"]}),e.jsx("br",{}),e.jsx(Ps,{style:{fontSize:11,wordBreak:"break-all"},"data-testid":"container-detail-labels",children:t.labels})]})]})})]})]})]}):null},Ws=({type:t,data:s,visible:a,onClose:r,splitWidth:n,onSplitWidthChange:o})=>{const{theme:c}=u(),l=i.useRef(!1),d=i.useRef(0),m=i.useRef(0),[h,p]=i.useState(1),[y,x]=i.useState(s),[g,f]=i.useState(!1),[j,v]=i.useState(s);s!==j&&(x(s),v(s));if(i.useEffect(()=>{const e=e=>{if(!l.current)return;const t=d.current-e.clientX,s=window.innerWidth,a=Math.min(800,s-400),i=Math.max(300,Math.min(a,m.current+t));o(i)},t=()=>{l.current&&(l.current=!1,document.body.style.cursor="",document.body.style.userSelect="")};return document.addEventListener("mousemove",e),document.addEventListener("mouseup",t),()=>{document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",t)}},[n,o]),!a||!y)return null;const b=t||(y&&"machineName"in y?"machine":y&&"repositoryName"in y?"repository":"container");return e.jsxs("div",{style:{position:"relative",width:n,height:"100%",borderLeft:"1px solid "+("dark"===c?"#303030":"#f0f0f0"),display:"flex",flexShrink:0,opacity:h,transition:"opacity 0.3s ease"},"data-testid":"unified-detail-panel",children:[e.jsx("div",{style:{position:"absolute",left:-3,top:0,bottom:0,width:6,cursor:"ew-resize",zIndex:10,backgroundColor:"transparent"},onMouseDown:e=>{l.current=!0,d.current=e.clientX,m.current=n,document.body.style.cursor="ew-resize",document.body.style.userSelect="none",e.preventDefault()},"data-testid":"unified-detail-resize-handle",children:e.jsx("div",{style:{position:"absolute",left:2,top:0,bottom:0,width:2,backgroundColor:"dark"===c?"#303030":"#f0f0f0",transition:"background-color 0.2s"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor="#1890ff"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="dark"===c?"#303030":"#f0f0f0"}})}),e.jsx("div",{style:{flex:1,overflow:"hidden"},"data-testid":"unified-detail-content",children:"machine"===b?e.jsx(Rs,{machine:y,visible:a,onClose:r,splitView:!0}):"repository"===b?e.jsx(Os,{repository:y,visible:a,onClose:r,splitView:!0}):e.jsx(Gs,{container:y,visible:a,onClose:r,splitView:!0})})]})},Us=t=>{const{type:s,selectedResource:a,onResourceSelect:r,onMachineRepositoryClick:n,onMachineContainerClick:o}=t,c=()=>{const e=window.innerWidth,t=Math.floor(.25*e);return Math.max(300,Math.min(600,t))},[l,d]=i.useState(c);i.useEffect(()=>{const e=()=>{d(c())};return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const m=e=>{r(e)},u=()=>{r(null)};return"machine"===s?e.jsxs("div",{style:{display:"flex",height:"100%",width:"100%",position:"relative",overflow:"hidden"},"data-testid":"split-resource-view-container",children:[e.jsx("div",{style:{width:a?`calc(100% - ${l}px)`:"100%",height:"100%",overflow:"auto",minWidth:300,transition:"width 0.3s ease-in-out"},"data-testid":"split-resource-view-left-panel",children:e.jsx(Es,{...t,onRowClick:m,selectedMachine:a,onMachineRepositoryClick:n,onMachineContainerClick:o})}),a&&e.jsx(Ws,{type:"machineName"in a?"machine":"repositoryName"in a?"repository":"container",data:a,visible:!0,onClose:u,splitWidth:l,onSplitWidthChange:d})]}):null},{Title:qs}=Me,Ks=()=>{const{t:s}=ze(["resources","machines","common"]),a=n(),o=t(e=>e.ui.uiMode),c=b(),[l,d]=i.useState([]),[u,h]=i.useState("machines"),[p,y]=i.useState(null),[x,g]=i.useState(null),[f,N]=i.useState(null),[w,k]=i.useState({open:!1,resourceType:"machine",mode:"create"}),C=i.useRef(null),T=i.useRef(null),I=()=>{switch(u){case"machines":return s("machines.createMachine");case"repositories":return s("repositories.createRepository");case"storage":return s("storage.createStorage");default:return s("general.create")}},[z,_]=i.useState(null),[D,V]=i.useState([]),[W,K]=i.useState({}),de=e=>{y(e),e&&g(null)},me=Q(),ue=H(),pe=J(),ye=X(),xe=Y(),ge=async(e,t)=>{const a=t[`${e}Name`],i={machine:ye,repository:Ae,storage:Qe},r=t=>{if("machine"===e)return`machines:${t}`;return`resources:${"repository"===e?"repositories":`${e}s`}.${t}`};$e.confirm({title:s(r("machine"===e?"confirmDelete":`delete${e.charAt(0).toUpperCase()+e.slice(1)}`)),content:s(r("machine"===e?"deleteWarning":"confirmDelete"),{name:a,[`${e}Name`]:a}),okText:s("common:actions.delete"),okType:"danger",cancelText:s("common:actions.cancel"),onOk:async()=>{try{const n=i[e];"machine"===e?(await n.mutateAsync({teamName:t.teamName,machineName:a}),Ce()):"repository"===e?(await n.mutateAsync({teamName:t.teamName,repositoryName:a}),Me()):"storage"===e&&(await n.mutateAsync({teamName:t.teamName,storageName:a}),We()),v("success",s(r("deleteSuccess")))}catch(n){v("error",s(r("deleteError")))}}})},{data:fe}=Te(),{data:je,isLoading:be}=O(),Ne=je||[],{data:we=[],refetch:Ce}=U(l.length>0&&("machines"===u||"repositories"===u)?l:void 0,"machines"===u||"repositories"===u),{data:Se=[],isLoading:Ie,refetch:Me}=q(l.length>0?l:void 0),Be=Z(),Ve=ee(),Ae=te(),Oe=se(),{data:Le=[],isLoading:Ge,refetch:We}=G(l.length>0&&"storage"===u?l:void 0),Ue=L(),Ke=ae(),Qe=ie(),He=re(),Je=le(),{buildQueueVault:Xe}=A(),[Ye,Ze]=i.useState({visible:!1,taskId:null,machineName:null}),[et,tt]=i.useState(!1),[at,nt]=i.useState({open:!1,entityType:null,entityIdentifier:null}),[ot,ct]=i.useState(!1),mt=pt(C,{containerOffset:220,minRows:5,maxRows:50,rowHeight:55}),ut=pt(T,{containerOffset:220,minRows:5,maxRows:50,rowHeight:55}),ht=i.useRef(!1);r.useEffect(()=>{if(!be&&!ht.current&&Ne&&Ne.length>0)if(ht.current=!0,"simple"===o){const e=Ne.find(e=>"Private Team"===e.teamName);d(e?["Private Team"]:[Ne[0].teamName])}else d([Ne[0].teamName])},[o,Ne,be]),r.useEffect(()=>{if(a.state&&a.state.createRepository){const e=a.state;h("repositories"),e.selectedTeam&&d([e.selectedTeam]),setTimeout(()=>{yt("repository","create",{teamName:e.selectedTeam,machineName:e.selectedMachine,preselectedTemplate:e.selectedTemplate})},100),window.history.replaceState({},document.title)}},[a]);const yt=(e,t,s,a)=>{k({open:!0,resourceType:e,mode:t,data:s,creationContext:a})},xt=()=>{k({open:!1,resourceType:"machine",mode:"create"}),_(null)},gt=async(e,t)=>{if(z)try{let a,i;if("machine"===e)a=z.machineName,i=z.bridgeName;else{if(!t.selectedMachine)return;const e=fe?.machinesByTeam?.find(e=>e.teamName===z.teamName),r=e?.machines?.find(e=>e.value===t.selectedMachine);if(!r)return void v("error",s("resources:errors.machineNotFound"));a=r.value,i=r.bridgeName}const r=Ne.find(e=>e.teamName===z.teamName),n={teamName:z.teamName,machineName:a,bridgeName:i,functionName:t.function.name,params:t.params,priority:t.priority,description:t.description,addedVia:`${e}-table`,teamVault:r?.vaultContent||"{}"};if("machine"===e)if(n.machineVault=z.vaultContent||"{}",t.params.repo){const e=Se.find(e=>e.repositoryGuid===t.params.repo);n.repositoryGuid=e?.repositoryGuid||t.params.repo,n.repositoryVault=e?.vaultContent||"{}"}else n.repositoryVault="{}";else if("repository"===e){n.repositoryGuid=z.repositoryGuid,n.repositoryVault=z.vaultContent||"{}";const e=we.find(e=>e.machineName===a&&e.teamName===z.teamName);n.machineVault=e?.vaultContent||"{}"}else if("storage"===e){n.storageName=z.storageName,n.storageVault=z.vaultContent||"{}";const e=we.find(e=>e.machineName===a&&e.teamName===z.teamName);n.machineVault=e?.vaultContent||"{}"}if("pull"===t.function.name){if("machine"===t.params.sourceType&&t.params.from){const e=we.find(e=>e.machineName===t.params.from);e&&e.vaultContent&&(n.sourceMachineVault=e.vaultContent)}if("storage"===t.params.sourceType&&t.params.from){const e=Le.find(e=>e.storageName===t.params.from);e&&e.vaultContent&&(n.sourceStorageVault=e.vaultContent)}}if("push"===t.function.name){if("machine"===t.params.destinationType&&t.params.to){const e=we.find(e=>e.machineName===t.params.to);e&&e.vaultContent&&(n.destinationMachineVault=e.vaultContent)}if("storage"===t.params.destinationType&&t.params.to){const e=Le.find(e=>e.storageName===t.params.to);e&&e.vaultContent&&(n.destinationStorageVault=e.vaultContent)}}const o=await Xe(n),c=await Je.mutateAsync({teamName:z.teamName,machineName:a,bridgeName:i,queueVault:o,priority:t.priority});xt(),c?.taskId?(v("success",s(`${e}s:queueItemCreated`)),Ze({visible:!0,taskId:c.taskId,machineName:a})):c?.isQueued&&v("info",s("resources:messages.highestPriorityQueued",{resourceType:e}))}catch(a){}},ft=[{title:s("repositories.repositoryName"),dataIndex:"repositoryName",key:"repositoryName",ellipsis:!0,render:t=>e.jsxs(_e,{children:[e.jsx(oe,{style:{color:"#556b2f"}}),e.jsx("strong",{children:t})]})},{title:s("general.team"),dataIndex:"teamName",key:"teamName",width:150,ellipsis:!0,render:t=>e.jsx(De,{color:"#8FBC8F",children:t})},..."expert"===o?[{title:s("general.vaultVersion"),dataIndex:"vaultVersion",key:"vaultVersion",width:100,align:"center",render:t=>e.jsx(De,{children:s("common:general.versionFormat",{version:t})})}]:[],{title:s("common:table.actions"),key:"actions",width:250,render:(t,a)=>e.jsxs(_e,{children:[e.jsx(Fe,{title:s("common:actions.edit"),children:e.jsx(Ee,{type:"primary",size:"small",icon:e.jsx(B,{}),style:c.touchTargetSmall,"data-testid":`resources-repository-edit-${a.repositoryName}`,onClick:()=>{_(a),yt("repository","edit",a)},"aria-label":s("common:actions.edit")})}),e.jsx(Fe,{title:s("machines:trace"),children:e.jsx(Ee,{type:"primary",size:"small",icon:e.jsx(S,{}),style:c.touchTargetSmall,"data-testid":`resources-repository-trace-${a.repositoryName}`,onClick:()=>{nt({open:!0,entityType:"Repo",entityIdentifier:a.repositoryName,entityName:a.repositoryName})},"aria-label":s("machines:trace")})}),e.jsx(Fe,{title:s("common:actions.delete"),children:e.jsx(Ee,{type:"primary",danger:!0,size:"small",icon:e.jsx(M,{}),style:c.touchTargetSmall,"data-testid":`resources-repository-delete-${a.repositoryName}`,onClick:()=>ge("repository",a),"aria-label":s("common:actions.delete")})})]})}],jt=[{title:s("storage.storageName"),dataIndex:"storageName",key:"storageName",ellipsis:!0,render:t=>e.jsxs(_e,{children:[e.jsx(E,{style:{color:"#556b2f"}}),e.jsx("strong",{children:t})]})},{title:s("general.team"),dataIndex:"teamName",key:"teamName",width:150,ellipsis:!0,render:t=>e.jsx(De,{color:"#8FBC8F",children:t})},..."expert"===o?[{title:s("general.vaultVersion"),dataIndex:"vaultVersion",key:"vaultVersion",width:100,align:"center",render:t=>e.jsx(De,{children:s("common:general.versionFormat",{version:t})})}]:[],{title:s("common:table.actions"),key:"actions",width:350,render:(t,a)=>e.jsxs(_e,{children:[e.jsx(Fe,{title:s("common:actions.edit"),children:e.jsx(Ee,{type:"primary",size:"small",icon:e.jsx(B,{}),style:c.touchTargetSmall,"data-testid":`resources-storage-edit-${a.storageName}`,onClick:()=>{_(a),yt("storage","edit",a)},"aria-label":s("common:actions.edit")})}),e.jsx(Fe,{title:"Run",children:e.jsx(Ee,{type:"primary",size:"small",icon:e.jsx(he,{}),style:c.touchTargetSmall,"data-testid":`resources-storage-run-${a.storageName}`,onClick:()=>{_(a),k({open:!0,resourceType:"storage",mode:"create",data:a})},"aria-label":"Run"})}),e.jsx(Fe,{title:s("machines:trace"),children:e.jsx(Ee,{type:"primary",size:"small",icon:e.jsx(S,{}),style:c.touchTargetSmall,"data-testid":`resources-storage-trace-${a.storageName}`,onClick:()=>{nt({open:!0,entityType:"Storage",entityIdentifier:a.storageName,entityName:a.storageName})},"aria-label":s("machines:trace")})}),e.jsx(Fe,{title:s("common:actions.delete"),children:e.jsx(Ee,{type:"primary",danger:!0,size:"small",icon:e.jsx(M,{}),style:c.touchTargetSmall,"data-testid":`resources-storage-delete-${a.storageName}`,onClick:()=>{$e.confirm({title:s("storage.deleteStorage"),content:s("storage.confirmDelete",{storageName:a.storageName}),okText:s("general.yes"),okType:"danger",cancelText:s("general.no"),onOk:()=>ge("storage",a)})},"aria-label":s("common:actions.delete")})})]})}],vt=me.isPending||ue.isPending||pe.isPending||Be.isPending||Ve.isPending||Ue.isPending||Ke.isPending||Je.isPending,bt=xe.isPending||Oe.isPending||He.isPending,Nt=[{key:"machines",label:e.jsx(Fe,{title:s("resourceTabs.machines"),placement:"top",children:e.jsx("span",{"data-testid":"resources-tab-machines",children:e.jsx(R,{style:{fontSize:j.DIMENSIONS.ICON_MD}})})}),children:e.jsx(Us,{type:"machine",teamFilter:l.length>0?l:void 0,showFilters:!0,showActions:!0,onCreateMachine:()=>yt("machine","create"),onEditMachine:e=>{_(e),yt("machine","edit",e)},onVaultMachine:e=>{_(e),yt("machine","vault",e)},onFunctionsMachine:(e,t)=>{_(e),k({open:!0,resourceType:"machine",mode:"create",data:e,preselectedFunction:t}),K(t=>({...t,[e.machineName]:Date.now()}))},onDeleteMachine:e=>ge("machine",e),onRefreshMachines:Ce,onCreateRepository:(e,t)=>{let s;e.teamName!==l[0]&&d([e.teamName]),t&&(s=JSON.stringify({credential:""})),yt("repository","create",{machineName:e.machineName,teamName:e.teamName,prefilledMachine:!0,repositoryGuid:t,vaultContent:s},t?"credentials-only":"normal")},enabled:"machines"===u,className:"full-height-machine-table",expandedRowKeys:D,onExpandedRowsChange:V,refreshKeys:W,onQueueItemCreated:(e,t)=>{Ze({visible:!0,taskId:e,machineName:t})},selectedResource:p||x||f,onResourceSelect:e=>{e&&"machineName"in e?de(e):e&&"repositoryName"in e?(de(null),g(e),N(null)):e&&"id"in e&&"state"in e?(de(null),g(null),N(e)):(de(null),g(null),N(null))},onMachineRepositoryClick:(e,t)=>{const s={repositoryName:t.name,repositoryGuid:t.originalGuid||t.name,teamName:e.teamName,vaultVersion:0,vaultContent:void 0,grandGuid:void 0},a=Se.find(e=>e.repositoryName===t.name||e.repositoryGuid===t.originalGuid||e.repositoryGuid===t.name);a?(g(a),y(null)):(g(s),y(null),N(null))},onMachineContainerClick:(e,t)=>{y(null),g(null),N(t)}})},{key:"repositories",label:e.jsx(Fe,{title:s("resourceTabs.repositories"),placement:"top",children:e.jsx("span",{"data-testid":"resources-tab-repositories",children:e.jsx(oe,{style:{fontSize:j.DIMENSIONS.ICON_MD}})})}),children:e.jsx("div",{ref:C,style:{height:"100%",display:"flex",flexDirection:"column"},children:Ie?e.jsxs("div",{style:{textAlign:"center",padding:"100px 0"},children:[e.jsx(Pe,{size:"large"}),e.jsx("div",{style:{marginTop:16,color:"var(--ant-color-text-secondary)"},children:s("common:general.loading")})]}):0===Se.length?e.jsx(qe,{description:s("repositories.noRepositories"),style:{margin:"auto"}}):e.jsx(Re,{"data-testid":"resources-repository-table",columns:ft,dataSource:Se,rowKey:"repositoryName",scroll:{x:"max-content"},pagination:{total:Se?.length||0,pageSize:mt,showSizeChanger:!1,showTotal:(e,t)=>`${s("common:general.showingRecords",{start:t[0],end:t[1],total:e})}`,position:["bottomRight"]},style:{flex:1},sticky:!0})})},{key:"storage",label:e.jsx(Fe,{title:s("resourceTabs.storage"),placement:"top",children:e.jsx("span",{"data-testid":"resources-tab-storage",children:e.jsx(E,{style:{fontSize:j.DIMENSIONS.ICON_MD}})})}),children:e.jsx("div",{ref:T,style:{height:"100%",display:"flex",flexDirection:"column"},children:Ge?e.jsxs("div",{style:{textAlign:"center",padding:"100px 0"},children:[e.jsx(Pe,{size:"large"}),e.jsx("div",{style:{marginTop:16,color:"var(--ant-color-text-secondary)"},children:s("common:general.loading")})]}):0===Le.length?e.jsx(qe,{description:s("storage.noStorage"),style:{margin:"auto"}}):e.jsx(Re,{"data-testid":"resources-storage-table",columns:jt,dataSource:Le,rowKey:"storageName",scroll:{x:"max-content"},pagination:{total:Le?.length||0,pageSize:ut,showSizeChanger:!1,showTotal:(e,t)=>`${s("common:general.showingRecords",{start:t[0],end:t[1],total:e})}`,position:["bottomRight"]},style:{flex:1},sticky:!0})})}],wt={...c.container,height:"calc(100vh - 64px - 48px)",overflow:"hidden",...c.flexColumn},kt={...c.card,height:"100%",...c.flexColumn},Ct={flex:1,overflow:"hidden",...c.padding.md,...c.flexColumn},St=e=>{if("ArrowLeft"===e.key||"ArrowRight"===e.key){e.preventDefault();const t=["machines","repositories","storage"],s=t.indexOf(u);if("ArrowLeft"===e.key){const e=s>0?s-1:t.length-1;h(t[e])}else{const e=s<t.length-1?s+1:0;h(t[e])}}};return e.jsxs(e.Fragment,{children:["simple"!==o?e.jsx(it,{gutter:0,style:wt,children:e.jsx(rt,{span:24,style:{height:"100%"},children:e.jsxs(st,{style:kt,styles:{body:Ct},children:[e.jsx("div",{style:{marginBottom:16},children:e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap",gap:16},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:16,flex:"1 1 auto",minWidth:0},children:[e.jsx(qs,{level:4,style:{...c.heading4,margin:0,flexShrink:0},children:s("teams.teamResources")}),e.jsx(ve,{"data-testid":"resources-team-selector",teams:Ne,selectedTeams:l,onChange:d,loading:be,placeholder:s("teams.selectTeamToView"),style:{minWidth:250,maxWidth:400,width:"100%"}})]}),l.length>0&&e.jsxs("div",{style:{display:"flex",gap:8,flexShrink:0},children:[e.jsx(Fe,{title:I(),children:e.jsx(Ee,{type:"primary",icon:e.jsx($,{}),style:{...c.buttonPrimary,...c.touchTarget,background:"#556b2f",borderColor:"#556b2f"},"data-testid":`resources-create-${u.slice(0,-1)}-button`,onClick:()=>{switch(u){case"machines":yt("machine","create");break;case"repositories":yt("repository","create",void 0,"credentials-only");break;case"storage":yt("storage","create")}},"aria-label":I()})}),"storage"===u&&e.jsx(Fe,{title:s("resources:storage.import.button"),children:e.jsx(Ee,{icon:e.jsx(ce,{}),style:c.touchTarget,"data-testid":"resources-import-button",onClick:()=>ct(!0),"aria-label":s("resources:storage.import.button")})}),"machines"===u&&e.jsx(Fe,{title:s("machines:connectivityTest"),children:e.jsx(Ee,{icon:e.jsx(P,{}),style:c.touchTarget,"data-testid":"resources-connectivity-test-button",onClick:()=>tt(!0),disabled:0===we.length,"aria-label":s("machines:connectivityTest")})}),e.jsx(Fe,{title:s("common:actions.refresh"),children:e.jsx(Ee,{icon:e.jsx(F,{}),style:c.touchTarget,"data-testid":"resources-refresh-button",onClick:()=>{switch(u){case"machines":Ce(),K(e=>({...e,_global:Date.now()}));break;case"repositories":Me();break;case"storage":We()}},"aria-label":s("common:actions.refresh")})})]})]})}),0===l.length?e.jsx(qe,{image:qe.PRESENTED_IMAGE_SIMPLE,description:s("teams.selectTeamPrompt"),style:{padding:"40px 0"}}):e.jsx(lt,{activeKey:u,onChange:h,items:Nt,style:{flex:1,display:"flex",flexDirection:"column"},className:"full-height-tabs",onKeyDown:St,tabIndex:0})]})})}):e.jsx(it,{gutter:0,style:wt,children:e.jsx(rt,{span:24,style:{height:"100%"},children:e.jsxs(st,{style:kt,styles:{body:Ct},children:[e.jsxs("div",{style:{marginBottom:16,display:"flex",justifyContent:"space-between",alignItems:"center",flexShrink:0},children:[e.jsx("div",{children:e.jsx(qs,{level:4,style:{...c.heading4,margin:0},children:s("teams.teamResources")})}),e.jsxs(_e,{children:[e.jsx(Fe,{title:I(),children:e.jsx(Ee,{type:"primary",icon:e.jsx($,{}),style:{...c.buttonPrimary,...c.touchTarget,background:"#556b2f",borderColor:"#556b2f"},"data-testid":`resources-create-${u.slice(0,-1)}-button`,onClick:()=>{switch(u){case"machines":yt("machine","create");break;case"repositories":yt("repository","create",void 0,"credentials-only");break;case"storage":yt("storage","create")}},"aria-label":I()})}),"storage"===u&&e.jsx(Fe,{title:s("resources:storage.import.button"),children:e.jsx(Ee,{icon:e.jsx(ce,{}),style:c.touchTarget,"data-testid":"resources-import-button",onClick:()=>ct(!0),"aria-label":s("resources:storage.import.button")})}),"machines"===u&&e.jsx(Fe,{title:s("machines:connectivityTest"),children:e.jsx(Ee,{icon:e.jsx(P,{}),style:c.touchTarget,"data-testid":"resources-connectivity-test-button",onClick:()=>tt(!0),disabled:0===we.length,"aria-label":s("machines:connectivityTest")})}),e.jsx(Fe,{title:s("common:actions.refresh"),children:e.jsx(Ee,{icon:e.jsx(F,{}),style:c.touchTarget,"data-testid":"resources-refresh-button",onClick:()=>{switch(u){case"machines":Ce(),K(e=>({...e,_global:Date.now()}));break;case"repositories":Me();break;case"storage":We()}},"aria-label":s("common:actions.refresh")})})]})]}),e.jsx(lt,{activeKey:u,onChange:h,items:Nt,style:{flex:1,display:"flex",flexDirection:"column"},className:"full-height-tabs",onKeyDown:St,tabIndex:0})]})})}),e.jsx(ne,{"data-testid":`resources-${w.resourceType}-modal`,open:w.open,onCancel:xt,resourceType:w.resourceType,mode:w.mode,existingData:w.data||z,teamFilter:l.length>0?l:void 0,creationContext:w.creationContext,onSubmit:async e=>{try{const{resourceType:a,mode:i}=w,r={machine:{create:me,updateName:ue,updateVault:xe},repository:{create:Be,updateName:Ve,updateVault:Oe},storage:{create:Ue,updateName:Ke,updateVault:He}};if("create"===i)if("repository"===a){const a=e.repositoryGuid&&""!==e.repositoryGuid.trim();if(e.machineName&&e.size&&!a){const{machineName:a,size:i,...n}=e;await r.repository.create.mutateAsync(n);try{const t=fe?.machinesByTeam?.find(t=>t.teamName===e.teamName),r=t?.machines?.find(e=>e.value===a);if(!r)return v("error",s("resources:errors.machineNotFound")),void xt();const n=Ne.find(t=>t.teamName===e.teamName),o=we.find(t=>t.machineName===a&&t.teamName===e.teamName);await new Promise(e=>setTimeout(e,500));const c=await m.get("/GetTeamRepositories",{teamName:e.teamName}),l=c.resultSets[1]?.data?.find(t=>t.repoName===e.repositoryName),d=l?.vaultContent||e.repositoryVault||"{}",u=l?.repoGuid||"";if(!u)return v("error",s("resources:errors.failedToGetRepositoryGuid")),void xt();const h={repo:u,size:i};e.tmpl&&(h.tmpl=e.tmpl),e.keep_open&&(h.keep_open="true");const p=await Xe({teamName:e.teamName,machineName:r.value,bridgeName:r.bridgeName,functionName:"new",params:h,priority:3,description:`Create repository ${e.repositoryName} with size ${i}`,addedVia:"repository-creation",teamVault:n?.vaultContent||"{}",machineVault:o?.vaultContent||"{}",repositoryVault:d,repositoryGuid:u}),y=await Je.mutateAsync({teamName:e.teamName,machineName:r.value,bridgeName:r.bridgeName,queueVault:p,priority:3});v("success",s("repositories.createSuccess")),y?.taskId?Ze({visible:!0,taskId:y.taskId,machineName:r.value}):y?.isQueued&&v("info",s("resources:messages.repositoryCreationQueued"))}catch(t){v("warning",s("repositories.repoCreatedButQueueFailed"))}}else await r.repository.create.mutateAsync(e),v("success",s("repositories.createSuccess")),xt(),Ce()}else if("machine"===a){const{autoSetup:a,...i}=e;if(await r.machine.create.mutateAsync(i),v("success",s("machines:createSuccess")),a)try{const t=Ne.find(t=>t.teamName===e.teamName);await new Promise(e=>setTimeout(e,500));const a=await Xe({teamName:e.teamName,machineName:e.machineName,bridgeName:e.bridgeName,functionName:"setup",params:{datastore_size:"95%",source:"apt-repo",rclone_source:"install-script",docker_source:"docker-repo",install_amd_driver:"auto",install_nvidia_driver:"auto"},priority:3,description:`Auto-setup for machine ${e.machineName}`,addedVia:"machine-creation-auto-setup",teamVault:t?.vaultContent||"{}",machineVault:e.machineVault||"{}"}),i=await Je.mutateAsync({teamName:e.teamName,machineName:e.machineName,bridgeName:e.bridgeName,queueVault:a,priority:3});i?.taskId?(v("info",s("machines:setupQueued")),Ze({visible:!0,taskId:i.taskId,machineName:e.machineName})):i?.isQueued&&v("info",s("machines:setupQueuedForSubmission"))}catch(t){v("warning",s("machines:machineCreatedButSetupFailed"))}xt(),Ce()}else await r[a].create.mutateAsync(e),v("success",s(`${(()=>{switch(u){case"machines":return"machines";case"repositories":return"repositories";case"storage":return"storage";default:return u}})()}.createSuccess`)),xt();else{const t=`${a}Name`,s=z[t],i=e[t];if(i!==s){const e=r[a].updateName;"machine"===a?await e.mutateAsync({teamName:z.teamName,currentMachineName:s,newMachineName:i}):"repository"===a?await e.mutateAsync({teamName:z.teamName,currentRepositoryName:s,newRepositoryName:i}):"storage"===a&&await e.mutateAsync({teamName:z.teamName,currentStorageName:s,newStorageName:i})}const n=e[`${a}Vault`];if(n&&n!==z.vaultContent){const e=r[a].updateVault;"machine"===a?await e.mutateAsync({teamName:z.teamName,machineName:i||s,machineVault:n,vaultVersion:z.vaultVersion+1}):"repository"===a?await e.mutateAsync({teamName:z.teamName,repositoryName:i||s,repositoryVault:n,vaultVersion:z.vaultVersion+1}):"storage"===a&&await e.mutateAsync({teamName:z.teamName,storageName:i||s,storageVault:n,vaultVersion:z.vaultVersion+1})}"machine"===a&&e.bridgeName!==z.bridgeName&&await pe.mutateAsync({teamName:z.teamName,machineName:i||s,newBridgeName:e.bridgeName})}xt()}catch(t){}},onUpdateVault:"edit"===w.mode?async(e,t)=>{if(z)try{const{resourceType:s}=w,a={machine:xe,repository:Oe,storage:He}[s];"machine"===s?await a.mutateAsync({teamName:z.teamName,machineName:z.machineName,machineVault:e,vaultVersion:t}):"repository"===s?await a.mutateAsync({teamName:z.teamName,repositoryName:z.repositoryName,repositoryVault:e,vaultVersion:t}):"storage"===s&&await a.mutateAsync({teamName:z.teamName,storageName:z.storageName,storageVault:e,vaultVersion:t})}catch(s){}}:void 0,onFunctionSubmit:!w.data||"machine"!==w.resourceType&&"repository"!==w.resourceType&&"storage"!==w.resourceType?void 0:"machine"===w.resourceType?e=>gt("machine",e):"repository"===w.resourceType?e=>gt("repository",e):e=>gt("storage",e),isSubmitting:vt,isUpdatingVault:bt,functionCategories:"machine"===w.resourceType?["machine","backup"]:"repository"===w.resourceType?["repository","backup","network"]:"storage"===w.resourceType?["backup"]:[],hiddenParams:"repository"===w.resourceType?["repo","grand"]:"storage"===w.resourceType?["storage"]:[],defaultParams:"repository"===w.resourceType&&z?{repo:z.repositoryGuid,grand:z.grandGuid||""}:"storage"===w.resourceType&&z?{storage:z.storageName}:{},preselectedFunction:w.preselectedFunction}),e.jsx(ke,{"data-testid":"resources-queue-trace-modal",taskId:Ye.taskId,visible:Ye.visible,onClose:()=>{if(Ze({visible:!1,taskId:null,machineName:null}),Ye.machineName){const e=Ye.machineName;K(t=>({...t,[e]:Date.now()}))}else K(e=>{const t={...e};return D.forEach(e=>{t[e]=Date.now()}),t});Ce()}}),e.jsx(ws,{"data-testid":"resources-connectivity-test-modal",open:et,onClose:()=>tt(!1),machines:we,teamFilter:l}),e.jsx(dt,{"data-testid":"resources-audit-trace-modal",open:at.open,onCancel:()=>nt({open:!1,entityType:null,entityIdentifier:null}),entityType:at.entityType,entityIdentifier:at.entityIdentifier,entityName:at.entityName}),e.jsx(Is,{"data-testid":"resources-rclone-import-wizard",open:ot,onClose:()=>ct(!1),teamName:l[0]||"",onImportComplete:()=>{We(),v("success",s("resources:storage.import.successMessage"))}})]})};export{Ks as default};
