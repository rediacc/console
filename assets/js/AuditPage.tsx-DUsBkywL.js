import{j as e}from"./chunk-DXw4Pgvm.js";import{r as t}from"./chunk-DZuWtVpy.js";import{u as s,h as a,f as i,I as l}from"../index-yX3ttfFw.js";import{b as o,E as r}from"./chunk-BlloZxKc.js";import{D as n}from"./chunk-DCAm5-CN.js";import{S as d,F as c}from"./chunk-e2suWao5.js";import{R as m}from"./chunk-BSOr0LTQ.js";import{C as h}from"./chunk-CNWXBXgB.js";import{L as u,S as x}from"./chunk-2GRYCOZF.js";import{F as y}from"./chunk-D3-qPxB8.js";import{F as f}from"./chunk-DETbo3Nb.js";import{t as p,d as j,a as g,g as w,k as b,T as v,o as Y,q as S,s as k,af as D,S as T,I as C,B as H,D as M,i as z,w as L,E as O,W as E}from"./chunk-CSjZqX98.js";import{u as N}from"./chunk-BP6R0kRn.js";import{u as R}from"./chunk-CM3g5OHp.js";import"./chunk-BNqsZZGB.js";import"./chunk-C0XEpv6B.js";const{Title:A,Text:I}=v,{RangePicker:U}=D,B=()=>{const{t:v}=R("system"),{token:D}=p.useToken(),B=s(),$=t.useRef(null),[_,F]=t.useState([j().subtract(7,"days"),j()]),[J,V]=t.useState(),[P,W]=t.useState(""),q=_[0]?.startOf("day").format("YYYY-MM-DDTHH:mm:ss"),G=_[1]?.endOf("day").format("YYYY-MM-DDTHH:mm:ss"),{data:K,isLoading:Q,refetch:X,error:Z,isError:ee}=o({startDate:q,endDate:G,entityFilter:J,maxRecords:1e3}),te=N($,{containerOffset:200,minRows:10,maxRows:100,rowHeight:55}),se=t=>{const s=t.toLowerCase();return s.includes("create")?e.jsx(i,{style:{color:D.colorSuccess}}):s.includes("delete")?e.jsx(h,{style:{color:D.colorError}}):s.includes("update")||s.includes("modify")?e.jsx(r,{style:{color:D.colorWarning}}):s.includes("login")||s.includes("auth")?e.jsx(u,{style:{color:D.colorPrimary}}):s.includes("export")||s.includes("import")?e.jsx(x,{style:{color:D.colorInfo}}):e.jsx(l,{style:{color:D.colorTextSecondary}})},ae=e=>{const t=e.toLowerCase();return t.includes("create")?"success":t.includes("delete")?"error":t.includes("update")||t.includes("modify")?"warning":t.includes("login")||t.includes("auth")?"processing":"default"},ie=K?.filter(e=>{if(!P)return!0;const t=P.toLowerCase();return e.entityName?.toLowerCase().includes(t)||e.action?.toLowerCase().includes(t)||e.details?.toLowerCase().includes(t)||e.actionByUser?.toLowerCase().includes(t)}),le=[{title:"Timestamp",dataIndex:"timestamp",key:"timestamp",width:180,render:e=>j(e).format("YYYY-MM-DD HH:mm:ss"),sorter:(e,t)=>new Date(e.timestamp).getTime()-new Date(t.timestamp).getTime(),defaultSortOrder:"descend"},{title:e.jsxs(g,{children:["Action",e.jsx(y,{style:{opacity:.6,fontSize:"12px"}})]}),dataIndex:"action",key:"action",width:200,render:t=>e.jsxs(g,{children:[se(t),e.jsx(w,{color:ae(t),children:t.replace(/_/g," ")})]}),filters:[...new Set(K?.map(e=>e.action)||[])].map(e=>({text:e.replace(/_/g," "),value:e})),onFilter:(e,t)=>t.action===e,filterIcon:t=>e.jsx(y,{style:{color:t?"#1890ff":void 0,fontSize:"14px"}})},{title:e.jsxs(g,{children:["Entity Type",e.jsx(y,{style:{opacity:.6,fontSize:"12px"}})]}),dataIndex:"entity",key:"entity",width:120,render:t=>e.jsx(w,{children:t}),filters:[...new Set(K?.map(e=>e.entity)||[])].map(e=>({text:e,value:e})),onFilter:(e,t)=>t.entity===e,filterIcon:t=>e.jsx(y,{style:{color:t?"#1890ff":void 0,fontSize:"14px"}})},{title:"Entity Name",dataIndex:"entityName",key:"entityName",width:200,ellipsis:{showTitle:!1},render:t=>e.jsx(b,{title:t,placement:"topLeft",children:e.jsx("span",{children:t})})},{title:e.jsxs(g,{children:["User",e.jsx(y,{style:{opacity:.6,fontSize:"12px"}})]}),dataIndex:"actionByUser",key:"user",width:180,filters:[...new Set(K?.map(e=>e.actionByUser)||[])].map(e=>({text:e,value:e})),onFilter:(e,t)=>t.actionByUser===e,filterIcon:t=>e.jsx(y,{style:{color:t?"#1890ff":void 0,fontSize:"14px"}})},{title:"Details",dataIndex:"details",key:"details",ellipsis:{showTitle:!1},render:t=>e.jsx(b,{title:t,placement:"topLeft",children:e.jsx(I,{type:"secondary",style:{fontSize:12},children:t})})}],oe=[...new Set(K?.map(e=>e.entity)||[])],re=[{key:"csv",label:e.jsx("span",{"data-testid":"audit-export-csv",children:"Export as CSV"}),icon:e.jsx(f,{}),onClick:()=>{if(!ie||0===ie.length)return;const e=ie.map(e=>[j(e.timestamp).format("YYYY-MM-DD HH:mm:ss"),e.action.replace(/_/g," "),e.entity,e.entityName||"",e.actionByUser,e.details||""]),t=[["Timestamp","Action","Entity Type","Entity Name","User","Details"].join(","),...e.map(e=>e.map(e=>`"${e}"`).join(","))].join("\n"),s=new Blob([t],{type:"text/csv;charset=utf-8;"}),a=document.createElement("a"),i=URL.createObjectURL(s);a.setAttribute("href",i),a.setAttribute("download",`audit_logs_${j().format("YYYY-MM-DD_HHmmss")}.csv`),a.style.visibility="hidden",document.body.appendChild(a),a.click(),document.body.removeChild(a),E.success(`Exported ${ie.length} audit logs to CSV`)}},{key:"json",label:e.jsx("span",{"data-testid":"audit-export-json",children:"Export as JSON"}),icon:e.jsx(c,{}),onClick:()=>{if(!ie||0===ie.length)return;const e={exportDate:j().format("YYYY-MM-DD HH:mm:ss"),dateRange:{from:_[0]?.format("YYYY-MM-DD HH:mm:ss"),to:_[1]?.format("YYYY-MM-DD HH:mm:ss")},filters:{entityType:J||"All",searchText:P||"None"},totalRecords:ie.length,logs:ie},t=JSON.stringify(e,null,2),s=new Blob([t],{type:"application/json"}),a=document.createElement("a"),i=URL.createObjectURL(s);a.setAttribute("href",i),a.setAttribute("download",`audit_logs_${j().format("YYYY-MM-DD_HHmmss")}.json`),a.style.visibility="hidden",document.body.appendChild(a),a.click(),document.body.removeChild(a),E.success(`Exported ${ie.length} audit logs to JSON`)}}],ne={...B.container,height:"calc(100vh - 64px - 48px)",overflow:"hidden",...B.flexColumn},de={...B.card,flex:1,...B.flexColumn,overflow:"hidden"},ce={flex:1,overflow:"hidden",...B.padding.md,...B.flexColumn};return e.jsxs("div",{style:ne,children:[e.jsxs("div",{style:{marginBottom:16,flexShrink:0},children:[e.jsxs(A,{level:2,style:{...B.heading2,marginBottom:8},children:[e.jsx(a,{style:{marginRight:8}}),"Audit Logs"]}),e.jsx(I,{type:"secondary",children:"Track all activities and changes in your organization"})]}),e.jsx(Y,{"data-testid":"audit-filter-card",style:{marginBottom:16,flexShrink:0},children:e.jsx(g,{direction:"vertical",size:"large",style:{width:"100%"},children:e.jsxs(S,{gutter:[24,16],children:[e.jsx(k,{xs:24,sm:24,md:8,children:e.jsxs(g,{direction:"vertical",size:"small",style:{width:"100%"},children:[e.jsx(I,{strong:!0,style:{fontSize:"14px",color:D.colorText},children:"Date Range"}),e.jsx(U,{"data-testid":"audit-filter-date",value:_,onChange:e=>F(e),style:{width:"100%"},allowClear:!1,showTime:{format:"HH:mm:ss",defaultValue:[j("00:00:00","HH:mm:ss"),j("23:59:59","HH:mm:ss")]},format:"YYYY-MM-DD HH:mm:ss",presets:[{label:"Today",value:[j().startOf("day"),j().endOf("day")]},{label:"Yesterday",value:[j().subtract(1,"day").startOf("day"),j().subtract(1,"day").endOf("day")]},{label:"Last 7 Days",value:[j().subtract(7,"day").startOf("day"),j().endOf("day")]},{label:"Last 30 Days",value:[j().subtract(30,"day").startOf("day"),j().endOf("day")]},{label:"This Month",value:[j().startOf("month"),j().endOf("month")]},{label:"Last Month",value:[j().subtract(1,"month").startOf("month"),j().subtract(1,"month").endOf("month")]}]})]})}),e.jsx(k,{xs:24,sm:12,md:6,children:e.jsxs(g,{direction:"vertical",size:"small",style:{width:"100%"},children:[e.jsx(I,{strong:!0,style:{fontSize:"14px",color:D.colorText},children:"Entity Type"}),e.jsx(T,{"data-testid":"audit-filter-entity",placeholder:"All entities",allowClear:!0,value:J,onChange:V,style:{width:"100%"},options:[{label:"All Entities",value:void 0},...oe.map(e=>({label:e,value:e}))]})]})}),e.jsx(k,{xs:24,sm:12,md:6,children:e.jsxs(g,{direction:"vertical",size:"small",style:{width:"100%"},children:[e.jsx(I,{strong:!0,style:{fontSize:"14px",color:D.colorText},children:"Search"}),e.jsx(C,{"data-testid":"audit-filter-search",placeholder:"Search in logs...",prefix:e.jsx(d,{}),value:P,onChange:e=>W(e.target.value),allowClear:!0,autoComplete:"off"})]})}),e.jsx(k,{xs:24,sm:12,md:2,children:e.jsxs(g,{direction:"vertical",size:"small",style:{width:"100%"},children:[e.jsx(I,{strong:!0,style:{fontSize:"14px",color:"transparent"},children:"Actions"}),e.jsx(H,{"data-testid":"audit-refresh-button",icon:e.jsx(m,{}),onClick:()=>X(),loading:Q,style:{...B.touchTarget,width:"100%"},children:"Refresh"})]})}),e.jsx(k,{xs:24,sm:12,md:2,children:e.jsxs(g,{direction:"vertical",size:"small",style:{width:"100%"},children:[e.jsx(I,{strong:!0,style:{fontSize:"14px",color:"transparent"},children:"Export"}),e.jsx(b,{title:ie&&0!==ie.length?"Export audit logs as CSV or JSON":"No data available to export",children:e.jsx(M,{menu:{items:re},disabled:!ie||0===ie.length,children:e.jsx(H,{"data-testid":"audit-export-button",icon:e.jsx(n,{}),style:{...B.touchTarget,width:"100%"},children:"Export"})})})]})})]})})}),ee&&e.jsx(z,{message:"Unable to Load Audit Logs",description:Z?.message||"There was an error loading audit logs. Please try refreshing or adjusting your date range.",type:"error",closable:!0,showIcon:!0,style:{marginBottom:16},action:e.jsx(H,{size:"small",style:B.touchTargetSmall,onClick:()=>X(),loading:Q,children:"Try Again"})}),e.jsx(Y,{"data-testid":"audit-table-card",style:de,styles:{body:ce},children:e.jsx("div",{ref:$,style:{flex:1,minHeight:0,overflow:"hidden",display:"flex",flexDirection:"column"},children:e.jsx(L,{"data-testid":"audit-table",columns:le,dataSource:ie,loading:Q,rowKey:e=>`${e.timestamp}-${e.action}-${e.entityName}`,pagination:{total:ie?.length||0,pageSize:te,showSizeChanger:!1,showTotal:(e,t)=>`Showing ${t[0]}-${t[1]} of ${e} logs`,position:["bottomRight"],className:"audit-table-pagination"},scroll:{x:"max-content"},className:"full-height-table",style:{flex:1},sticky:!0,locale:{emptyText:e.jsx(O,{description:e.jsxs(g,{direction:"vertical",align:"center",children:[e.jsx(I,{type:"secondary",children:ee?"Unable to load audit logs":0===ie?.length&&K&&K.length>0?"No logs match your current filters":"No audit logs found for the selected date range"}),!ee&&e.jsx(H,{type:"link",style:B.touchTarget,onClick:()=>{W(""),V(void 0),F([j().subtract(30,"days"),j()])},children:"Clear filters and expand date range"})]})})}})})})]})};export{B as default};
