# Docker Compose for CI Backend
# Standalone service definitions for GitHub Actions CI/CD
# Mirrors elite repository structure but self-contained in console
#
# Usage:
#   source .ci/scripts/infra/ci-env.sh
#   docker compose -f .ci/docker/ci/docker-compose.yml up -d
#
# Images are pre-pulled in CI; locally, compose builds from source via ci-start.sh.

services:
  web:
    image: ${DOCKER_REGISTRY:-rediacc}/web:${WEB_TAG:-${TAG:-local}}
    build:
      context: ../../..
      dockerfile: Dockerfile
    pull_policy: never
    container_name: rediacc-web
    hostname: rediacc-web
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
    environment:
      - SYSTEM_DOMAIN=${SYSTEM_DOMAIN:-localhost}
      - ENABLE_HTTPS=${ENABLE_HTTPS:-false}
    networks:
      internet:
      intranet:
        aliases:
          - rediacc-web
    depends_on:
      api:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 10s

  api:
    image: ${DOCKER_REGISTRY:-rediacc}/api:${API_TAG:-${TAG:-local}}
    build:
      context: ../../../private/middleware
      dockerfile: Dockerfile
    pull_policy: never
    container_name: rediacc-api
    hostname: rediacc-api
    environment:
      # Runtime configuration
      - ASPNETCORE_ENVIRONMENT=Production
      - CONNECTION_STRING=${CONNECTION_STRING}
      - DOCKER_BRIDGE_IMAGE=${DOCKER_BRIDGE_IMAGE}
      - DOCKER_INTERNET_NETWORK=rediacc_internet
      - DOCKER_BRIDGE_NETWORK_MODE=${DOCKER_BRIDGE_NETWORK_MODE:-host}
      - DOCKER_BRIDGE_API_URL=${DOCKER_BRIDGE_API_URL:-http://localhost}
      # Schema initialization (used by db-init.sh for DDL)
      - MSSQL_SA_PASSWORD=${MSSQL_SA_PASSWORD}
      - MSSQL_RA_PASSWORD=${MSSQL_RA_PASSWORD}
      - REDIACC_DATABASE_NAME=${REDIACC_DATABASE_NAME}
      - REDIACC_SQL_USERNAME=${REDIACC_SQL_USERNAME}
      # Organization initialization (used by InitializeOrganization tool)
      - SYSTEM_ADMIN_EMAIL=${SYSTEM_ADMIN_EMAIL:-admin@rediacc.io}
      - SYSTEM_ADMIN_PASSWORD=${SYSTEM_ADMIN_PASSWORD:-admin}
      - SYSTEM_ORGANIZATION_NAME=${SYSTEM_ORGANIZATION_NAME:-Default Organization}
      - SYSTEM_ORGANIZATION_VAULT_DEFAULTS=${SYSTEM_ORGANIZATION_VAULT_DEFAULTS:-}
      - SYSTEM_DEFAULT_BRIDGE_NAME=${SYSTEM_DEFAULT_BRIDGE_NAME:-Global Bridges}
      - SYSTEM_DEFAULT_REGION_NAME=${SYSTEM_DEFAULT_REGION_NAME:-Default Region}
      - SYSTEM_DEFAULT_TEAM_NAME=${SYSTEM_DEFAULT_TEAM_NAME:-Private Team}
      # CI/TEST mode (bypasses email and captcha validation)
      - CI_MODE=${CI_MODE:-true}
      # Account server configuration
      - ACCOUNT_SERVER_URL=${ACCOUNT_SERVER_URL:-http://account-server:3000}
      - ACCOUNT_SERVER_API_KEY=${ACCOUNT_SERVER_API_KEY}
      - ED25519_PUBLIC_KEY=${ED25519_PUBLIC_KEY}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      sql:
        condition: service_healthy
      account-server:
        condition: service_healthy
    networks:
      internet:
      intranet:
        aliases:
          - rediacc-api
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/api/health"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 30s

  sql:
    image: ${SQL_BASE_IMAGE:-mcr.microsoft.com/mssql/server:2022-CU21-ubuntu-22.04}
    container_name: rediacc-sql
    hostname: rediacc-sql
    ports:
      - "${SQL_PORT:-1433}:1433"
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_PID=Express
      - MSSQL_SA_PASSWORD=${MSSQL_SA_PASSWORD}
    volumes:
      - ./mssql:/var/opt/mssql
    networks:
      intranet:
        aliases:
          - rediacc-sql
          - sql
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P \"$$MSSQL_SA_PASSWORD\" -Q 'SELECT 1' -C || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s

  account-server:
    build:
      context: ../../..
      dockerfile: private/account/Dockerfile
    container_name: rediacc-account-server
    hostname: rediacc-account-server
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      - S3_ENDPOINT=http://account-rustfs:9000
      - S3_BUCKET=subscriptions
      - S3_ACCESS_KEY_ID=${RUSTFS_ACCESS_KEY:-rustfsadmin}
      - S3_SECRET_ACCESS_KEY=${RUSTFS_SECRET_KEY:-rustfsadmin}
      - ED25519_PRIVATE_KEY=${ED25519_PRIVATE_KEY}
      - ED25519_PUBLIC_KEY=${ED25519_PUBLIC_KEY}
      - API_KEY=${ACCOUNT_SERVER_API_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET:-}
    depends_on:
      account-rustfs:
        condition: service_healthy
      account-rustfs-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3000/health').then(r=>{if(!r.ok)process.exit(1)})"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 10s
    networks:
      intranet:
        aliases:
          - account-server
    restart: unless-stopped

  account-rustfs:
    image: rustfs/rustfs:latest
    container_name: rediacc-account-rustfs
    hostname: rediacc-account-rustfs
    environment:
      - RUSTFS_VOLUMES=/data/rustfs{0...3}
      - RUSTFS_ADDRESS=0.0.0.0:9000
      - RUSTFS_ACCESS_KEY=${RUSTFS_ACCESS_KEY:-rustfsadmin}
      - RUSTFS_SECRET_KEY=${RUSTFS_SECRET_KEY:-rustfsadmin}
    volumes:
      - rustfs_data_0:/data/rustfs0
      - rustfs_data_1:/data/rustfs1
      - rustfs_data_2:/data/rustfs2
      - rustfs_data_3:/data/rustfs3
    depends_on:
      account-rustfs-volume-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -f http://127.0.0.1:9000/health"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 15s
    networks:
      intranet:
        aliases:
          - account-rustfs
    restart: unless-stopped

  # Fix volume permissions (RustFS runs as UID 10001)
  account-rustfs-volume-init:
    image: alpine
    container_name: rediacc-account-rustfs-volume-init
    volumes:
      - rustfs_data_0:/data0
      - rustfs_data_1:/data1
      - rustfs_data_2:/data2
      - rustfs_data_3:/data3
    command: sh -c "chown -R 10001:10001 /data0 /data1 /data2 /data3"
    restart: "no"

  account-rustfs-init:
    image: amazon/aws-cli:latest
    container_name: rediacc-account-rustfs-init
    depends_on:
      account-rustfs:
        condition: service_healthy
    environment:
      - AWS_ACCESS_KEY_ID=${RUSTFS_ACCESS_KEY:-rustfsadmin}
      - AWS_SECRET_ACCESS_KEY=${RUSTFS_SECRET_KEY:-rustfsadmin}
    entrypoint: /bin/sh -c "aws --endpoint-url http://account-rustfs:9000 s3 mb s3://subscriptions 2>/dev/null || true"
    networks:
      - intranet

# Networks created by compose (not external) for standalone CI mode
networks:
  internet:
    name: rediacc_internet
  intranet:
    name: rediacc_intranet

volumes:
  rustfs_data_0:
  rustfs_data_1:
  rustfs_data_2:
  rustfs_data_3:
