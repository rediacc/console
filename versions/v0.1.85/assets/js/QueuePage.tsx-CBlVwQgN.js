import{j as e}from"./chunk-DXw4Pgvm.js";import{r as t}from"./chunk-DZuWtVpy.js";import{u as a,T as s,E as i,W as n,k as o,G as l,n as r,h as d,g as c,C as u}from"../index-4JeGDNMa.js";import{D as h}from"./chunk-BsdCfluv.js";import{S as m}from"./chunk-CPqA7Rd7.js";import{R as x}from"./chunk-DjYUElpC.js";import{C as j}from"./chunk-B5mJ0Ouc.js";import{P as p,Q as g}from"./chunk-BUvK3MIw.js";import{E as y}from"./chunk-M342VvV0.js";import{b as f,a as C,c as S}from"./chunk-BbZU7JC1.js";import{R as b}from"./chunk-D2eWlMlt.js";import{p as k,s as T,u as I,a as N,S as w,ag as E,f as v,y as L,I as z,h as D,B as M,T as q,l as O,D as R,W as $,i as A,M as P}from"./chunk-DcXv3kLI.js";import{a as Y}from"./chunk-xSw6NTs2.js";import{u as B}from"./chunk-CM3g5OHp.js";import"./chunk-oDcFv_qo.js";import"./chunk-lGptOMHx.js";import"./chunk-sYvc2Cs9.js";const{Text:F}=q,{RangePicker:G}=E,U=()=>{const{t:E}=B(["queue"]),q=a(),[U,H]=t.useState(""),[W,K]=t.useState("active"),[_,V]=t.useState({teamName:"",includeCompleted:!0,includeCancelled:!0,staleThresholdMinutes:10,maxRecords:1e3}),[Z,J]=t.useState(null),[Q,X]=t.useState([]),[ee,te]=t.useState(""),[ae,se]=t.useState(!1),[ie,ne]=t.useState(null),[oe,le]=t.useState(20),[re,de]=t.useState(1),[ce,ue]=t.useState(20),[he,me]=t.useState(1),[xe,je]=t.useState(20),[pe,ge]=t.useState(1),[ye,fe]=t.useState(20),[Ce,Se]=t.useState(1),be=e=>/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(e),ke=t.useMemo(()=>({..._,teamName:U,includeCancelled:"cancelled"===W||_.includeCancelled,includeCompleted:"completed"===W||_.includeCompleted,dateFrom:Z?.[0]?.startOf("day").format("YYYY-MM-DD HH:mm:ss"),dateTo:Z?.[1]?.endOf("day").format("YYYY-MM-DD HH:mm:ss"),status:Q.join(","),...ee.trim()&&be(ee.trim())?{taskId:ee.trim()}:{}}),[_,U,Z,Q,ee,W]),{data:Te,isLoading:Ie,refetch:Ne,isRefetching:we}=f(ke),{data:Ee}=C(),ve=S(),Le=Ie||we,ze=e=>{const t=Te?.items||[],a=`queue_export_${v().format("YYYY-MM-DD_HH-mm-ss")}.${e}`;if("csv"===e){const e=[["Task ID","Status","Priority","Age (minutes)","Team","Machine","Region","Bridge","Has Response","Retry Count","Created By","Created"].join(","),...t.map(e=>[e.taskId,e.healthStatus,e.priorityLabel||"",e.ageInMinutes,e.teamName,e.machineName,e.regionName,e.bridgeName,e.hasResponse?"Yes":"No",e.retryCount||0,e.createdBy||"",e.createdTime].map(e=>`"${e||""}"`).join(","))].join("\n"),s=new Blob([e],{type:"text/csv"}),i=URL.createObjectURL(s),n=document.createElement("a");n.href=i,n.download=a,n.click(),URL.revokeObjectURL(i),o("success",`Exported ${t.length} items to ${a}`)}else{const e=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),s=URL.createObjectURL(e),i=document.createElement("a");i.href=s,i.download=a,i.click(),URL.revokeObjectURL(s),o("success",`Exported ${t.length} items to ${a}`)}},De=[{title:"Task ID",dataIndex:"taskId",key:"taskId",width:200,render:t=>e.jsx(F,{code:!0,copyable:!0,children:t})},{title:"Status",dataIndex:"healthStatus",key:"healthStatus",width:120,render:(t,a)=>{const s={PENDING:{color:"default",icon:e.jsx(u,{})},ACTIVE:{color:"processing",icon:e.jsx(p,{})},STALE:{color:"warning",icon:e.jsx(n,{})},STALE_PENDING:{color:"orange",icon:e.jsx(n,{})},CANCELLING:{color:"warning",icon:e.jsx(p,{spin:!0})},COMPLETED:{color:"success",icon:e.jsx(c,{})},FAILED:{color:"error",icon:e.jsx(i,{})},CANCELLED:{color:"error",icon:e.jsx(j,{})},UNKNOWN:{color:"default",icon:e.jsx(i,{})}},o=s[t]||s.UNKNOWN,l="ACTIVE"===t&&a.status?`${a.status} (${t})`:t;let r;if(a.minutesSinceAssigned)r=`${a.minutesSinceAssigned} minutes since assigned`;else if("STALE_PENDING"===t){r=`Pending for ${Math.floor(a.ageInMinutes/60)} hours - may need attention`}return e.jsx(O,{title:r,children:e.jsx(D,{color:o.color,icon:o.icon,children:l})})}},{title:"Priority",dataIndex:"priorityLabel",key:"priority",width:140,render:(t,a)=>{if(!t||!a.priority)return e.jsx(F,{type:"secondary",children:"-"});const s={1:{color:"red",icon:e.jsx(i,{}),timeout:"33s"},2:{color:"orange",icon:void 0,timeout:"Tier timeout"},3:{color:"gold",icon:void 0,timeout:"Tier timeout"},4:{color:"blue",icon:void 0,timeout:"Tier timeout"},5:{color:"green",icon:void 0,timeout:"Tier timeout"}},n=s[a.priority]||s[3];return e.jsx(O,{title:e.jsxs("div",{children:[e.jsx("div",{style:{marginBottom:4},children:e.jsx("strong",{children:t})}),e.jsx("div",{style:{fontSize:12},children:1===a.priority?E("queue:priorityTooltipP1"):E("queue:priorityTooltipTier")})]}),children:e.jsx(D,{color:n.color,icon:n.icon,children:t})})},sorter:(e,t)=>(e.priority||3)-(t.priority||3)},{title:"Age",dataIndex:"ageInMinutes",key:"ageInMinutes",width:100,render:e=>e<60?`${e}m`:e<1440?`${Math.floor(e/60)}h ${e%60}m`:`${Math.floor(e/1440)}d ${Math.floor(e%1440/60)}h`,sorter:(e,t)=>e.ageInMinutes-t.ageInMinutes},{title:"Team",dataIndex:"teamName",key:"teamName"},{title:"Machine",dataIndex:"machineName",key:"machineName",render:t=>e.jsxs(N,{children:[e.jsx(h,{}),t]})},{title:"Region",dataIndex:"regionName",key:"regionName",render:t=>e.jsxs(N,{children:[e.jsx(l,{}),t]})},{title:"Bridge",dataIndex:"bridgeName",key:"bridgeName",render:t=>e.jsxs(N,{children:[e.jsx(r,{}),t]})},{title:"Response",dataIndex:"hasResponse",key:"hasResponse",width:80,render:t=>t?e.jsx(D,{color:"success",children:"Yes"}):e.jsx(D,{children:"No"})},{title:"Retries",dataIndex:"retryCount",key:"retryCount",width:80,render:(t,a)=>{if(!t&&0!==t)return e.jsx(F,{type:"secondary",children:"-"});const s=0===t?"green":t<2?"orange":"red",n=t>=2&&a.permanentlyFailed?e.jsx(i,{}):void 0;return e.jsx(O,{title:e.jsxs("div",{children:[a.lastFailureReason||"No failures",a.lastRetryAt&&e.jsxs("div",{style:{marginTop:4,fontSize:"12px"},children:["Last retry: ",Y(a.lastRetryAt,"datetime")]})]}),children:e.jsxs(D,{color:s,icon:n,children:[t,"/2"]})})},sorter:(e,t)=>(e.retryCount||0)-(t.retryCount||0)},{title:"Created By",dataIndex:"createdBy",key:"createdBy",width:150,render:t=>t||e.jsx(F,{type:"secondary",children:"-"})},{title:"Age",dataIndex:"ageInMinutes",key:"age",width:100,render:(t,a)=>{const s=Math.floor(t/60),i=t%60;let n,o="";return o=s>0?`${s}h ${i}m`:`${i}m`,"PENDING"===a.status&&s>=6?n="orange":"PENDING"===a.status&&s>=12&&(n="red"),e.jsx(F,{style:{color:n},children:o})},sorter:(e,t)=>e.ageInMinutes-t.ageInMinutes},{title:"Created",dataIndex:"createdTime",key:"createdTime",width:180,render:e=>v(e).format("YYYY-MM-DD HH:mm:ss"),sorter:(e,t)=>new Date(e.createdTime).getTime()-new Date(t.createdTime).getTime()},{title:"Actions",key:"actions",width:180,render:(t,a)=>e.jsxs(N,{size:"small",children:[e.jsx(O,{title:"Trace",children:e.jsx(M,{size:"small",type:"primary",icon:e.jsx(d,{}),style:q.touchTargetSmall,onClick:()=>{return e=a.taskId,ne(e),void se(!0);var e},"data-testid":`queue-trace-button-${a.taskId}`,"aria-label":"Trace"})}),a.canBeCancelled&&"CANCELLED"!==a.healthStatus&&"CANCELLING"!==a.healthStatus&&e.jsx(O,{title:"Cancel",children:e.jsx(M,{size:"small",danger:!0,icon:e.jsx(j,{}),style:q.touchTargetSmall,onClick:()=>(async e=>{P.confirm({title:"Cancel Queue Item",content:"Are you sure you want to cancel this queue item? This action cannot be undone.",okText:"Yes, Cancel",okType:"danger",cancelText:"No",onOk:async()=>{try{await ve.mutateAsync(e)}catch(t){}}})})(a.taskId),loading:ve.isPending,"data-testid":`queue-cancel-button-${a.taskId}`,"aria-label":"Cancel"})})]})}];return e.jsxs("div",{style:{padding:24},"data-testid":"queue-page-container",children:[e.jsx(k,{size:"small",style:{marginBottom:16,padding:"8px 12px"},"data-testid":"queue-filters-card",children:e.jsxs(T,{gutter:[8,8],align:"middle",wrap:!0,children:[e.jsx(I,{flex:"auto",children:e.jsxs(N,{size:8,wrap:!0,children:[e.jsx(w,{size:"small",style:{minWidth:150},placeholder:"Team",value:U||void 0,onChange:e=>{H(e||""),V({..._,machineName:""})},allowClear:!0,showSearch:!0,filterOption:(e,t)=>t?.label?.toLowerCase().includes(e.toLowerCase()),options:Ee?.teams||[],"data-testid":"queue-filter-team"}),e.jsxs(w,{size:"small",mode:"multiple",style:{minWidth:150},placeholder:"Status",value:Q,onChange:X,allowClear:!0,maxTagCount:"responsive","data-testid":"queue-filter-status",children:[e.jsx(w.Option,{value:"PENDING",children:"Pending"}),e.jsx(w.Option,{value:"ACTIVE",children:"Active"}),e.jsx(w.Option,{value:"STALE",children:"Stale"}),e.jsx(w.Option,{value:"CANCELLING",children:"Cancelling"}),e.jsx(w.Option,{value:"COMPLETED",children:"Completed"}),e.jsx(w.Option,{value:"FAILED",children:"Failed"}),e.jsx(w.Option,{value:"CANCELLED",children:"Cancelled"})]}),e.jsx(G,{size:"small",format:"YYYY-MM-DD",value:Z,onChange:e=>J(e),placeholder:["Start","End"],presets:[{label:"Today",value:[v().startOf("day"),v().endOf("day")]},{label:"Last 7D",value:[v().subtract(7,"day").startOf("day"),v()]},{label:"Last 30D",value:[v().subtract(30,"day").startOf("day"),v()]}],"data-testid":"queue-filter-date"}),e.jsx(L,{checked:_.onlyStale,onChange:e=>V({..._,onlyStale:e.target.checked}),"data-testid":"queue-checkbox-only-stale",children:"Stale Only"}),U&&e.jsxs(e.Fragment,{children:[e.jsx(w,{size:"small",style:{minWidth:130},placeholder:"Machine",value:_.machineName||void 0,onChange:e=>V({..._,machineName:e||""}),allowClear:!0,showSearch:!0,filterOption:(e,t)=>t?.label?.toLowerCase().includes(e.toLowerCase()),options:Ee?.machinesByTeam?.find(e=>e.teamName===U)?.machines||[],"data-testid":"queue-filter-machine"}),e.jsx(z,{size:"small",placeholder:"Task ID",value:ee,onChange:e=>te(e.target.value),prefix:e.jsx(m,{}),allowClear:!0,status:ee&&!be(ee)?"error":void 0,style:{width:200},"data-testid":"queue-filter-taskid"})]}),(U||Z||Q.length>0||ee&&be(ee)||_.onlyStale)&&e.jsxs(e.Fragment,{children:[U&&e.jsx(D,{closable:!0,onClose:()=>H(""),color:"blue",children:Ee?.teams?.find(e=>e.value===U)?.label||U}),Z&&e.jsxs(D,{closable:!0,onClose:()=>J(null),color:"blue",children:[Z[0]?.format("MM/DD"),"â†’",Z[1]?.format("MM/DD")]}),Q.map(t=>e.jsx(D,{closable:!0,onClose:()=>X(Q.filter(e=>e!==t)),color:"blue",children:t},t)),ee&&be(ee)&&e.jsxs(D,{closable:!0,onClose:()=>te(""),color:"blue",children:[ee.substring(0,8),"..."]}),_.onlyStale&&e.jsx(D,{closable:!0,onClose:()=>V({..._,onlyStale:!1}),color:"orange",children:"Stale"}),e.jsx(M,{type:"link",size:"small",onClick:()=>{H(""),J(null),X([]),te(""),V({..._,onlyStale:!1})},style:{padding:"0 4px",height:"auto"},children:"Clear"})]})]})}),e.jsx(I,{flex:"none",children:e.jsxs(N,{size:12,split:e.jsx("span",{style:{color:"#d9d9d9"},children:"|"}),children:[e.jsxs(N,{size:4,children:[e.jsx(s,{style:{fontSize:12}}),e.jsx(F,{type:"secondary",style:{fontSize:12},children:"Total:"}),e.jsx(F,{strong:!0,style:{fontSize:12},children:Te?.statistics?.totalCount||0})]}),e.jsxs(N,{size:4,children:[e.jsx(p,{style:{fontSize:12,color:"#1890ff"}}),e.jsx(F,{type:"secondary",style:{fontSize:12},children:"Active:"}),e.jsx(F,{strong:!0,style:{fontSize:12,color:"#1890ff"},children:(Te?.statistics?.pendingCount||0)+(Te?.statistics?.assignedCount||0)+(Te?.statistics?.processingCount||0)})]}),e.jsxs(N,{size:4,children:[e.jsx(i,{style:{fontSize:12,color:"#ff4d4f"}}),e.jsx(F,{type:"secondary",style:{fontSize:12},children:"Failed:"}),e.jsx(F,{strong:!0,style:{fontSize:12,color:"#ff4d4f"},children:Te?.statistics?.failedCount||0})]}),e.jsxs(N,{size:4,children:[e.jsx(n,{style:{fontSize:12,color:"#faad14"}}),e.jsx(F,{type:"secondary",style:{fontSize:12},children:"Stale:"}),e.jsx(F,{strong:!0,style:{fontSize:12,color:"#faad14"},children:Te?.statistics?.staleCount||0})]})]})}),e.jsx(I,{flex:"none",children:e.jsxs(N,{size:4,children:[e.jsx(O,{title:"Refresh",children:e.jsx(M,{size:"small",icon:e.jsx(x,{}),onClick:()=>Ne(),loading:Le,"data-testid":"queue-refresh-button"})}),e.jsx(R,{menu:{items:[{key:"csv",label:"Export as CSV",onClick:()=>ze("csv")},{key:"json",label:"Export as JSON",onClick:()=>ze("json")}]},children:e.jsx(O,{title:"Export",children:e.jsx(M,{size:"small",icon:e.jsx(y,{}),"data-testid":"queue-export-dropdown"})})})]})})]})}),e.jsxs($,{activeKey:W,onChange:K,"data-testid":"queue-tabs",children:[e.jsx($.TabPane,{tab:e.jsx(O,{title:E("queue:tabs.active.tooltip"),children:e.jsxs(N,{"data-testid":"queue-tab-active",children:[e.jsx("span",{style:{marginRight:8},children:E("queue:tabs.active.title")}),e.jsx(A,{count:Te?.items?.filter(e=>!["COMPLETED","CANCELLED","FAILED"].includes(e.healthStatus)).length||0,color:"gold"})]})}),"data-testid":"queue-tabpane-active",children:e.jsx(b,{loading:Ie||we,data:Te?.items?.filter(e=>!["COMPLETED","CANCELLED","FAILED"].includes(e.healthStatus))||[],columns:De,rowKey:"taskId",searchPlaceholder:"Search queue items...",pagination:{current:re,pageSize:oe,showSizeChanger:!0,pageSizeOptions:["10","20","50","100"],showTotal:(e,t)=>`Showing records ${t[0]}-${t[1]} of ${e}`,onChange:(e,t)=>{de(e),t!==oe&&(le(t),de(1))},position:["bottomRight"]}})},"active"),e.jsx($.TabPane,{tab:e.jsx(O,{title:E("queue:tabs.completed.tooltip"),children:e.jsxs(N,{"data-testid":"queue-tab-completed",children:[e.jsx("span",{style:{marginRight:8},children:E("queue:tabs.completed.title")}),e.jsx(A,{count:Te?.statistics?.completedCount||0,showZero:!0,color:"#52c41a"})]})}),"data-testid":"queue-tabpane-completed",children:e.jsx(b,{loading:Ie||we,data:Te?.items?.filter(e=>"COMPLETED"===e.healthStatus)||[],columns:De,rowKey:"taskId",searchPlaceholder:"Search completed items...",pagination:{current:he,pageSize:ce,showSizeChanger:!0,pageSizeOptions:["10","20","50","100"],showTotal:(e,t)=>`Showing records ${t[0]}-${t[1]} of ${e}`,onChange:(e,t)=>{me(e),t!==ce&&(ue(t),me(1))},position:["bottomRight"]}})},"completed"),e.jsx($.TabPane,{tab:e.jsx(O,{title:E("queue:tabs.cancelled.tooltip"),children:e.jsxs(N,{"data-testid":"queue-tab-cancelled",children:[e.jsx("span",{style:{marginRight:8},children:E("queue:tabs.cancelled.title")}),e.jsx(A,{count:Te?.statistics?.cancelledCount||0,showZero:!0,color:"#ff4d4f"})]})}),"data-testid":"queue-tabpane-cancelled",children:e.jsx(b,{loading:Ie||we,data:Te?.items?.filter(e=>"CANCELLED"===e.healthStatus)||[],columns:De,rowKey:"taskId",searchPlaceholder:"Search cancelled items...",pagination:{current:pe,pageSize:xe,showSizeChanger:!0,pageSizeOptions:["10","20","50","100"],showTotal:(e,t)=>`Showing records ${t[0]}-${t[1]} of ${e}`,onChange:(e,t)=>{ge(e),t!==xe&&(je(t),ge(1))},position:["bottomRight"]}})},"cancelled"),e.jsx($.TabPane,{tab:e.jsx(O,{title:E("queue:tabs.failed.tooltip"),children:e.jsxs(N,{"data-testid":"queue-tab-failed",children:[e.jsx("span",{style:{marginRight:8},children:E("queue:tabs.failed.title")}),e.jsx(A,{count:Te?.statistics?.failedCount||0,showZero:!0,color:"#ff4d4f"})]})}),"data-testid":"queue-tabpane-failed",children:e.jsx(b,{loading:Ie||we,data:Te?.items?.filter(e=>"FAILED"===e.healthStatus)||[],columns:De,rowKey:"taskId",searchPlaceholder:"Search failed items...",pagination:{current:Ce,pageSize:ye,showSizeChanger:!0,pageSizeOptions:["10","20","50","100"],showTotal:(e,t)=>`Showing records ${t[0]}-${t[1]} of ${e}`,onChange:(e,t)=>{Se(e),t!==ye&&(fe(t),Se(1))},position:["bottomRight"]}})},"failed")]}),e.jsx(g,{taskId:ie,visible:ae,onClose:()=>{se(!1),ne(null)}})]})};export{U as default};
