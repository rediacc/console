#!/bin/bash

# Exit on error
set -e

# Required environment variables (must be defined in parent .env file):
# - SYSTEM_HTTP_PORT: Middleware API port
# - SYSTEM_DOMAIN: Domain for API access
# Optional environment variables:
# - CONSOLE_PORT: Console dev server port (default: 3000)

# Root directory
ROOT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Source local utilities (leverages CI infrastructure)
source "$ROOT_DIR/.ci/lib/local-common.sh"

# Function to check required environment variables
check_required_env() {
    # For sandbox mode, we don't need these variables
    if [ "$1" = "sandbox" ] || [ "${SANDBOX_MODE:-false}" = "true" ]; then
        return 0
    fi

    if [ -z "${SYSTEM_HTTP_PORT:-}" ] || [ -z "${SYSTEM_DOMAIN:-}" ]; then
        echo "âŒ Error: Required environment variables are not set!"
        echo ""
        if [ ! -f "$ROOT_DIR/../.env" ]; then
            echo "The parent .env file does not exist at: $ROOT_DIR/../.env"
        else
            echo "The parent .env file exists but is missing required variables."
        fi
        echo ""
        echo "Please ensure the following variables are defined:"
        echo "  - SYSTEM_HTTP_PORT (e.g., 7322)"
        echo "  - SYSTEM_DOMAIN (e.g., localhost)"
        echo ""
        echo "Or run in sandbox mode for open-source development:"
        echo "  ./go sandbox    # Use sandbox backend (no local setup needed)"
        exit 1
    fi
}

# Load environment variables if .env exists in parent directory
if [ -f "$ROOT_DIR/../.env" ]; then
    source "$ROOT_DIR/../.env"
fi

# Check command to determine if we need env vars
COMMAND="$1"
if [ "$COMMAND" = "sandbox" ] || [ "$COMMAND" = "help" ] || [ "$COMMAND" = "--help" ] || [ "$COMMAND" = "-h" ] || [ -z "$COMMAND" ]; then
    # These commands don't require environment variables
    :
else
    # Check if required environment variables are set after loading
    check_required_env "$COMMAND"
fi

# Console port can have a default
CONSOLE_PORT=${CONSOLE_PORT:-3000}

# Export for Vite (use offset port if available) - only if variables are set
if [ -n "$SYSTEM_HTTP_PORT" ]; then
    export VITE_HTTP_PORT=${SYSTEM_HTTP_PORT_ACTUAL:-$SYSTEM_HTTP_PORT}
    export VITE_API_URL="http://${SYSTEM_DOMAIN}:${SYSTEM_HTTP_PORT_ACTUAL:-$SYSTEM_HTTP_PORT}/api"
fi
export VITE_APP_VERSION=${TAG:-dev}
# Export Turnstile site key (Cloudflare Captcha)
export VITE_TURNSTILE_SITE_KEY=${TURNSTILE_SITE_KEY:-"0x4AAAAAACBhdTQowG3P_iM8"}

# =============================================================================
# EXISTING FUNCTIONS (Unchanged for backward compatibility)
# =============================================================================

# Function to run development server
function dev() {
  echo "Starting Rediacc Console development server..."

  # Install dependencies if node_modules doesn't exist or if package-lock.json is newer than node_modules
  if [ ! -d "$ROOT_DIR/node_modules" ] || [ "$ROOT_DIR/package-lock.json" -nt "$ROOT_DIR/node_modules" ]; then
    echo "Installing dependencies..."
    npm install
  fi

  # Set build type to DEBUG for development (will try localhost, fallback to sandbox)
  export REDIACC_BUILD_TYPE=${REDIACC_BUILD_TYPE:-DEBUG}

  # Start development server
  echo "Starting development server on port ${CONSOLE_PORT}..."
  echo "Build type: $REDIACC_BUILD_TYPE"
  PORT=$CONSOLE_PORT npm run dev
}

# Function to run in sandbox mode (for open-source contributors)
function sandbox() {
  local USE_DOCKER=false
  local DOCKER_PORT=8080
  local OPEN_BROWSER=true

  # Parse arguments
  for arg in "$@"; do
    case $arg in
      --docker)
        USE_DOCKER=true
        ;;
      --port=*)
        DOCKER_PORT="${arg#*=}"
        ;;
      --no-browser)
        OPEN_BROWSER=false
        ;;
      --help)
        echo "Usage: ./go sandbox [OPTIONS]"
        echo ""
        echo "Options:"
        echo "  --docker        Run in Docker container (recommended for quick start)"
        echo "  --port=PORT     Docker port (default: 8080)"
        echo "  --no-browser    Don't open browser automatically"
        echo ""
        echo "Examples:"
        echo "  ./go sandbox              # Run locally with npm"
        echo "  ./go sandbox --docker     # Run in Docker (recommended)"
        echo ""
        return 0
        ;;
    esac
  done

  echo "Starting Rediacc Console in Sandbox Mode (Open-Source)..."
  echo "========================================================"
  echo ""

  if [ "$USE_DOCKER" = true ]; then
    # Docker mode - build and run container
    echo "ğŸ³ Docker Mode - Building and running containerized console"
    echo ""

    # Check if Docker is installed
    if ! command -v docker &> /dev/null; then
      echo "âŒ Error: Docker is not installed!"
      echo ""
      echo "Please install Docker first:"
      echo "  - Linux: https://docs.docker.com/engine/install/"
      echo "  - macOS: https://docs.docker.com/desktop/mac/install/"
      echo "  - Windows: https://docs.docker.com/desktop/windows/install/"
      echo ""
      echo "Or run without Docker: ./go sandbox"
      return 1
    fi

    # Check if Docker daemon is running
    if ! docker info &> /dev/null; then
      echo "âŒ Error: Docker daemon is not running!"
      echo "Please start Docker and try again."
      return 1
    fi

    # Build the Docker image
    echo "ğŸ“¦ Building Docker image..."
    echo "This may take a few minutes on first run..."
    echo ""

    if ! docker build -f Dockerfile.standalone -t rediacc-console:sandbox \
      --build-arg REDIACC_BUILD_TYPE=DEBUG .; then
      echo ""
      echo "âŒ Error: Docker build failed!"
      echo "Please check the error messages above."
      return 1
    fi

    echo ""
    echo "âœ… Docker image built successfully!"
    echo ""

    # Stop any existing container
    docker stop rediacc-console-sandbox 2>/dev/null || true
    docker rm rediacc-console-sandbox 2>/dev/null || true

    # Run the container
    echo "ğŸš€ Starting container on port ${DOCKER_PORT}..."
    docker run -d \
      --name rediacc-console-sandbox \
      -p ${DOCKER_PORT}:80 \
      -e INSTANCE_NAME=sandbox \
      -e BUILD_TYPE=DEBUG \
      -e ENABLE_DEBUG=true \
      rediacc-console:sandbox

    # Wait for container to be ready
    echo -n "â³ Waiting for console to be ready"
    for i in {1..30}; do
      if curl -s http://localhost:${DOCKER_PORT}/health > /dev/null 2>&1; then
        echo " âœ“"
        break
      elif [ $i -eq 30 ]; then
        echo " âš ï¸"
        echo "Warning: Console may not be fully ready yet."
        break
      fi
      echo -n "."
      sleep 1
    done

    echo ""
    echo "âœ… Rediacc Console is running in Docker!"
    echo ""
    echo "ğŸŒ Access the console at: http://localhost:${DOCKER_PORT}"
    echo ""
    echo "ğŸ“‹ Container Management:"
    echo "  View logs:    docker logs -f rediacc-console-sandbox"
    echo "  Stop:         docker stop rediacc-console-sandbox"
    echo "  Restart:      docker start rediacc-console-sandbox"
    echo "  Remove:       docker rm -f rediacc-console-sandbox"
    echo ""

    # Open browser if requested
    if [ "$OPEN_BROWSER" = true ]; then
      open_browser "http://localhost:${DOCKER_PORT}"
    fi

    # Show logs
    echo "ğŸ“œ Showing container logs (Ctrl+C to exit):"
    echo "----------------------------------------"
    docker logs -f rediacc-console-sandbox

  else
    # Local development mode
    echo "This mode is designed for open-source contributors who want to"
    echo "work on the frontend without setting up a local backend."
    echo ""
    echo "ğŸ’¡ Tip: Use './go sandbox --docker' for easier setup with Docker"
    echo ""
    echo "The console will connect to: sandbox.rediacc.com"
    echo ""

    # Install dependencies if node_modules doesn't exist or if package-lock.json is newer than node_modules
    if [ ! -d "$ROOT_DIR/node_modules" ] || [ "$ROOT_DIR/package-lock.json" -nt "$ROOT_DIR/node_modules" ]; then
      echo "Installing dependencies..."
      npm install
    fi

    # Set environment for sandbox mode
    export REDIACC_BUILD_TYPE=DEBUG
    export SANDBOX_MODE=true
    export VITE_HTTP_PORT=7322  # Default port for consistency
    export VITE_SANDBOX_API_URL=${SANDBOX_API_URL:-https://sandbox.rediacc.com/api}
    export CONSOLE_PORT=${CONSOLE_PORT:-3000}

    # Start development server
    echo ""
    echo "Starting development server on port ${CONSOLE_PORT}..."
    echo "Build type: DEBUG (with sandbox fallback)"
    echo "Sandbox URL: $VITE_SANDBOX_API_URL"
    echo ""
    echo "Note: The console will attempt to connect to localhost:7322 first,"
    echo "      then automatically fallback to sandbox if localhost is unavailable."
    echo ""

    # Open browser if requested
    if [ "$OPEN_BROWSER" = true ]; then
      # Wait a bit for the server to start
      (sleep 3 && open_browser "http://localhost:${CONSOLE_PORT}") &
    fi

    PORT=$CONSOLE_PORT npm run dev
  fi
}

# Helper function to open browser (cross-platform)
function open_browser() {
  local url="$1"
  echo "ğŸŒ Opening browser to: $url"

  # Detect platform and open browser
  case "$OSTYPE" in
    linux*)
      if command -v xdg-open &> /dev/null; then
        xdg-open "$url" 2>/dev/null || true
      elif command -v gnome-open &> /dev/null; then
        gnome-open "$url" 2>/dev/null || true
      else
        echo "Please open your browser and navigate to: $url"
      fi
      ;;
    darwin*)
      open "$url" 2>/dev/null || true
      ;;
    msys*|cygwin*|win32)
      start "$url" 2>/dev/null || true
      ;;
    *)
      echo "Please open your browser and navigate to: $url"
      ;;
  esac
}

# Function to build the application
function build() {
  echo "Building Rediacc Console..."

  # Install dependencies if node_modules doesn't exist or if package-lock.json is newer than node_modules
  if [ ! -d "$ROOT_DIR/node_modules" ] || [ "$ROOT_DIR/package-lock.json" -nt "$ROOT_DIR/node_modules" ]; then
    echo "Installing dependencies..."
    npm install
  fi

  # Clean caches before build
  rm -rf node_modules/.vite

  # Default to RELEASE for production builds
  export REDIACC_BUILD_TYPE=${REDIACC_BUILD_TYPE:-RELEASE}
  echo "Build type: $REDIACC_BUILD_TYPE"

  # Build with NODE_ENV explicitly set to production
  NODE_ENV=production npm run build
}

# Function to preview the build
function preview() {
  echo "Previewing the Rediacc Console build..."

  # Install dependencies if node_modules doesn't exist or if package-lock.json is newer than node_modules
  if [ ! -d "$ROOT_DIR/node_modules" ] || [ "$ROOT_DIR/package-lock.json" -nt "$ROOT_DIR/node_modules" ]; then
    echo "Installing dependencies..."
    npm install
  fi

  npm run preview
}

# Function to lint the code
function lint() {
  echo "Linting code..."

  # Install dependencies if node_modules doesn't exist
  if [ ! -d "$ROOT_DIR/node_modules" ]; then
    echo "Installing dependencies..."
    npm install
  fi

  npm run lint
}

# Function to clean up
function clean() {
  local CLEAN_DOCKER=false

  # Parse arguments
  for arg in "$@"; do
    case $arg in
      --docker)
        CLEAN_DOCKER=true
        ;;
    esac
  done

  echo "Cleaning build artifacts..."
  rm -rf dist/
  rm -rf node_modules/.vite

  # Clean Docker artifacts if requested
  if [ "$CLEAN_DOCKER" = true ]; then
    echo "Cleaning Docker containers and images..."

    # Stop and remove container
    docker stop rediacc-console-sandbox 2>/dev/null || true
    docker rm rediacc-console-sandbox 2>/dev/null || true

    # Remove image
    docker rmi rediacc-console:sandbox 2>/dev/null || true

    echo "Docker artifacts cleaned."
  fi

  echo "Build artifacts cleaned."
}

# Function to run tests (deprecated - use new test commands)
function test() {
  echo "Running tests..."

  if [ -f "$ROOT_DIR/test-api.mjs" ]; then
    echo "Testing API connectivity..."
    node test-api.mjs
  else
    echo "No API tests found (test-api.mjs not present)."
  fi
}

# Function to build desktop application
function desktop() {
  local COMMAND="${1:-dev}"

  echo "Rediacc Console Desktop - $COMMAND"

  # Install dependencies if needed
  if [ ! -d "$ROOT_DIR/node_modules" ] || [ "$ROOT_DIR/package-lock.json" -nt "$ROOT_DIR/node_modules" ]; then
    echo "Installing dependencies..."
    npm install
  fi

  # Install desktop package dependencies
  if [ ! -d "$ROOT_DIR/packages/desktop/node_modules" ]; then
    echo "Installing desktop dependencies..."
    cd "$ROOT_DIR/packages/desktop"
    npm install
    cd "$ROOT_DIR"
  fi

  case "$COMMAND" in
    dev)
      echo "Starting Electron development server..."
      # Build shared packages first for HMR to work
      npm run build:packages
      cd "$ROOT_DIR/packages/desktop"
      npm run dev
      ;;
    build|pack|dist|dist:win|dist:mac|dist:linux)
      # Common build steps for all packaging commands
      npm run build:packages
      npm run build:web
      cd "$ROOT_DIR/packages/desktop"

      case "$COMMAND" in
        build)
          echo "Building Electron application..."
          npm run build
          ;;
        pack)
          echo "Packaging Electron application (unpacked)..."
          npm run pack
          ;;
        dist)
          echo "Building distributable installers for all platforms..."
          npm run dist
          ;;
        dist:win)
          echo "Building Windows installer..."
          npm run dist:win
          ;;
        dist:mac)
          echo "Building macOS installer..."
          npm run dist:mac
          ;;
        dist:linux)
          echo "Building Linux installers..."
          npm run dist:linux
          ;;
      esac
      ;;
    *)
      echo "Unknown desktop command: $COMMAND"
      echo ""
      echo "Usage: ./go desktop [COMMAND]"
      echo ""
      echo "Commands:"
      echo "  dev         Start Electron development server with HMR"
      echo "  build       Build the Electron application"
      echo "  pack        Package application (unpacked, for testing)"
      echo "  dist        Build distributable installers for all platforms"
      echo "  dist:win    Build Windows installer (NSIS)"
      echo "  dist:mac    Build macOS installer (DMG)"
      echo "  dist:linux  Build Linux installers (AppImage + deb)"
      exit 1
      ;;
  esac
}

# Function to create release package
function release() {
  echo "Creating release build..."

  # Create bin directory if it doesn't exist
  BIN_DIR="$ROOT_DIR/bin"

  # Clean up bin directory
  echo "Cleaning up bin directory..."
  rm -rf "$BIN_DIR"
  mkdir -p "$BIN_DIR"

  # Build the application first
  build

  # Get version from package.json
  VERSION=$(node -p "require('./package.json').version")

  # Copy built files from workspace package
  echo "Copying build files to bin..."
  cp -r "$ROOT_DIR/packages/web/dist/"* "$BIN_DIR/"

  # Create version info file
  echo "{
  \"version\": \"${VERSION}\",
  \"tag\": \"${TAG:-latest}\",
  \"buildDate\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
  \"gitCommit\": \"$(git rev-parse --short HEAD 2>/dev/null || echo 'unknown')\",
  \"environment\": \"production\"
}" > "$BIN_DIR/version.json"

  # Create deployment config template
  echo "{
  \"apiUrl\": \"http://${SYSTEM_DOMAIN}:${SYSTEM_HTTP_PORT}/api\",
  \"environment\": \"production\"
}" > "$BIN_DIR/config.template.json"

  echo ""
  echo "Release build created successfully!"
  echo "Version: ${VERSION}"
  echo "Files copied to: $BIN_DIR"

  # Copy to root bin/html/console for nginx serving
  echo "Copying to root bin/html/console directory for nginx..."
  ROOT_BIN="$ROOT_DIR/../bin/html/console"
  mkdir -p "$ROOT_BIN"
  # Clean existing console files
  rm -rf "$ROOT_BIN"/*
  # Copy all files to root bin/html/console
  cp -r "$BIN_DIR/"* "$ROOT_BIN/"
  echo "Files also copied to: $ROOT_BIN"

  # Build www (Astro marketing site) if it exists
  if [ -d "$ROOT_DIR/packages/www" ]; then
    echo ""
    echo "Building www (Astro marketing site)..."
    (cd "$ROOT_DIR/packages/www" && npm run build)
    # Copy www build to root bin/html (serves at root path)
    ROOT_HTML="$ROOT_DIR/../bin/html"
    if [ -d "$ROOT_DIR/packages/www/dist" ]; then
      echo "Copying www build to: $ROOT_HTML"
      cp -r "$ROOT_DIR/packages/www/dist/"* "$ROOT_HTML/"
    fi
  fi

  # Build json (template catalog) if it exists
  if [ -d "$ROOT_DIR/packages/json" ]; then
    echo ""
    echo "Building json (template catalog)..."
    (cd "$ROOT_DIR/packages/json" && ./generate.sh)
    # Copy json build to root bin/html/json
    ROOT_JSON="$ROOT_DIR/../bin/html/json"
    mkdir -p "$ROOT_JSON"
    if [ -d "$ROOT_DIR/packages/json/dist" ]; then
      echo "Copying json build to: $ROOT_JSON"
      cp -r "$ROOT_DIR/packages/json/dist/"* "$ROOT_JSON/"
    fi
  fi
}

# Function to setup development environment
function setup() {
  local SETUP_MODE="$1"

  if [ "$SETUP_MODE" = "sandbox" ]; then
    echo "Setting up sandbox development environment..."
    echo "============================================"
    echo ""
    echo "This setup is for open-source contributors who want to"
    echo "work on the frontend without a local backend."
    echo ""

    # Install dependencies
    echo "Installing dependencies..."
    npm install

    echo ""
    echo "âœ… Sandbox environment setup complete!"
    echo ""
    echo "You can now run:"
    echo "  ./go sandbox    # Start with sandbox backend"
    echo ""
    return 0
  fi

  echo "Setting up development environment..."

  # Check environment variables
  if [ -z "${SYSTEM_HTTP_PORT:-}" ] || [ -z "${SYSTEM_DOMAIN:-}" ]; then
    echo ""
    echo "âš ï¸  Environment variables not configured."
    echo ""
    echo "You have two options:"
    echo ""
    echo "1. Setup for local development (requires backend):"
    echo "   - Create a .env file in the parent directory with:"
    echo "     SYSTEM_HTTP_PORT=7322"
    echo "     SYSTEM_DOMAIN=localhost"
    echo "   - Then run: ./go setup"
    echo ""
    echo "2. Setup for sandbox development (no backend needed):"
    echo "   ./go setup sandbox"
    echo ""
    return 1
  fi

  # Check if middleware is running
  if ! curl -s http://${SYSTEM_DOMAIN}:${SYSTEM_HTTP_PORT}/api > /dev/null 2>&1; then
    echo "âš ï¸  Middleware API is not running on ${SYSTEM_DOMAIN}:${SYSTEM_HTTP_PORT}!"
    echo "Start it with: cd ../middleware && ./go start"
    echo ""
    echo "Or use sandbox mode if you don't have a local backend:"
    echo "  ./go sandbox"
  else
    echo "âœ… Middleware API is running on ${SYSTEM_DOMAIN}:${SYSTEM_HTTP_PORT}"
  fi

  # Install dependencies
  echo "Installing dependencies..."
  npm install

  # Create .env file if it doesn't exist
  if [ ! -f "$ROOT_DIR/.env" ]; then
    echo "Creating .env file..."
    echo "VITE_API_URL=http://${SYSTEM_DOMAIN}:${SYSTEM_HTTP_PORT}/api" > "$ROOT_DIR/.env"
    echo "âœ… .env file created with API URL: http://${SYSTEM_DOMAIN}:${SYSTEM_HTTP_PORT}/api"
  fi

  echo ""
  echo "âœ… Development environment setup complete!"
  echo ""
  echo "ğŸ” Telemetry Information:"
  echo "  - OpenTelemetry telemetry is enabled for user behavior analytics"
  echo "  - Telemetry data is sent to obs.rediacc.com for monitoring and insights"
  echo "  - No sensitive data (passwords, keys) is collected"
  echo "  - Data helps improve the application and user experience"
  echo ""
  echo "You can now run: ./go dev"
}


# Function to check status
function status() {
  echo "Rediacc Console Status:"
  echo "======================"

  # Check if dev server is running
  if lsof -i :${CONSOLE_PORT} > /dev/null 2>&1; then
    echo "âœ… Development server is running on port ${CONSOLE_PORT}"
  else
    echo "âŒ Development server is not running"
  fi

  # Check if middleware is running
  if curl -s http://${SYSTEM_DOMAIN}:${SYSTEM_HTTP_PORT}/api > /dev/null 2>&1; then
    echo "âœ… Middleware API is running on ${SYSTEM_DOMAIN}:${SYSTEM_HTTP_PORT}"
  else
    echo "âŒ Middleware API is not running"
  fi

  # Check build status
  if [ -d "$ROOT_DIR/dist" ]; then
    echo "âœ… Production build exists"
  else
    echo "âŒ No production build found"
  fi


  # Check bin/console directory
  if [ -d "$ROOT_DIR/../bin/console" ]; then
    echo "âœ… Console binaries in bin/console:"
    if [ -f "$ROOT_DIR/../bin/console/rediacc-console" ]; then
      echo "   â€¢ Linux executable"
    fi
    if [ -f "$ROOT_DIR/../bin/console/rediacc-console.deb" ]; then
      echo "   â€¢ Debian package (.deb)"
    fi
    if [ -f "$ROOT_DIR/../bin/console/rediacc-console.rpm" ]; then
      echo "   â€¢ RPM package (.rpm)"
    fi
    if [ -f "$ROOT_DIR/../bin/console/rediacc-console.exe" ]; then
      echo "   â€¢ Windows executable"
    fi
    if [ -d "$ROOT_DIR/../bin/console/rediacc-console.app" ]; then
      echo "   â€¢ macOS app bundle"
    fi
    if [ -f "$ROOT_DIR/../bin/console/rediacc-console.AppImage" ]; then
      echo "   â€¢ AppImage"
    fi
  fi

  # Show version
  if [ -f "$ROOT_DIR/package.json" ]; then
    VERSION=$(node -p "require('./package.json').version")
    echo "ğŸ“¦ Version: ${VERSION}"
  fi
}

# =============================================================================
# NEW COMMAND HANDLERS (Delegate to CI scripts)
# =============================================================================

# Handle test commands
handle_test_command() {
    local subcommand="${1:-}"
    shift || true

    ensure_deps

    case "$subcommand" in
        unit)
            log_step "Running unit tests"
            ensure_packages_built
            "$LOCAL_CI_DIR/scripts/test/run-unit.sh" "$@"
            ;;
        cli)
            log_step "Running CLI integration tests"
            ensure_packages_built
            "$LOCAL_CI_DIR/scripts/test/run-cli.sh" "$@"
            ;;
        e2e)
            log_step "Running E2E tests"

            # Check middleware availability
            if ! check_middleware; then
                log_warn "Middleware not detected at ${VITE_API_URL:-http://localhost:7322/api}"
                log_warn ""
                log_warn "Options:"
                log_warn "  1. Start middleware: cd ../middleware && ./go up"
                log_warn "  2. Use sandbox: export VITE_API_URL=https://sandbox.rediacc.com/api"
                log_warn ""
                prompt_continue "Continue anyway" || exit 1
            fi

            ensure_packages_built
            "$LOCAL_CI_DIR/scripts/build/build-web.sh"
            "$LOCAL_CI_DIR/scripts/test/run-e2e.sh" "$@"
            ;;
        all)
            log_step "Running all tests"
            handle_test_command unit
            handle_test_command cli
            handle_test_command e2e --projects chromium
            ;;
        "")
            # Interactive prompt
            echo ""
            echo "Select test type:"
            echo "  1) Unit tests"
            echo "  2) CLI integration tests"
            echo "  3) E2E tests (Chromium)"
            echo "  4) All tests"
            echo ""
            read -p "Choice [1-4]: " choice
            case "$choice" in
                1) handle_test_command unit ;;
                2) handle_test_command cli ;;
                3) handle_test_command e2e --projects chromium ;;
                4) handle_test_command all ;;
                *)
                    log_error "Invalid choice"
                    exit 1
                    ;;
            esac
            ;;
        *)
            log_error "Unknown test subcommand: $subcommand"
            echo ""
            echo "Usage: ./go test [SUBCOMMAND] [OPTIONS]"
            echo ""
            echo "Subcommands:"
            echo "  unit              Run unit tests"
            echo "  cli               Run CLI integration tests"
            echo "  e2e [opts]        Run E2E tests (Playwright)"
            echo "  all               Run all tests"
            echo ""
            echo "E2E Options:"
            echo "  --projects <browsers>  Browsers to test (chromium firefox webkit msedge)"
            echo "  --headed               Show browser window"
            echo "  --debug                Open Playwright inspector"
            echo "  --ui                   Interactive UI mode"
            echo "  --slowmo <ms>          Slow down actions by specified milliseconds"
            echo "  --test <filter>        Run specific test file or line"
            echo ""
            echo "Examples:"
            echo "  ./go test e2e --projects chromium firefox"
            echo "  ./go test e2e --headed --slowmo 500"
            echo "  ./go test e2e --debug --test auth.spec.ts:42"
            exit 1
            ;;
    esac
}

# Handle quality commands
handle_quality_command() {
    local subcommand="${1:-}"

    ensure_deps

    case "$subcommand" in
        lint)
            log_step "Running lint checks (ESLint + Knip)"
            npm run lint -- --max-warnings 0
            npm run lint:unused
            ;;
        format)
            log_step "Checking code formatting (Biome)"
            npm run check:format
            ;;
        types)
            log_step "Checking TypeScript types"
            npm run typecheck
            ;;
        i18n)
            log_step "Checking translations"
            npm run check:i18n
            ;;
        security)
            log_step "Running security audit"
            npm audit --audit-level=critical
            ;;
        unused)
            log_step "Checking for unused code (Knip)"
            npm run lint:unused
            ;;
        version)
            log_step "Checking workspace version consistency"
            npm run version:check
            ;;
        ""|all)
            log_step "Running all quality checks"
            npm run quality
            ;;
        *)
            log_error "Unknown quality subcommand: $subcommand"
            echo ""
            echo "Usage: ./go quality [SUBCOMMAND]"
            echo ""
            echo "Subcommands:"
            echo "  lint          Run ESLint + Knip"
            echo "  format        Check code formatting (Biome)"
            echo "  types         Check TypeScript types"
            echo "  i18n          Check translations"
            echo "  security      Run npm security audit"
            echo "  unused        Check for unused code"
            echo "  version       Check workspace version consistency"
            echo "  all           Run all quality checks (default)"
            exit 1
            ;;
    esac
}

# Handle fix commands
handle_fix_command() {
    local subcommand="${1:-}"

    ensure_deps

    case "$subcommand" in
        format)
            log_step "Auto-fixing code formatting (Biome)"
            npm run fix:format
            ;;
        lint)
            log_step "Auto-fixing linting issues (ESLint)"
            npm run fix:lint
            ;;
        i18n)
            log_step "Regenerating translation hashes"
            npm run fix:i18n
            ;;
        unused)
            log_step "Auto-fixing unused code (Knip)"
            npm run fix:unused
            ;;
        imports)
            log_step "Organizing imports (Biome)"
            npm run fix:imports
            ;;
        version)
            log_step "Fixing version mismatches (Syncpack)"
            npm run fix:version
            ;;
        ""|all)
            log_step "Auto-fixing all issues"
            npm run fix:all
            ;;
        *)
            log_error "Unknown fix subcommand: $subcommand"
            echo ""
            echo "Usage: ./go fix [SUBCOMMAND]"
            echo ""
            echo "Subcommands:"
            echo "  format        Auto-fix code formatting"
            echo "  lint          Auto-fix linting issues"
            echo "  i18n          Regenerate translation hashes"
            echo "  unused        Auto-fix unused code"
            echo "  imports       Organize imports"
            echo "  version       Fix version mismatches"
            echo "  all           Auto-fix everything (default)"
            exit 1
            ;;
    esac
}

# Handle check commands (pre-push validation)
handle_check_command() {
    local subcommand="${1:-}"

    ensure_deps

    case "$subcommand" in
        quick)
            log_step "Running quick checks (lint, format, types)"
            echo ""

            npm run check:lint || { log_error "Lint check failed"; exit 1; }
            npm run check:format || { log_error "Format check failed"; exit 1; }
            npm run typecheck || { log_error "Type check failed"; exit 1; }

            echo ""
            log_info "Quick checks passed!"
            ;;
        full)
            log_step "Running full validation (quality + unit tests)"
            echo ""

            npm run quality || { log_error "Quality checks failed"; exit 1; }
            "$LOCAL_CI_DIR/scripts/test/run-unit.sh" || { log_error "Unit tests failed"; exit 1; }

            echo ""
            log_info "Full validation passed!"
            ;;
        "")
            # Comprehensive pre-push validation
            log_step "Running comprehensive pre-push validation"
            echo ""

            log_step "Phase 1/3: Quality Checks"
            npm run quality || { log_error "Quality checks failed"; exit 1; }

            log_step "Phase 2/3: Build Verification"
            "$LOCAL_CI_DIR/scripts/setup/build-packages.sh" || { log_error "Package build failed"; exit 1; }
            "$LOCAL_CI_DIR/scripts/build/build-web.sh" || { log_error "Web build failed"; exit 1; }
            "$LOCAL_CI_DIR/scripts/build/build-cli.sh" || { log_error "CLI build failed"; exit 1; }

            log_step "Phase 3/3: Unit Tests"
            "$LOCAL_CI_DIR/scripts/test/run-unit.sh" || { log_error "Unit tests failed"; exit 1; }

            echo ""
            log_info "All pre-push checks passed!"
            log_info "Your changes are ready to push."
            ;;
        *)
            log_error "Unknown check subcommand: $subcommand"
            echo ""
            echo "Usage: ./go check [SUBCOMMAND]"
            echo ""
            echo "Subcommands:"
            echo "  quick         Fast checks (lint, format, types) - ~30s"
            echo "  full          Quality checks + unit tests - ~5min"
            echo "  (default)     Comprehensive validation (quality + build + tests) - ~5min"
            echo ""
            echo "Examples:"
            echo "  ./go check              # Comprehensive validation before push"
            echo "  ./go check quick        # Quick validation during development"
            echo "  ./go check full         # Full validation without build"
            exit 1
            ;;
    esac
}

# Handle build commands with subcommands
handle_build_command() {
    local subcommand="${1:-}"

    ensure_deps

    case "$subcommand" in
        web)
            log_step "Building web application"
            ensure_packages_built
            "$LOCAL_CI_DIR/scripts/build/build-web.sh"
            ;;
        cli)
            log_step "Building CLI application"
            ensure_packages_built
            "$LOCAL_CI_DIR/scripts/build/build-cli.sh"
            ;;
        desktop)
            log_step "Building desktop application"
            ensure_packages_built
            "$LOCAL_CI_DIR/scripts/build/build-desktop.sh"
            ;;
        packages)
            log_step "Building shared packages"
            "$LOCAL_CI_DIR/scripts/setup/build-packages.sh"
            ;;
        "")
            # Default: build everything (existing behavior)
            build
            ;;
        *)
            log_error "Unknown build subcommand: $subcommand"
            echo ""
            echo "Usage: ./go build [SUBCOMMAND]"
            echo ""
            echo "Subcommands:"
            echo "  web           Build web application only"
            echo "  cli           Build CLI application only"
            echo "  desktop       Build desktop application only"
            echo "  packages      Build shared packages only"
            echo "  (default)     Build everything"
            exit 1
            ;;
    esac
}

# =============================================================================
# HELP DOCUMENTATION
# =============================================================================

# Help message
function show_help() {
  echo "Usage: ./go [COMMAND] [OPTIONS]"
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "DEVELOPMENT COMMANDS"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "  dev           Start development server (requires local backend)"
  echo "  sandbox       Start in sandbox mode (for open-source contributors)"
  echo "    --docker    Run in Docker container (recommended)"
  echo "    --port=PORT Set Docker port (default: 8080)"
  echo "    --no-browser Don't open browser automatically"
  echo "  sandbox-docker Quick start with Docker (alias for 'sandbox --docker')"
  echo "  preview       Preview the production build"
  echo "  desktop [cmd] Build and run desktop application (Electron)"
  echo "    dev         Start Electron dev server with HMR"
  echo "    build       Build the Electron application"
  echo "    pack        Package application (unpacked, for testing)"
  echo "    dist        Build installers for all platforms"
  echo "    dist:win    Build Windows installer (NSIS)"
  echo "    dist:mac    Build macOS installer (DMG)"
  echo "    dist:linux  Build Linux installers (AppImage + deb)"
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "BUILD COMMANDS"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "  build [sub]   Build the application"
  echo "    web         Build web application only"
  echo "    cli         Build CLI application only"
  echo "    desktop     Build desktop application only"
  echo "    packages    Build shared packages only"
  echo "    (default)   Build everything"
  echo "  release       Build and create release package in bin/"
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "TEST COMMANDS"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "  test [sub]    Run tests (interactive prompt if no subcommand)"
  echo "    unit        Run unit tests"
  echo "    cli         Run CLI integration tests"
  echo "    e2e [opts]  Run E2E tests (Playwright)"
  echo "    all         Run all tests"
  echo ""
  echo "  E2E Test Options:"
  echo "    --projects chromium firefox webkit msedge"
  echo "    --headed        Show browser window"
  echo "    --debug         Open Playwright inspector"
  echo "    --ui            Interactive UI mode"
  echo "    --slowmo <ms>   Slow down actions"
  echo "    --test <filter> Run specific test file or line"
  echo ""
  echo "  Examples:"
  echo "    ./go test                                 # Interactive prompt"
  echo "    ./go test e2e --projects chromium         # E2E with Chrome"
  echo "    ./go test e2e --headed --slowmo 500       # Slow visual debugging"
  echo "    ./go test e2e --debug --test auth.spec.ts # Debug specific test"
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "QUALITY COMMANDS"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "  quality [sub] Run quality checks"
  echo "    lint        Run ESLint + Knip"
  echo "    format      Check code formatting (Biome)"
  echo "    types       Check TypeScript types"
  echo "    i18n        Check translations"
  echo "    security    Run npm security audit"
  echo "    unused      Check for unused code"
  echo "    version     Check workspace version consistency"
  echo "    all         Run all quality checks (default)"
  echo "  lint          Alias for 'quality lint' (backward compatibility)"
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "FIX COMMANDS"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "  fix [sub]     Auto-fix issues"
  echo "    format      Auto-fix code formatting"
  echo "    lint        Auto-fix linting issues"
  echo "    i18n        Regenerate translation hashes"
  echo "    unused      Auto-fix unused code"
  echo "    imports     Organize imports"
  echo "    version     Fix version mismatches"
  echo "    all         Auto-fix everything (default)"
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "PRE-PUSH VALIDATION"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "  check [sub]   Run pre-push validation"
  echo "    quick       Fast checks (lint, format, types) - ~30s"
  echo "    full        Quality checks + unit tests - ~5min"
  echo "    (default)   Comprehensive validation - ~5min"
  echo ""
  echo "  Workflow:"
  echo "    1. Make changes"
  echo "    2. ./go fix              # Auto-fix common issues"
  echo "    3. ./go check            # Comprehensive validation"
  echo "    4. git push              # Push with confidence"
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "MAINTENANCE COMMANDS"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "  clean         Clean build artifacts"
  echo "    --docker    Also clean Docker containers/images"
  echo "  setup [mode]  Setup development environment"
  echo "    sandbox     Setup for sandbox development (no backend)"
  echo "    (default)   Setup for local development (requires backend)"
  echo "  status        Check application status"
  echo "  help          Show this help message"
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "QUICK START"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "ğŸš€ Open-Source Contributors (No Backend Needed):"
  echo "  ./go sandbox --docker       # Fastest - run in Docker"
  echo "  ./go sandbox                # Run locally with npm"
  echo ""
  echo "ğŸ”§ Local Development (With Backend):"
  echo "  ./go setup                  # Setup environment"
  echo "  ./go dev                    # Start development server"
  echo ""
  echo "âœ… Before Pushing Changes:"
  echo "  ./go fix                    # Auto-fix common issues"
  echo "  ./go check                  # Validate everything"
  echo ""
}

# =============================================================================
# MAIN DISPATCHER
# =============================================================================

# Main function to handle commands
main() {
    case "$1" in
      # Development commands (existing)
      sandbox)
        shift
        sandbox "$@"
        ;;
      sandbox-docker)
        shift
        sandbox --docker "$@"
        ;;
      dev)
        dev
        ;;
      preview)
        preview
        ;;
      desktop)
        shift
        desktop "$@"
        ;;

      # Build commands (enhanced with subcommands)
      build)
        shift
        handle_build_command "$@"
        ;;
      release)
        release
        ;;

      # NEW: Test commands
      test)
        shift
        handle_test_command "$@"
        ;;

      # NEW: Quality commands
      quality)
        shift
        handle_quality_command "$@"
        ;;
      lint)
        # Backward compatibility: ./go lint â†’ ./go quality lint
        handle_quality_command lint
        ;;

      # NEW: Fix commands
      fix)
        shift
        handle_fix_command "$@"
        ;;

      # NEW: Check commands
      check)
        shift
        handle_check_command "$@"
        ;;

      # Maintenance commands (existing)
      clean)
        shift
        clean "$@"
        ;;
      setup)
        shift
        setup "$@"
        ;;
      status)
        status
        ;;
      help|--help|-h)
        show_help
        ;;
      "")
        show_help
        ;;
      *)
        log_error "Unknown command: $1"
        echo ""
        show_help
        exit 1
        ;;
    esac
}

# Execute main function if run directly
[[ "${BASH_SOURCE[0]}" == "${0}" ]] && main "$@"
